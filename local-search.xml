<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>é‡å­¦å®¹å™¨04: containerdçš„é«˜é˜¶å‘½ä»¤è¡Œå·¥å…·nerdctl</title>
    <link href="/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A804-containerd%E7%9A%84%E9%AB%98%E9%98%B6%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7nerdctl/"/>
    <url>/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A804-containerd%E7%9A%84%E9%AB%98%E9%98%B6%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7nerdctl/</url>
    
    <content type="html"><![CDATA[<p>å¯¹äºç”¨æƒ¯äº†docker cliçš„ç”¨æˆ·æ¥è¯´ï¼Œcontainerdçš„å‘½ä»¤è¡Œå·¥å…·cträ½¿ç”¨èµ·æ¥ä¸æ˜¯å¾ˆé¡ºæ‰‹ï¼Œæ­¤æ—¶åˆ«æ…Œï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·é¡¹ç›®nerdctlå¯ä¾›æˆ‘ä»¬é€‰æ‹©ã€‚ nerdctlæ˜¯ä¸€ä¸ªä¸docker clié£æ ¼å…¼å®¹çš„containerdçš„cliå·¥å…·ã€‚ nerdctlå·²ç»ä½œä¸ºå­é¡¹ç›®åŠ å…¥äº†containerdé¡¹ç›®ï¼Œå®ƒçš„githubåœ°å€æ˜¯<a href="https://github.com/containerd/nerdctl%EF%BC%8C%E8%80%8C%E4%B8%94%E4%BB%8E%E6%9C%80%E8%BF%91%E7%9A%84nerdctl">https://github.com/containerd/nerdctlï¼Œè€Œä¸”ä»æœ€è¿‘çš„nerdctl</a> 0.8å¼€å§‹ï¼Œnerdctlç›´æ¥å…¼å®¹äº†docker composeçš„è¯­æ³•(ä¸åŒ…å«swarm)ï¼Œ è¿™å¾ˆå¤§æé«˜äº†ç›´æ¥å°†containerdä½œä¸ºæœ¬åœ°å¼€å‘ã€æµ‹è¯•å’Œå•æœºå®¹å™¨éƒ¨ç½²ä½¿ç”¨çš„ä½“éªŒã€‚æœ¬æ¥k8såç»­å°†ä¸å†æ”¯æŒdockershimï¼Œdockeråœ¨k8sç¤¾åŒºçš„åœ°ä½æ€¥å‰§ä¸‹é™ï¼Œç°åœ¨å•æœºç›´æ¥ä½¿ç”¨containerdæ˜“ç”¨æ€§ä¹Ÿä¸æ–­è¢«å®Œå–„ï¼Œä¹Ÿè®¸dockerçš„è¾‰ç…Œå·²ç»è¿œå»äº†ã€‚</p><p>å®é™…ä¸Šnerdctl composeå®ç°çš„æ˜¯Compose Specificationè§„èŒƒï¼Œ è¿™ä¸ªè§„èŒƒæ˜¯ä»è‡ªDocker Compose file version 3 specificationè§„èŒƒå‘å±•è€Œæ¥çš„ã€‚</p><p>1.å®‰è£…nerdctl<br>containerd 1.5æœ€è¿‘åˆšåˆšå‘å¸ƒï¼Œè¿™é‡Œå…ˆæŠŠæµ‹è¯•æœºä¸Šçš„containerdå‡çº§åˆ°1.5ï¼Œç›´æ¥æ›¿æ¢containerdçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé‡å¯containerdçš„systemdæœåŠ¡å³å¯ï¼Œå‡çº§è¿‡ç¨‹ç•¥è¿‡ã€‚ å‡çº§å®ŒæˆåæŸ¥çœ‹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç‰ˆæœ¬å‡å·²ç»æ˜¯1.5.0:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">ctr version<br>Client:<br>  Version:  v1.5.0<br>  Revision: 8c906ff108ac28da23f69cc7b74f8e7a470d1df0<br>  Go version: go1.16.3<br><br>Server:<br>  Version:  v1.5.0<br>  Revision: 8c906ff108ac28da23f69cc7b74f8e7a470d1df0<br>  UUID: dee82270-b4b4-429c-befa-45df1421da7e<br></code></pre></td></tr></table></figure><p>æ³¨æ„åœ¨å®‰è£…nerdctlä¹‹å‰ï¼Œéœ€è¦ç¡®è®¤å®‰è£…äº†å®ƒçš„ä¾èµ–ç»„ä»¶(runcã€containerdã€cni)ï¼Œcontainerdå’Œcniçš„è¯¦ç»†å®‰è£…æ­¥éª¤å¯ä»¥å‚è€ƒæœ¬ç³»åˆ—æ–‡ç« ç¬¬2èŠ‚å’Œç¬¬3èŠ‚ä¸­çš„å†…å®¹ã€‚</p><p>å®‰è£…nerdctl:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://github.com/containerd/nerdctl/releases/download/v0.8.1/nerdctl-0.8.1-linux-amd64.tar.gz<br>tar -zxvf nerdctl-0.8.1-linux-amd64.tar.gz nerdctl &amp;&amp; mv nerdctl /usr/local/containerd/bin/<br>ln -s /usr/local/containerd/bin/nerdctl /usr/local/bin/nerdctl<br></code></pre></td></tr></table></figure><p>æ‰“å°ä¸€ä¸‹ç‰ˆæœ¬ä¿¡æ¯:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">nerdctl version<br>Client:<br> Version:       v0.8.1<br> Git commit:    e1601447477c38ceb46c9c88418af399f79b1d6a<br><br>Server:<br> containerd:<br>  Version:      v1.5.0<br>  Revision:     8c906ff108ac28da23f69cc7b74f8e7a470d1df0<br></code></pre></td></tr></table></figure><p>2.nerdctlåˆä½“éªŒ<br>æŸ¥çœ‹é•œåƒ:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">nerdctl images<br>REPOSITORY    TAG           IMAGE ID        CREATED        SIZE<br>redis         alpine3.13    f9577ac6e68c    11 days ago    10.4 MiB<br></code></pre></td></tr></table></figure><p>å¯åŠ¨ä¸€ä¸ªrediså®¹å™¨:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">nerdctl run -d --name redis redis:alpine3.13<br><br>nerdctl ps<br>CONTAINER ID    IMAGE                                 COMMAND                   CREATED           STATUS    PORTS    NAMES<br>709665b06ab1    docker.io/library/redis:alpine3.13    &quot;docker-entrypoint.sâ€¦&quot;    28 seconds ago    Up                 redis<br></code></pre></td></tr></table></figure><p>è¿›å…¥å®¹å™¨å†…éƒ¨:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">nerdctl exec -it redis sh<br>/data # ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host<br>       valid_lft forever preferred_lft forever<br>3: eth0@if19: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP<br>    link/ether 1a:84:4b:bb:1f:43 brd ff:ff:ff:ff:ff:ff<br>    inet 10.4.0.4/24 brd 10.4.0.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::1884:4bff:febb:1f43/64 scope link tentative dadfailed<br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å®¿ä¸»æœºä¸Šçš„ç½‘æ¡¥å’Œvethå¯¹è®¾å¤‡:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">ls /var/lib/cni/networks/bridge/<br>10.4.0.4  last_reserved_ip.0  lock<br><br>ip addr<br>......<br>16: nerdctl0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP qlen 1000<br>    link/ether 3e:92:4a:37:cb:d3 brd ff:ff:ff:ff:ff:ff<br>    inet 10.4.0.1/24 brd 10.4.0.255 scope global nerdctl0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::3c92:4aff:fe37:cbd3/64 scope link<br>       valid_lft forever preferred_lft forever<br>19: veth98611773@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master nerdctl0 state UP<br>    link/ether 2eğŸ’¿71:38:3d:7b brd ff:ff:ff:ff:ff:ff link-netnsid 0<br>    inet6 fe80::2ccd:71ff:fe38:3d7b/64 scope link<br>       valid_lft forever preferred_lft forever<br><br></code></pre></td></tr></table></figure><p>å’Œdockerä¸€æ ·ï¼Œnerdctlä¹Ÿæœ‰ä¸€ä¸ªå­å‘½ä»¤network:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">nerdctl network ls<br>NETWORK ID    NAME         FILE<br>0             bridge<br>              host<br>              none<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹ä¸€ä¸‹é»˜è®¤çš„bridgeç½‘ç»œçš„cnié…ç½®:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs shell">[<br>    &#123;<br>        &quot;CNI&quot;: &#123;<br>            &quot;cniVersion&quot;: &quot;0.4.0&quot;,<br>            &quot;name&quot;: &quot;bridge&quot;,<br>            &quot;nerdctlID&quot;: 0,<br>            &quot;plugins&quot;: [<br>                &#123;<br>                    &quot;type&quot;: &quot;bridge&quot;,<br>                    &quot;bridge&quot;: &quot;nerdctl0&quot;,<br>                    &quot;isGateway&quot;: true,<br>                    &quot;ipMasq&quot;: true,<br>                    &quot;hairpinMode&quot;: true,<br>                    &quot;ipam&quot;: &#123;<br>                        &quot;type&quot;: &quot;host-local&quot;,<br>                        &quot;routes&quot;: [<br>                            &#123;<br>                                &quot;dst&quot;: &quot;0.0.0.0/0&quot;<br>                            &#125;<br>                        ],<br>                        &quot;ranges&quot;: [<br>                            [<br>                                &#123;<br>                                    &quot;subnet&quot;: &quot;10.4.0.0/24&quot;,<br>                                    &quot;gateway&quot;: &quot;10.4.0.1&quot;<br>                                &#125;<br>                            ]<br>                        ]<br>                    &#125;<br>                &#125;,<br>                &#123;<br>                    &quot;type&quot;: &quot;portmap&quot;,<br>                    &quot;capabilities&quot;: &#123;<br>                        &quot;portMappings&quot;: true<br>                    &#125;<br>                &#125;,<br>                &#123;<br>                    &quot;type&quot;: &quot;firewall&quot;<br>                &#125;,<br>                &#123;<br>                    &quot;type&quot;: &quot;tuning&quot;<br>                &#125;<br>            ]<br>        &#125;,<br>        &quot;NerdctlID&quot;: 0<br>    &#125;<br>]<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºnertctlå¯åŠ¨çš„å®¹å™¨çš„ç½‘ç»œçš„èƒŒåå®é™…ä¸Šä»ç„¶æ˜¯CNIåœ¨å·¥ä½œã€‚ nerctl runå‘½ä»¤åœ¨å¯åŠ¨ä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå¯ä»¥é€šè¿‡â€“netæŒ‡å®šå®¹å™¨è¿æ¥åˆ°ä¸€ä¸ªç½‘ç»œï¼Œå–å€¼å¯ä»¥æ˜¯bridgeã€hostã€æˆ–noneï¼Œé»˜è®¤æ˜¯bridgeã€‚æ‰€ä»¥å®¿ä¸»æœºä¸Šå‡ºç°äº†nerdctl0ç½‘æ¡¥å’Œeth98611773@if3ã€‚</p><p>3.nerdctlå…¼å®¹docker compose<br>è¿™é‡Œç¼–å†™ä¸€ä¸ªç”¨äºæµ‹è¯•çš„docker-compose.ymlæ–‡ä»¶:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs shell">version: &#x27;3&#x27;<br>services:<br>  db:<br>    image: postgres:10.1<br>    environment:<br>      - POSTGRES_USER=miniflux<br>      - POSTGRES_PASSWORD=secret<br>    volumes:<br>      - /home/miniflux/miniflux-db:/var/lib/postgresql/data<br>  db-migrate:<br>    image: miniflux/miniflux:2.0.29<br>    command: [&quot;/usr/bin/miniflux&quot;, &quot;-migrate&quot;]<br>    depends_on:<br>      - db<br>    environment:<br>      - DATABASE_URL=postgres://miniflux:secret@db/miniflux?sslmode=disable<br>  miniflux:<br>    image: miniflux/miniflux:2.0.29<br>    ports:<br>      - &quot;8080:8080&quot;<br>    depends_on:<br>      - db-migrate<br>    environment:<br>      - DATABASE_URL=postgres://miniflux:secret@db/miniflux?sslmode=disable<br>```  <br><br>minifluxæ˜¯ä¸€ä¸ªå¼€æºçš„RSSé˜…è¯»å™¨ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªæœåŠ¡ç»„æˆminiflux webæœåŠ¡å’Œpostgresæ•°æ®åº“ï¼Œå¯ä»¥éƒ¨ç½²Minifluxä½œä¸ºæˆ‘ä»¬è‡ªå·±çš„RSSæœåŠ¡ã€‚ ä¸Šé¢çš„docker composeæ–‡ä»¶ä¹‹å‰å·²ç»ä½¿ç”¨docker-composeåœ¨dockerä¸Šéƒ¨ç½²è¿‡ï¼Œè¿™é‡Œæˆ‘ä»¬å®éªŒä¸€ä¸‹nerdctlåœ¨containerdä¸Šéƒ¨ç½²ã€‚<br><br>åœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºæŒ‚è½½å‡ºæ¥çš„æ•°æ®ç›®å½•:<br><br>```shell<br>cd /home<br>mkdir miniflux<br>cd miniflux<br>mkdir miniflux-db<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨nerdctlæ‰§è¡Œcomposeå‘½ä»¤:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">nerdctl compose -f docker-compose.yml up -d<br>INFO[0000] Creating network miniflux_default<br>INFO[0000] Ensuring image postgres:10.1<br>INFO[0000] Ensuring image miniflux/miniflux:latest<br>INFO[0000] Creating container miniflux_miniflux_1<br>INFO[0000] Creating container miniflux_db_1<br><br>nerdctl ps -a<br>CONTAINER ID    IMAGE                                 COMMAND                   CREATED          STATUS                      PORTS                     NAMES<br>219d71b12daa    docker.io/miniflux/miniflux:2.0.29    &quot;/usr/bin/miniflux&quot;       6 minutes ago    Up                          0.0.0.0:8080-&gt;8080/tcp    miniflux_miniflux_1<br>3b5275fdb361    docker.io/miniflux/miniflux:2.0.29    &quot;/usr/bin/miniflux -â€¦&quot;    6 minutes ago    Exited (1) 6 minutes ago                              miniflux_db-migrate_1<br>540239bdd876    docker.io/library/postgres:10.1       &quot;docker-entrypoint.sâ€¦&quot;    6 minutes ago    Up                                                    miniflux_db_1<br></code></pre></td></tr></table></figure><p>æ³¨:å®é™…ä½¿ç”¨nerdctl composeå¯åŠ¨å®¹å™¨æ—¶ï¼Œå› ä¸ºpostgreså¯åŠ¨æ¯”è¾ƒæ…¢ï¼Œè€Œcomposeé‡Œçš„depends_onåªæ˜¯æè¿°containerå¯åŠ¨åå°±è®¤ä¸ºä¾èµ–OKäº†ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°miniflux_db-migrate_1å’Œminiflux_miniflux_1æ— æ³•å¯åŠ¨çš„æƒ…å†µã€‚ æ­¤æ—¶ï¼Œæ‰‹åŠ¨æŒ‰é¡ºåºæ‰§è¡Œnerdctl start miniflux_db-migrate_1 &amp;&amp; nerdctl logs miniflux_db-migrate_1å’Œnerdctl start miniflux_miniflux_1 &amp;&amp; nerdctl logs miniflux_miniflux_1æœ€ç»ˆç¡®ä¿miniflux_miniflux_1å’Œminiflux_db_1éƒ½è¿›å…¥upçŠ¶æ€å³å¯ã€‚</p><p>åˆ›å»ºadminç”¨æˆ·:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">nerdctl exec -it &lt;container-name&gt; /usr/bin/miniflux -create-admin<br>Enter Username: admin<br>Enter Password:<br></code></pre></td></tr></table></figure><p>éƒ¨ç½²æˆåŠŸåå¯ä»¥ä½¿ç”¨<a href="http://ip:8080è®¿é—®ã€‚">http://ip:8080è®¿é—®ã€‚</a></p><p>æ€»ç»“<br>å¯ä»¥çœ‹å‡ºnerdctlçš„ä½¿ç”¨æ–¹å¼å’Œdocker cliå‡ ä¹ä¸€è‡´ï¼Œåœ¨å¯åŠ¨å®¹å™¨å’Œç®¡ç†å®¹å™¨æ–¹é¢ï¼Œä»dockerè¿‡æ¸¡åˆ°ä½¿ç”¨nerdctl+containerdå‡ ä¹æ²¡æœ‰ä»»ä½•å­¦ä¹ æˆæœ¬ã€‚ æœ‰äº†nerdctlï¼Œå•æœºç©è€containerdä¸å†æ˜¯æ¢¦ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>containerd</category>
      
    </categories>
    
    
    <tags>
      
      <tag>containerd</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é‡å­¦å®¹å™¨02: éƒ¨ç½²å®¹å™¨è¿è¡Œæ—¶Containerd</title>
    <link href="/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A802-%E9%83%A8%E7%BD%B2%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6Containerd/"/>
    <url>/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A802-%E9%83%A8%E7%BD%B2%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6Containerd/</url>
    
    <content type="html"><![CDATA[<p>1.Containerdå¯åŠ¨å®¹å™¨æ¶‰åŠçš„æ¨¡å—<br>å‰é¢æˆ‘ä»¬æ¢³ç†äº†dockerã€k8sã€containerdã€runcä¹‹é—´çš„æ¸Šæºï¼ŒContainerdæ—©å·²è„±ç¦»Dockeræˆä¸ºäº†ä¸€ä¸ªç¨³å®šå¯é çš„å®¹å™¨è¿è¡Œæ—¶ã€‚</p><p>å•ä»containerdçš„è§’åº¦æ¥çœ‹å¯åŠ¨ä¸€ä¸ªå®¹å™¨çš„è¿‡ç¨‹å¤§è‡´æ˜¯ä¸‹å›¾æ‰€ç¤ºçš„æµç¨‹:</p><p><img src="/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A802-%E9%83%A8%E7%BD%B2%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6Containerd/containerd-run-container-1.png"></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Containerdçš„å‘½ä»¤è¡Œå·¥å…·ctræ¥å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œä¹Ÿå¯ä»¥åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­ç¼–å†™å®¢æˆ·ç«¯ç¨‹åºä¸ºæˆ‘ä»¬çš„åº”ç”¨åŠ å…¥å¯åŠ¨å®¹å™¨çš„åŠŸèƒ½ã€‚</p><p>ä»containerdä½œä¸ºk8sçš„å®¹å™¨è¿è¡Œæ—¶æ¥çœ‹ï¼Œå¯åŠ¨ä¸€ä¸ªå®¹å™¨çš„è¿‡ç¨‹å¤§è‡´æ˜¯ä¸‹å›¾æ‰€ç¤ºæµç¨‹:</p><p><img src="/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A802-%E9%83%A8%E7%BD%B2%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6Containerd/containerd-run-container-2.png"></p><p>containerdå®ç°äº†k8sçš„CRIæ¥å£ï¼Œæä¾›å®¹å™¨è¿è¡Œæ—¶æ ¸å¿ƒåŠŸèƒ½ï¼Œå¦‚é•œåƒç®¡ç†ã€å®¹å™¨ç®¡ç†ç­‰ï¼Œå½“å‰containerdå®ç°CRIæ¥å£çš„ä»£ç ä½äºcontainerdä»£ç çš„pkg&#x2F;criåŒ…ä¸‹ã€‚ ä¹Ÿå°±æ˜¯è¯´containerdåŒæ ·æ˜¯ä¸€ä¸ªk8s CRIçš„å®ç°ï¼Œå¯ä»¥ä½¿ç”¨k8sæä¾›çš„cri-toolsä¸­çš„crictlå‘½ä»¤è¡Œå·¥å…·ä¸containerdçš„CRIå®ç°äº¤äº’ã€‚</p><p>ç†è§£äº†ä¸Šé¢è¿™ä¸¤å¹…å›¾ä¸­å„ä¸ªç»„ä»¶ä¹‹é—´çš„äº¤äº’å…³ç³»ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥éƒ¨ç½²containerdç›¸å…³ç»„ä»¶ã€‚</p><p>2.äºŒè¿›åˆ¶éƒ¨ç½²containerd<br>è¿™é‡Œä»¥CentOS 7ä¸ºä¾‹ï¼Œæ¼”ç¤ºéƒ¨ç½²containerdçš„è¿‡ç¨‹ï¼Œéœ€è¦ç¦ç”¨selinuxã€‚</p><p>è¦éƒ¨ç½²containerdï¼Œéœ€è¦ä¸‹è½½3ä¸ªåŒ…:</p><p>æœ¬æ–‡å®éªŒä¸­ä½¿ç”¨çš„å¯¹åº”ç‰ˆæœ¬æ˜¯:<br>runc 1.1.7<br>containerd 1.7.1<br>cri-tools v1.27.0</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://github.com/opencontainers/runc/releases/download/v1.1.7/runc.amd64<br>wget https://github.com/containerd/containerd/releases/download/v1.7.1/containerd-1.7.1-linux-amd64.tar.gz<br>wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.27.0/crictl-v1.27.0-linux-amd64.tar.gz<br></code></pre></td></tr></table></figure><p>runc.amd64æ˜¯runcçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ<br>containerd-1.7.1-linux-amd64.tar.gz åŒ…å«containerdå’Œå®ƒçš„containerd-shimä»¥åŠå‘½ä»¤è¡Œå·¥å…·ctrï¼Œ<br>crictl-v1.27.0-linux-amd64.tar.gz åŒ…å«CRIçš„å‘½ä»¤è¡Œå·¥å…·crictlã€‚</p><p>ä¸‹ä¸€æ­¥è¿›è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„è§£å‹å’Œå®‰è£…:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir /usr/local/containerd<br>mkdir /etc/containerd<br><br>mv runc.amd64 /usr/local/containerd/bin/runc<br>tar -zxvf containerd-1.7.1-linux-amd64.tar.gz -C /usr/local/containerd<br>tar -zxvf crictl-v1.27.0-linux-amd64.tar.gz -C /usr/local/containerd/bin<br><br>ln -s /usr/local/containerd/bin/containerd /usr/local/bin/containerd<br>ln -s /usr/local/containerd/bin/ctr /usr/local/bin/ctr<br>ln -s /usr/local/containerd/bin/runc /usr/local/bin/runc<br>ln -s /usr/local/containerd/bin/crictl /usr/local/bin/crictl<br></code></pre></td></tr></table></figure><p>å®‰è£…çš„ç›®å½•æ¥å£å¦‚ä¸‹:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">tree /usr/local/containerd/<br>/usr/local/containerd/<br>â””â”€â”€ bin<br>    â”œâ”€â”€ containerd<br>    â”œâ”€â”€ containerd-shim<br>    â”œâ”€â”€ containerd-shim-runc-v1<br>    â”œâ”€â”€ containerd-shim-runc-v2<br>    â”œâ”€â”€ crictl<br>    â”œâ”€â”€ ctr<br>    â””â”€â”€ runc<br><br></code></pre></td></tr></table></figure><p>ä¸‹ä¸€æ­¥ç”Ÿæˆcontainerdçš„é»˜è®¤é…ç½®æ–‡ä»¶&#x2F;etc&#x2F;containerd&#x2F;config.toml:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">containerd config default &gt; /etc/containerd/config.toml<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸€ä¸‹é…ç½®æ–‡ä»¶(ç¯‡å¹…æœ‰é™è¿™é‡Œæ²¡æœ‰ç»™å‡ºå…¨éƒ¨å†…å®¹):</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">version = 2<br>root = &quot;/var/lib/containerd&quot;<br>state = &quot;/run/containerd&quot;<br>plugin_dir = &quot;&quot;<br>disabled_plugins = []<br>required_plugins = []<br>oom_score = 0<br><br>[grpc]<br>  address = &quot;/run/containerd/containerd.sock&quot;<br>  tcp_address = &quot;&quot;<br>  tcp_tls_cert = &quot;&quot;<br>  tcp_tls_key = &quot;&quot;<br>  uid = 0<br>  gid = 0<br>  ......<br><br></code></pre></td></tr></table></figure><p>åˆ›å»ºcontainerdè¿›ç¨‹çš„systemdæœåŠ¡é…ç½®containerd.serviceï¼Œcontainerdæºç çš„æ ¹ç›®å½•ä¸­ä¹Ÿç»™å‡ºäº†containerd.serviceè¿™ä¸ªæ–‡ä»¶çš„ç¤ºä¾‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &lt;&lt;EOF | tee /etc/systemd/system/containerd.service<br>[Unit]<br>Description=containerd container runtime<br>Documentation=&lt;https://containerd.io&gt;<br>After=network.target local-fs.target<br><br>[Service]<br>ExecStartPre=-/sbin/modprobe overlay<br>ExecStart=/usr/local/bin/containerd<br><br>Type=notify<br>Delegate=yes<br>KillMode=process<br>Restart=always<br>RestartSec=5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-keyword">in</span> the kernel. We recommend using cgroups to <span class="hljs-keyword">do</span> container-local accounting</span><br><br>LimitNPROC=infinity<br>LimitCORE=infinity<br>LimitNOFILE=1048576<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Comment TasksMax <span class="hljs-keyword">if</span> your systemd version does not supports it</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Only systemd 226 and above support this version</span><br><br>TasksMax=infinity<br>OOMScoreAdjust=-999<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><p>å¯åŠ¨containerd:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl start containerd<br>systemctl status containerd<br>systemctl enable containerd<br></code></pre></td></tr></table></figure><p>3.ctrå‘½ä»¤è¡Œå·¥å…·åˆå§‹ç”¨<br>æ‰“å°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç‰ˆæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">ctr version<br>Client:<br>  Version:  1.6.21<br>  Revision: 3dce8eb055cbb6872793272b4f20ed16117344f8<br>  Go version: go1.19.9<br><br>Server:<br>  Version:  1.6.21<br>  Revision: 3dce8eb055cbb6872793272b4f20ed16117344f8<br>  UUID: 9f47aa42-edea-42fd-803c-60dec8ac6fa1<br><br></code></pre></td></tr></table></figure><p>pull docker hubä¸­çš„redisé•œåƒ:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">pullé•œåƒ</span><br><br>ctr images pull docker.io/library/redis:alpine3.13<br>docker.io/library/redis:alpine3.13:                                               resolved       |++++++++++++++++++++++++++++++++++++++|<br>index-sha256:6833ca04ec87a2222928157125dffcca22c68e2db304164cc050ee9cc6b05b4e:    exists         |++++++++++++++++++++++++++++++++++++++|<br>manifest-sha256:b7cb70118c9729f8dc019187a4411980418a87e6a837f4846e87130df379e2c8: exists         |++++++++++++++++++++++++++++++++++++++|<br>config-sha256:1690b63e207f6651429bebd716ace700be29d0110a0cfefff5038bb2a7fb6fc7:   exists         |++++++++++++++++++++++++++++++++++++++|<br>layer-sha256:6ab1d05b49730290d3c287ccd34640610423d198e84552a4c2a4e98a46680cfd:    exists         |++++++++++++++++++++++++++++++++++++++|<br>layer-sha256:8173c12df40f1578a7b2dfbbc0034a4fbc8ec7c870fd32b9236c2e5e1936616a:    exists         |++++++++++++++++++++++++++++++++++++++|<br>layer-sha256:8cc52074f78e0a2fd174bdd470029cf287b7366bf1b8d3c1f92e2aa8789b92ae:    exists         |++++++++++++++++++++++++++++++++++++++|<br>layer-sha256:aa7854465cce07929842cb49fc92f659de8a559cf521fc7ea8e1b781606b85cd:    exists         |++++++++++++++++++++++++++++++++++++++|<br>layer-sha256:29712d301e8c43bcd4a36da8a8297d5ff7f68c3d4c3f7113244ff03675fa5e9c:    exists         |++++++++++++++++++++++++++++++++++++++|<br>layer-sha256:540db60ca9383eac9e418f78490994d0af424aab7bf6d0e47ac8ed4e2e9bcbba:    exists         |++++++++++++++++++++++++++++++++++++++|<br>elapsed: 2.6 s                                                                    total:   0.0 B (0.0 B/s)<br>unpacking linux/amd64 sha256:6833ca04ec87a2222928157125dffcca22c68e2db304164cc050ee9cc6b05b4e...<br>done: 38.775633ms<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹é•œåƒ</span><br><br>ctr i ls<br></code></pre></td></tr></table></figure><p>pullç§æœ‰ä»“åº“çš„é•œåƒï¼Œéœ€è¦ä½¿ç”¨-u <username>:<password>ç»™å®šé•œåƒä»“åº“çš„ç”¨æˆ·åå’Œå¯†ç :</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ctr images pull -u user:password harbor.my.org/library/nginx:1.1<br></code></pre></td></tr></table></figure><p>å¯åŠ¨è¿™ä¸ªæµ‹è¯•çš„rediså®¹å™¨:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ctr run -d docker.io/library/redis:alpine3.13 redis<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å®¹å™¨(containerå’Œtask):</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">ctr container ls<br>CONTAINER    IMAGE                                 RUNTIME<br>redis        docker.io/library/redis:alpine3.13    io.containerd.runc.v2<br><br>ctr task ls<br>TASK     PID      STATUS<br>redis    20808    RUNNING<br></code></pre></td></tr></table></figure><p>æ³¨æ„: åœ¨containerdä¸­ï¼Œcontainerå’Œtaskæ˜¯åˆ†ç¦»çš„ï¼Œcontaineræè¿°çš„æ˜¯å®¹å™¨åˆ†é…å’Œé™„åŠ èµ„æºçš„å…ƒæ•°æ®å¯¹è±¡ï¼Œæ˜¯é™æ€å†…å®¹ï¼Œtaskæ˜¯ä»»åŠ¡æ˜¯ç³»ç»Ÿä¸Šä¸€ä¸ªæ´»åŠ¨çš„ã€æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚ taskåº”è¯¥åœ¨æ¯æ¬¡è¿è¡Œååˆ é™¤ï¼Œè€Œcontainerå¯ä»¥è¢«å¤šæ¬¡ä½¿ç”¨ã€æ›´æ–°å’ŒæŸ¥è¯¢ã€‚è¿™ç‚¹å’Œdockerä¸­containerå®šä¹‰æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>è¿›å…¥åˆ°å®¹å™¨ä¸­æ‰§è¡Œrediså‘½ä»¤:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">ctr task exec -t --exec-id redis-sh redis sh<br>/data # redis-cli<br>127.0.0.1:6379&gt; set k1 v1<br>OK<br>127.0.0.1:6379&gt; get k1<br>&quot;v1&quot;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸€ä¸‹ç³»ç»Ÿä¸­çš„è¿›ç¨‹ä¿¡æ¯:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ps -ef | grep runc | grep redis<br>/usr/local/containerd/bin/containerd-shim-runc-v2 -namespace default -id redis -address /run/containerd/containerd.sock<br><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºcontainerdä¸­æ˜¯å­˜åœ¨namespaceæ¦‚å¿µçš„ï¼Œè¿™æ ·å¯ä»¥å°†ä¸åŒä¸šåŠ¡å’Œåº”ç”¨è¿›è¡Œéš”ç¦»ï¼Œä¾‹å¦‚k8sä½¿ç”¨containerdå’Œç›´æ¥ä½¿ç”¨ctråˆ›å»ºçš„å®¹å™¨å¯ä»¥éš”ç¦»å¼€ã€‚æŸ¥çœ‹ä¸€ä¸‹å½“å‰çš„namespace:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">ctr ns ls<br>NAME     LABELS<br>buildkit<br>default<br><br></code></pre></td></tr></table></figure><p>ä¸åŒnamespaceä¸‹pullçš„é•œåƒä¹Ÿæ˜¯éš”ç¦»æ˜¾ç¤ºçš„ï¼Œå¯ä»¥ä½¿ç”¨-næŒ‡å®šå…·ä½“çš„namespaceï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ctr -n default i ls<br></code></pre></td></tr></table></figure><p>4.crictlå‘½ä»¤è¡Œå·¥å…·é…ç½®å’Œåˆå§‹ç”¨<br>crictlæ˜¯k8s cri-toolsçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ç±»ä¼¼äºdockerçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸éœ€è¦kubeletå°±å¯ä»¥é€šè¿‡CRIè·Ÿå®¹å™¨è¿è¡Œæ—¶é€šä¿¡ã€‚ crictlæ˜¯ä¸“é—¨ä¸ºk8sè®¾è®¡çš„ï¼Œæä¾›äº†Podã€å®¹å™¨å’Œé•œåƒç­‰èµ„æºçš„ç®¡ç†å‘½ä»¤ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·è°ƒè¯•å®¹å™¨åº”ç”¨æˆ–è€…æ’æŸ¥å¼‚å¸¸é—®é¢˜ã€‚ crictl å¯ä»¥ç”¨äºæ‰€æœ‰å®ç°äº†CRIæ¥å£çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œ</p><p>å°è¯•ä½¿ç”¨ctictlå‘½ä»¤è¡Œå·¥å…·æŸ¥çœ‹ä¸€ä¸‹é•œåƒï¼Œç»™äº†ä¸€ä¸ªè­¦å‘Šä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">crictl images<br>WARN[0000] image connect using default endpoints: [unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock]. As the default settings are now deprecated, you should set the endpoint instead.<br>ERRO[0002] connect endpoint &#x27;unix:///var/run/dockershim.sock&#x27;, make sure you are running as root and the endpoint has been started: context deadline exceeded<br>IMAGE               TAG                 IMAGE ID            SIZE<br></code></pre></td></tr></table></figure><p>éœ€è¦æˆ‘ä»¬æ˜¾ç¤ºé…ç½®é»˜è®¤çš„endpoints:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">crictl config runtime-endpoint unix:///run/containerd/containerd.sock<br>crictl config image-endpoint unix:///run/containerd/containerd.sock<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‘½ä»¤æ‰§è¡Œå®Œæˆåå°†ç”Ÿæˆé…ç½®æ–‡ä»¶&#x2F;etc&#x2F;crictl.yaml:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat /etc/crictl.yaml<br>runtime-endpoint: &quot;unix:///run/containerd/containerd.sock&quot;<br>image-endpoint: &quot;unix:///run/containerd/containerd.sock&quot;<br>timeout: 0<br>debug: false<br>pull-image-on-create: false<br>disable-pull-on-run: false<br></code></pre></td></tr></table></figure><p>pullé•œåƒ:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">crictl pull docker.io/library/redis:alpine3.13<br>FATA[0000] validate service connection: validate CRI v1 image API for endpoint &quot;unix:///run/containerd/containerd.sock&quot;: rpc error: code = Unimplemented desc = unknown service runtime.v1.ImageService<br><span class="hljs-meta prompt_"># </span><span class="language-bash">æœ‰å¦‚ä¸ŠæŠ¥é”™çš„:</span><br>cat &gt; /etc/containerd/config.toml &lt;&lt;EOF<br>[plugins.&quot;io.containerd.grpc.v1.cri&quot;]<br>  systemd_cgroup = true<br>EOF<br>systemctl restart containerd<br><br>crictl pull docker.io/library/redis:alpine3.13<br>Image is up to date for sha256:1690b63e207f6651429bebd716ace700be29d0110a0cfefff5038bb2a7fb6fc7<br><br>crictl images<br>IMAGE                     TAG                 IMAGE ID            SIZE<br>docker.io/library/redis   alpine3.13          1690b63e207f6       10.9MB<br><br></code></pre></td></tr></table></figure><p>crictl pullçš„é•œåƒå®é™…ä¸Šæ˜¯åœ¨k8s.io namespaceä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ctr -n k8s.io i lsæŸ¥çœ‹ã€‚</p><p>crictlä¸èƒ½åƒctré‚£æ ·é€šè¿‡å‚æ•°ç»™å®šç”¨æˆ·åå’Œå¯†ç çš„æ–¹å¼ä»å¼€å¯è®¤è¯çš„ç§æœ‰ä»“åº“ä¸­pullé•œåƒã€‚éœ€è¦å¯¹containerdè¿›è¡Œé…ç½®ã€‚ containerdæä¾›çš„å„ç§åŠŸèƒ½åœ¨å…¶å†…éƒ¨éƒ½æ˜¯é€šè¿‡æ’ä»¶å®ç°çš„ï¼Œå¯ä»¥ä½¿ç”¨ctr plugins lsæŸ¥çœ‹containerdçš„æ’ä»¶:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs shell">ctr plugins ls<br>TYPE                            ID                       PLATFORMS      STATUS<br>io.containerd.content.v1        content                  -              ok<br>io.containerd.snapshotter.v1    aufs                     linux/amd64    error<br>io.containerd.snapshotter.v1    btrfs                    linux/amd64    error<br>io.containerd.snapshotter.v1    devmapper                linux/amd64    error<br>io.containerd.snapshotter.v1    native                   linux/amd64    ok<br>io.containerd.snapshotter.v1    overlayfs                linux/amd64    ok<br>io.containerd.snapshotter.v1    zfs                      linux/amd64    error<br>io.containerd.metadata.v1       bolt                     -              ok<br>io.containerd.differ.v1         walking                  linux/amd64    ok<br>io.containerd.gc.v1             scheduler                -              ok<br>io.containerd.service.v1        introspection-service    -              ok<br>io.containerd.service.v1        containers-service       -              ok<br>io.containerd.service.v1        content-service          -              ok<br>io.containerd.service.v1        diff-service             -              ok<br>io.containerd.service.v1        images-service           -              ok<br>io.containerd.service.v1        leases-service           -              ok<br>io.containerd.service.v1        namespaces-service       -              ok<br>io.containerd.service.v1        snapshots-service        -              ok<br>io.containerd.runtime.v1        linux                    linux/amd64    ok<br>io.containerd.runtime.v2        task                     linux/amd64    ok<br>io.containerd.monitor.v1        cgroups                  linux/amd64    ok<br>io.containerd.service.v1        tasks-service            -              ok<br>io.containerd.internal.v1       restart                  -              ok<br>io.containerd.grpc.v1           containers               -              ok<br>io.containerd.grpc.v1           content                  -              ok<br>io.containerd.grpc.v1           diff                     -              ok<br>io.containerd.grpc.v1           events                   -              ok<br>io.containerd.grpc.v1           healthcheck              -              ok<br>io.containerd.grpc.v1           images                   -              ok<br>io.containerd.grpc.v1           leases                   -              ok<br>io.containerd.grpc.v1           namespaces               -              ok<br>io.containerd.internal.v1       opt                      -              ok<br>io.containerd.grpc.v1           snapshots                -              ok<br>io.containerd.grpc.v1           tasks                    -              ok<br>io.containerd.grpc.v1           version                  -              ok<br>io.containerd.grpc.v1           cri                      linux/amd64    ok<br><br></code></pre></td></tr></table></figure><p>ç§æœ‰é•œåƒä»“åº“ç›¸å…³çš„é…ç½®åœ¨criæ’ä»¶ä¸­ï¼Œæ–‡æ¡£Configure Image Registryä¸­åŒ…å«äº†é•œåƒä»“åº“çš„é…ç½®ã€‚ å…³äºç§æœ‰ä»“åº“å’Œè®¤è¯ä¿¡æ¯é…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼Œä¿®æ”¹&#x2F;etc&#x2F;containerd&#x2F;config.tomlï¼š</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">...</span><br>[plugins]<br><span class="hljs-string">...</span><br>  [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span>]<br>  <span class="hljs-string">...</span><br>    [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry</span>]<br>      [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.mirrors</span>]<br>        [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.mirrors.</span><span class="hljs-string">&quot;10.16.245.84:5000&quot;</span>]<br>          endpoint = [<span class="hljs-string">&quot;http://10.16.245.84:5000&quot;</span>]<br>      [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.configs</span>]<br>        [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.configs.</span><span class="hljs-string">&quot;10.16.245.84:5000&quot;</span><span class="hljs-string">.tls</span>]<br>          ca_file = <span class="hljs-string">&quot;&quot;</span><br>          cert_file = <span class="hljs-string">&quot;&quot;</span><br>          insecure_skip_verify = <span class="hljs-literal">true</span><br>          key_file = <span class="hljs-string">&quot;&quot;</span><br>        [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.configs.</span><span class="hljs-string">&quot;10.16.245.84:5000&quot;</span><span class="hljs-string">.auth</span>]<br>          username = <span class="hljs-string">&quot;admin&quot;</span><br>          password = <span class="hljs-string">&quot;123456&quot;</span><br>          <span class="hljs-comment"># auth = &quot;base64(username:password)&quot;</span><br><br><span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><p>é…ç½®å®Œæˆåé‡å¯containerdï¼Œå°±å¯ä»¥ä½¿ç”¨crictl pullé…ç½®çš„ç§æœ‰ä»“åº“çš„é•œåƒäº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><br>crictl pull  10.16.245.84:5000/nginx<br>E0517 20:05:58.231962   22727 remote_image.go:167] &quot;PullImage from image service failed&quot; err=&quot;rpc error: code = Unknown desc = failed to pull and unpack image \&quot;10.16.245.84:5000/nginx:latest\&quot;: failed to resolve reference \&quot;10.16.245.84:5000/nginx:latest\&quot;: failed to do request: Head \&quot;https://10.16.245.84:5000/v2/nginx/manifests/latest\&quot;: http: server gave HTTP response to HTTPS client&quot; image=&quot;10.16.245.84:5000/nginx&quot;<br>FATA[0000] pulling image: rpc error: code = Unknown desc = failed to pull and unpack image &quot;10.16.245.84:5000/nginx:latest&quot;: failed to resolve reference &quot;10.16.245.84:5000/nginx:latest&quot;: failed to do request: Head &quot;https://10.16.245.84:5000/v2/nginx/manifests/latest&quot;: http: server gave HTTP response to HTTPS client<br></code></pre></td></tr></table></figure><p>æˆ‘è¿™é‡ŒæŠ¥é”™äº†,ç§æœ‰ä»“åº“ ä½¿ç”¨çš„æ˜¯ registry + docker åˆ›å»ºçš„, æŠ¥é”™æ²¡æœ‰æ‰¾åˆ°å…·ä½“åŸå› .</p><p>æˆ‘ä½¿ç”¨çš„ ctr pull æˆåŠŸäº† é•œåƒ.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ctr  images pull --skip-verify  --user admin:123456   --plain-http 10.16.245.84:5000/nginx:latest<br><br></code></pre></td></tr></table></figure><p>5.æ€»ç»“<br>æˆ‘ä»¬å·²ç»éƒ¨ç½²äº†containerdï¼Œé…ç½®å¥½äº†ctrå’Œcrictlå·¥å…·ï¼Œå¹¶ä½¿ç”¨ctrå¯åŠ¨äº†ç¬¬ä¸€ä¸ªæµ‹è¯•å®¹å™¨ï¼Œä½†æ˜¯æ­¤æ—¶å®¹å™¨è¿˜ä¸å…·å¤‡ç½‘ç»œèƒ½åŠ›ï¼Œåªèƒ½åœ¨å®¹å™¨å†…éƒ¨è‡ªå·±ç©ã€‚ ä¸‹ä¸€æ­¥ï¼Œå°†å°è¯•æ‰‹å·¥é…ç½®containerdå’ŒcniåŠcniæ’ä»¶çš„é›†æˆï¼Œä¸ºå®¹å™¨åŠ å…¥åŸºæœ¬çš„ç½‘ç»œèƒ½åŠ›ã€‚</p><p>è½¬è½½è‡ª: <a href="https://blog.frognew.com/2021/04/relearning-container-02.html">https://blog.frognew.com/2021/04/relearning-container-02.html</a></p>]]></content>
    
    
    <categories>
      
      <category>containerd</category>
      
    </categories>
    
    
    <tags>
      
      <tag>containerd</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é‡å­¦å®¹å™¨-01ï¼šDockerã€Containerdã€Kubernetesä¹‹é—´çš„æ¸Šæº</title>
    <link href="/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A8-01%EF%BC%9ADocker%E3%80%81Containerd%E3%80%81Kubernetes%E4%B9%8B%E9%97%B4%E7%9A%84%E6%B8%8A%E6%BA%90/"/>
    <url>/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A8-01%EF%BC%9ADocker%E3%80%81Containerd%E3%80%81Kubernetes%E4%B9%8B%E9%97%B4%E7%9A%84%E6%B8%8A%E6%BA%90/</url>
    
    <content type="html"><![CDATA[<p>è¯è¯´Kuberneteséƒ½å¼ƒç”¨Dockershimäº†ï¼Œå› æ­¤æ˜¯æ—¶å€™å­¦ä¹ Containerdäº†ã€‚ æœ¬æ–‡å…ˆç®€å•æ•´ç†ä¸€ä¸‹Kubernetesã€Dockerã€Containerdä¹‹é—´çš„æ¸Šæºå’Œçº è‘›ã€‚</p><p>1.Docker, OCIå’ŒContainerd<br>è¿™é‡Œç•¥è¿‡æ—©æœŸDockerçš„å‘å±•å†å²ï¼Œå¤§æ¦‚å°±æ˜¯åœ¨dockerå¦‚æ—¥ä¸­å¤©çš„æ—¶å€™ï¼Œç¤¾åŒºè¦æå®¹å™¨åŒ–æ ‡å‡†ï¼Œæˆç«‹äº†OCI(Open Container Initiaiv)ï¼ŒOCIä¸»è¦åŒ…å«ä¸¤ä¸ªè§„èŒƒï¼Œä¸€ä¸ªæ˜¯å®¹å™¨è¿è¡Œæ—¶è§„èŒƒ(runtime-spec)ï¼Œä¸€ä¸ªæ˜¯å®¹å™¨é•œåƒè§„èŒƒ(image-spec)ã€‚ dockerçš„å…¬å¸ä¹Ÿåœ¨OCIä¸­ï¼Œè¿™é‡Œç•¥è¿‡åœ¨æ¨åŠ¨æ ‡å‡†åŒ–è¿‡ç¨‹ä¸­å„å¤§å‚å„è‡ªå¿ƒé‡Œçš„â€å°ç®—ç›˜â€å’Œâ€åˆ©ç›Šè€ƒè™‘â€ï¼Œdockeråœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ç”±ä¸€ä¸ªåºç„¶å¤§ç‰©é€æ¸æ‹†åˆ†å‡ºäº†containerdã€runcç­‰é¡¹ç›®ï¼Œ dockerå…¬å¸å°†runcæèµ ç»™äº†OCIï¼Œåæ¥å°†containerdæèµ ç»™äº†CNCFã€‚</p><p>runcæ˜¯ä»€ä¹ˆ? runcæ˜¯ä¸€ä¸ªè½»é‡çº§çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥ç”¨å®ƒæ¥è¿è¡Œå®¹å™¨ã€‚runcéµå¾ªOCIæ ‡å‡†æ¥åˆ›å»ºå’Œè¿è¡Œå®¹å™¨ï¼Œå®ƒç®—æ˜¯ç¬¬ä¸€ä¸ªOCI Runtimeæ ‡å‡†çš„å‚è€ƒå®ç°ã€‚<br>containerdæ˜¯ä»€ä¹ˆï¼Ÿcontainerdçš„è‡ªæˆ‘ä»‹ç»ä¸­è¯´å®ƒæ˜¯ä¸€ä¸ªå¼€æ”¾ã€å¯é çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå®é™…ä¸Šå®ƒåŒ…å«äº†å•æœºè¿è¡Œä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶çš„åŠŸèƒ½ã€‚ containerdä¸ºäº†æ”¯æŒå¤šç§OCI Runtimeå®ç°ï¼Œå†…éƒ¨ä½¿ç”¨containerd-shimï¼Œshimè‹±æ–‡ç¿»è¯‘è¿‡æ¥æ˜¯â€å«ç‰‡â€çš„æ„æ€ï¼Œè§åçŸ¥ä¹‰äº†ï¼Œä¾‹å¦‚ä¸ºäº†æ”¯æŒruncï¼Œå°±æä¾›äº†containerd-shim-runcã€‚<br>ç»è¿‡ä¸Šé¢çš„å‘å±•ï¼Œdockerå¯åŠ¨ä¸€ä¸ªå®¹å™¨çš„è¿‡ç¨‹å¤§è‡´æ˜¯ä¸‹å›¾æ‰€ç¤ºçš„æµç¨‹:</p><p><img src="/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A8-01%EF%BC%9ADocker%E3%80%81Containerd%E3%80%81Kubernetes%E4%B9%8B%E9%97%B4%E7%9A%84%E6%B8%8A%E6%BA%90/docker-run-container.png"></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæ¯å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå®é™…ä¸Šæ˜¯containerdå¯åŠ¨äº†ä¸€ä¸ªcontainerd-shim-runcè¿›ç¨‹ï¼Œå³ä½¿containerdçš„æŒ‚æ‰ä¹Ÿä¸ä¼šå½±å“åˆ°å·²ç»å¯åŠ¨çš„å®¹å™¨ã€‚</p><p>2.Kubernetes, Dockerå’ŒContainerd<br>kubernetesçš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å®¹å™¨ç¼–æ’çš„é—®é¢˜ï¼Œåœ¨æ—©æœŸä¸ºäº†æ”¯æŒå¤šä¸ªå®¹å™¨å¼•æ“ï¼Œæ˜¯åœ¨Kuberneteså†…éƒ¨å¯¹å¤šä¸ªå®¹å™¨å¼•æ“åšå…¼å®¹ï¼Œä¾‹å¦‚kubeletå¯åŠ¨ä¸€ä¸ªdocker-managerçš„è¿›ç¨‹ç›´æ¥è°ƒç”¨dockerçš„apiè¿›è¡Œå®¹å™¨çš„åˆ›å»ºã€‚</p><p><img src="/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A8-01%EF%BC%9ADocker%E3%80%81Containerd%E3%80%81Kubernetes%E4%B9%8B%E9%97%B4%E7%9A%84%E6%B8%8A%E6%BA%90/kubelet-run-containerd-0.png"></p><p>åæ¥k8sä¸ºäº†éš”ç¦»å„ä¸ªå®¹å™¨å¼•æ“ä¹‹é—´çš„å·®å¼‚ï¼Œåœ¨dockeråˆ†å‡ºcontainerdåï¼Œk8sä¹Ÿæå‡ºäº†è‡ªå·±çš„å®¹å™¨è¿è¡Œæ—¶æ¥å£(CRI)ï¼ŒCRIçš„å‡ºç°æ˜¯ä¸ºäº†ç»Ÿä¸€k8sä¸ä¸åŒå®¹å™¨å¼•æ“ä¹‹é—´äº¤äº’çš„æ¥å£ï¼Œä¸OCIçš„å®¹å™¨è¿è¡Œæ—¶è§„èŒƒä¸åŒï¼ŒCRIæ›´åŠ é€‚åˆk8sï¼Œä¸ä»…åŒ…å«å¯¹å®¹å™¨çš„ç®¡ç†ï¼Œè¿˜å¼•å…¥äº†k8sä¸­Podçš„æ¦‚å¿µåŠå¯¹Podç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ã€‚ k8så¼€å§‹æŠŠcontainerdæ¥å…¥CRIæ ‡å‡†ã€‚kubeleté€šè¿‡CRIæ¥å£è°ƒç”¨docker-shimï¼Œè¿›ä¸€æ­¥è°ƒç”¨docker apiã€‚æ­¤æ—¶åœ¨æ¯ä¸ªk8sèŠ‚ç‚¹ä¸Škubeletå¤§è‡´æŒ‰ä¸‹å›¾æµç¨‹å¯åŠ¨å®¹å™¨:</p><p><img src="/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A8-01%EF%BC%9ADocker%E3%80%81Containerd%E3%80%81Kubernetes%E4%B9%8B%E9%97%B4%E7%9A%84%E6%B8%8A%E6%BA%90/kubelet-run-containerd-1.png"></p><p>ä¸ºäº†æ›´å¥½çš„å°†containerdæ¥å…¥åˆ°CRIæ ‡å‡†ä¸­ï¼Œk8såˆæå‡ºäº†cri-containerdé¡¹ç›®ï¼Œcri-containerdæ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ç”¨æ¥å®ç°kubeletå’Œcontainerdä¹‹é—´çš„äº¤äº’ï¼Œæ­¤æ—¶k8sèŠ‚ç‚¹ä¸Škubeletå¤§è‡´æŒ‰ä¸‹å›¾æµç¨‹å¯åŠ¨å®¹å™¨:</p><p><img src="/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A8-01%EF%BC%9ADocker%E3%80%81Containerd%E3%80%81Kubernetes%E4%B9%8B%E9%97%B4%E7%9A%84%E6%B8%8A%E6%BA%90/kubelet-run-containerd-2.png"></p><p>åœ¨ä¸Šå›¾ä¸­cri-containerdå’Œcontainerdè¿˜æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä»–ä»¬ä¹‹é—´é€šè¿‡gRPCé€šä¿¡ï¼Œåæ¥åœ¨Containerd 1.1æ—¶ï¼Œå°†cri-containerdæ”¹æˆäº†Containerdçš„CRIæ’ä»¶ï¼ŒCRIæ’ä»¶ä½äºcontainerdå†…éƒ¨ï¼Œè¿™è®©k8så¯åŠ¨Podæ—¶çš„é€šä¿¡æ›´åŠ é«˜æ•ˆï¼Œæ­¤æ—¶k8sèŠ‚ç‚¹ä¸Škubeletå¤§è‡´æŒ‰ä¸‹å›¾æµç¨‹å¯åŠ¨å®¹å™¨:</p><p><img src="/2023/05/17/%E9%87%8D%E5%AD%A6%E5%AE%B9%E5%99%A8-01%EF%BC%9ADocker%E3%80%81Containerd%E3%80%81Kubernetes%E4%B9%8B%E9%97%B4%E7%9A%84%E6%B8%8A%E6%BA%90/kubelet-run-containerd-3.png"></p><p>ä¸ºäº†æ›´è´´è¿‘OCIï¼Œk8såˆæäº†ä¸€ä¸ªè½»é‡çº§çš„å®¹å™¨è¿è¡Œæ—¶cri-oï¼Œæ‰€ä»¥åœ¨k8sâ€æŠ›å¼ƒâ€dockershimåï¼Œå¯ä¾›æˆ‘ä»¬é€‰æ‹©çš„å®¹å™¨è¿è¡Œæ—¶æœ‰containerdå’Œcri-oã€‚</p><p>å°ç»“ä¸€ä¸‹kubeletå¯åŠ¨å®¹å™¨çš„å‘å±•å†ç¨‹:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">æ—©æœŸ: kubelet --&gt; docker-manager --&gt; docker<br>ä¸­æœŸ: kubelet -CRI-&gt; docker-shim --&gt; docker --&gt; containerd --&gt; runc<br>ä¸­æœŸ: kubelet -CRI-&gt; cri-containerd --&gt; containerd --&gt; runc<br>å½“å‰: kubelet -CRI-&gt; containerd(CRI plugin) --&gt; runc<br>å½“å‰: kubelet -CRI-&gt; cri-o --&gt; runc<br></code></pre></td></tr></table></figure><p>3.æ€»ç»“<br>dockeræ˜¯ä¸€ä¸ªä¼Ÿå¤§çš„é¡¹ç›®ï¼Œåœ¨ç†æ¸…Kubernetesã€Containerdå’ŒDockerä¹‹é—´çš„å…³ç³»åï¼Œå¯ä»¥çœ‹å‡ºdockerä¸ºociè´¡çŒ®äº†runtime specçš„æ ‡å‡†å‚è€ƒå®ç°runcï¼Œå¦å¤–ociçš„image specé•œåƒè§„èŒƒä¹Ÿæ˜¯ä»¥Dockeré•œåƒè§„èŒƒV2ä¸ºåŸºç¡€åˆ¶å®šçš„ï¼Œdockerè¿˜ä¸ºk8sè´¡çŒ®äº†ä¸€ä¸ªç¨³å®šå¯é çš„å®¹å™¨è¿è¡Œæ—¶containerdã€‚ è™½ç„¶k8såç»­å°†ä¸å†æ”¯æŒdockershimï¼Œä½†Dockeræœ¬èº«ä»ç„¶å¯ä»¥ä½œä¸ºæœ¬åœ°å¼€å‘ã€æµ‹è¯•å’Œå•æœºå®¹å™¨éƒ¨ç½²çš„åˆ©å™¨ã€‚</p><p>å¤§è‡´äº†è§£äº†containerdã€runcã€dockeréƒ½æ˜¯ä»€ä¹ˆåï¼Œä¸‹ä¸€é˜¶æ®µæˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ å¦‚ä½•éƒ¨ç½²containerdè¿™ä¸ªå®¹å™¨è¿è¡Œæ—¶ï¼Œå¹¶ä½“éªŒå¯åŠ¨ä¸€ä¸ªcontainerdå®¹å™¨ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>kubernetes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang-æ‰§è¡Œç‰¹æ®Šå­—ç¬¦çš„shell</title>
    <link href="/2023/04/13/golang-%E6%89%A7%E8%A1%8C%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E7%9A%84shell/"/>
    <url>/2023/04/13/golang-%E6%89%A7%E8%A1%8C%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E7%9A%84shell/</url>
    
    <content type="html"><![CDATA[<ol><li>ç¤ºä¾‹:</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br>    <span class="hljs-string">&quot;os/exec&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    cmd := exec.Command(<span class="hljs-string">&quot;ls&quot;</span>, <span class="hljs-string">&quot;-l&quot;</span>, <span class="hljs-string">&quot;/var/log/*.log&quot;</span>)<br>    out, err := cmd.CombinedOutput()<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>           fmt.Printf(<span class="hljs-string">&quot;combined out:\n%s\n&quot;</span>, <span class="hljs-type">string</span>(out))<br>     log.Fatalf(<span class="hljs-string">&quot;cmd.Run() failed with %s\n&quot;</span>, err)<br>    &#125;<br>    fmt.Printf(<span class="hljs-string">&quot;combined out:\n%s\n&quot;</span>, <span class="hljs-type">string</span>(out))<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>æŠ¥é”™</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">$ <span class="hljs-keyword">go</span> run demo.<span class="hljs-keyword">go</span> <br>combined out:<br>ls: cannot access /<span class="hljs-keyword">var</span>/log<span class="hljs-comment">/*.log: No such file or directory</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">2020/11/11 19:46:00 cmd.Run() failed with exit status 2</span><br><span class="hljs-comment">exit status 1</span><br></code></pre></td></tr></table></figure><ol start="3"><li>æ”¹è¿›</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br>    <span class="hljs-string">&quot;os/exec&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> des = <span class="hljs-string">&quot;/var/log/*.log&quot;</span><br>    cmd := exec.Command(<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, fmt.Sprintf(<span class="hljs-string">`ls -al %s`</span>, des))  <span class="hljs-comment">// æ­¤å¤„ä¸èƒ½ä½¿ç”¨ &quot;ls -al&quot; , è¿˜æ˜¯ä¼šæŠ¥é”™.</span><br>    out, err := cmd.CombinedOutput()<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>     fmt.Printf(<span class="hljs-string">&quot;combined out:\n%s\n&quot;</span>, <span class="hljs-type">string</span>(out))<br>     log.Fatalf(<span class="hljs-string">&quot;cmd.Run() failed with %s\n&quot;</span>, err)<br>    &#125;<br>    fmt.Printf(<span class="hljs-string">&quot;combined out:\n%s\n&quot;</span>, <span class="hljs-type">string</span>(out))<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span> <br>combined out:<br>-rw-r--r-- <span class="hljs-number">1</span> root root    <span class="hljs-number">0</span> Aug  <span class="hljs-number">8</span>  <span class="hljs-number">2019</span> /<span class="hljs-keyword">var</span>/log/boot.log<br>-rw------- <span class="hljs-number">1</span> root root <span class="hljs-number">3746</span> Mar <span class="hljs-number">31</span> <span class="hljs-number">16</span>:<span class="hljs-number">26</span> /<span class="hljs-keyword">var</span>/log/yum.log<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo-åˆ é™¤æ–‡ç« </title>
    <link href="/2023/03/23/hexo-%E5%88%A0%E9%99%A4%E6%96%87%E7%AB%A0/"/>
    <url>/2023/03/23/hexo-%E5%88%A0%E9%99%A4%E6%96%87%E7%AB%A0/</url>
    
    <content type="html"><![CDATA[<h2 id="æœªå‘å¸ƒæ–‡ç« "><a href="#æœªå‘å¸ƒæ–‡ç« " class="headerlink" title="æœªå‘å¸ƒæ–‡ç« "></a>æœªå‘å¸ƒæ–‡ç« </h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">Hexoæ­£å¸¸åˆ é™¤æ–‡ç« çš„æµç¨‹æ˜¯å…ˆåˆ é™¤æœ¬åœ°æ–‡ä»¶ã€‚<br><br>ä»¥åŸå§‹æ–‡ä»¶ï¼šhelloworld.mdä¸ºä¾‹ï¼š<br><br>é¦–å…ˆè¿›å…¥åˆ°source / _post æ–‡ä»¶å¤¹ä¸­ï¼Œæ‰¾åˆ°helloworld.mdæ–‡ä»¶ï¼Œåœ¨æœ¬åœ°ç›´æ¥æ‰§è¡Œåˆ é™¤ã€‚<br><br>ç„¶åä¾æ¬¡æ‰§è¡Œå‘½ä»¤ï¼š<br>hexo clean<br>hexo g<br>hexo d<br></code></pre></td></tr></table></figure><h2 id="å·²å‘å¸ƒæ–‡ç« "><a href="#å·²å‘å¸ƒæ–‡ç« " class="headerlink" title="å·²å‘å¸ƒæ–‡ç« "></a>å·²å‘å¸ƒæ–‡ç« </h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text"><br>å¦‚æœä½ å·²ç»å°†æ–‡ç« gitå‘å¸ƒäº†ï¼Œæ­¤æ—¶ä¼šåœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªåä¸º .deploy_gitçš„æ–‡ä»¶å¤¹ï¼Œå¹¶å°†ç”Ÿæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°è¯¥æ–‡ä»¶å¤¹ã€‚<br>ä½ éœ€è¦åˆ é™¤æœ¬åœ°çš„æ–‡ç« åï¼Œå‚è§ä¸Šé¢çš„æ­¥éª¤<br>å†åˆ é™¤ .deploy_gitæ–‡ä»¶å¤¹ã€‚<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pipeline-æœ€ä½³å®è·µ-7-å˜é‡ä½¿ç”¨</title>
    <link href="/2023/03/23/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-7-%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/03/23/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-7-%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<p>pipelineä¸­å¯ä»¥å®šä¹‰å˜é‡çš„ä½ç½®å¾ˆå¤šï¼Œæ¯ç§æ–¹æ³•ç”Ÿæ•ˆçš„èŒƒå›´ä¹Ÿä¸ç›¸åŒã€‚</p><h2 id="def"><a href="#def" class="headerlink" title="def"></a>def</h2><ol><li>å®šä¹‰åœ¨ pipeline èŠ‚ä¹‹å¤– ç”Ÿæ•ˆèŒƒå›´: æ•´ä¸ªpipelineæµæ°´çº¿.</li></ol><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-comment">// ssh</span><br><span class="hljs-keyword">def</span> ssh_port = <span class="hljs-string">&quot;2222&quot;</span><br><br></code></pre></td></tr></table></figure><ol start="2"><li>å®šä¹‰åœ¨ stage , ç”Ÿæ•ˆèŒƒå›´: å½“å‰ stageä¸­.</li></ol><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs groovy">stage &#123;<br>    <span class="hljs-keyword">def</span> current_user = admin<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="parameters"><a href="#parameters" class="headerlink" title="parameters"></a>parameters</h2><p>parameters ä¸­å¯ä»¥ä½¿ç”¨çš„ å‚æ•°å®šä¹‰ç±»å‹æœ‰å¾ˆå¤š,åœ¨æ­¤å¤„ä¸å»¶ä¼¸å±•å¼€.åœ¨å•ç‹¬çš„æ–‡ç« ä¸­è¯¦ç»†ä»‹ç».</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br><br>    options &#123;<br>        ansiColor(<span class="hljs-string">&#x27;xterm&#x27;</span>)<br>    &#125;<br><br>    parameters &#123;<br>        choice (<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;arch&#x27;</span>, <span class="hljs-attr">choices:</span> [<span class="hljs-string">&#x27;aarch64&#x27;</span>, <span class="hljs-string">&#x27;x86_64&#x27;</span>], <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;é€‰æ‹©CPUæ¶æ„&#x27;</span>)<br>        booleanParam (<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;basic_rpm_need&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-literal">true</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;æ˜¯å¦å¯¼å‡ºåŸºç¡€ç¯å¢ƒRPMåŒ…ï¼šopenjdkï¼Œsm_python_env&#x27;</span>) <br>        booleanParam (<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;system_rpm_need&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-literal">true</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;æ˜¯å¦å¯¼å‡ºRPMåŒ…ï¼šbrowser360ï¼Œexpect ...&#x27;</span>) <br>    &#125;<br><br>    ...<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="environment"><a href="#environment" class="headerlink" title="environment"></a>environment</h2><p>environment å®šä¹‰çš„æ˜¯ ç¯å¢ƒå˜é‡.<br>ç¯å¢ƒå˜é‡çš„ä½œç”¨èŒƒå›´ï¼Œå–å†³ä½ environment{â€¦}æ‰€å†™çš„ä½ç½®ï¼Œä½ å¯ä»¥å†™åœ¨é¡¶å±‚ç¯å¢ƒå˜é‡ï¼Œè®©æ‰€æœ‰çš„stageä¸‹çš„stepå…±äº«è¿™äº›å˜é‡ï¼Œä¹Ÿå¯ä»¥å•ç‹¬å®šä¹‰åœ¨æŸä¸€ä¸ªstageä¸‹ï¼Œåªèƒ½ä¾›è¿™ä¸ªstageå»è°ƒç”¨å˜é‡ï¼Œå…¶ä»–çš„stageä¸èƒ½å…±äº«è¿™äº›å˜é‡ã€‚</p><p>å¯ä»¥åœ¨ stages èŠ‚ä¹‹å¤– ,ä¹Ÿå°±æ˜¯å…¨å±€.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent &#123;<br>        label <span class="hljs-string">&#x27;!windows&#x27;</span><br>    &#125;<br><br>    environment &#123;<br>        DISABLE_AUTH = <span class="hljs-string">&#x27;true&#x27;</span> <span class="hljs-comment">// å€¼å¿…é¡»ç”¨å•åŒå¼•å·æ‹¬èµ·æ¥</span><br>        DB_ENGINE    = <span class="hljs-string">&#x27;sqlite&#x27;</span><br>    &#125;<br><br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Build&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&quot;Database engine is $&#123;DB_ENGINE&#125;&quot;</span><br>                echo <span class="hljs-string">&quot;DISABLE_AUTH is $&#123;DISABLE_AUTH&#125;&quot;</span><br>                sh <span class="hljs-string">&#x27;printenv&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥å®šä¹‰åœ¨stages å’Œ stage èŠ‚ä¸­ å®šä¹‰, å˜é‡ä¹Ÿåªåœ¨å½“å‰ stages å’Œ stage ä¸­ç”Ÿæ•ˆ.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs groovy">stage(<span class="hljs-string">&#x27;example&#x27;</span>)&#123;<br>    environment &#123;<br>        MACHIME = <span class="hljs-string">&quot;$&#123;params.arch&#125;&quot;</span><br>    &#125;<br>...<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="env"><a href="#env" class="headerlink" title="env"></a>env</h2><p>é€šè¿‡ env å…³é”®å­—æš´éœ²å‡ºæ¥çš„å…¨å±€å˜é‡ï¼Œå¯ä»¥åœ¨ Jenkins æ–‡ä»¶çš„ä»»ä½•ä½ç½®ä½¿ç”¨<br>jenkinså·²ç»åœ¨jobè¿è¡Œè¿‡ç¨‹ä¸­å†…ç½®äº†ä¸€äº›ç¯å¢ƒå˜é‡.</p><p>å¼•ç”¨ç¤ºä¾‹:</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> JOB_NAME = <span class="hljs-string">&quot;$&#123;env.JOB_NAME&#125;&quot;</span><br><span class="hljs-keyword">def</span> BUILD_NUMBER = <span class="hljs-string">&quot;$&#123;env.BUILD_NUMBER&#125;&quot;</span><br></code></pre></td></tr></table></figure><p>å®šä¹‰æ–°çš„ç¯å¢ƒå˜é‡</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs groovy">env.parentdir = <span class="hljs-string">&quot;example/subdir&quot;</span><br><span class="hljs-keyword">def</span> parentdir = <span class="hljs-string">&quot;$&#123;env.parentdir&#125;&quot;</span><br></code></pre></td></tr></table></figure><p>é‡å†™å˜é‡ withEnv</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs groovy">environment &#123;<br>     FOO = <span class="hljs-string">&quot;ä½ å½“åƒé¸Ÿé£å¾€ä½ çš„å±±&quot;</span><br>     NAME = <span class="hljs-string">&quot;Tan&quot;</span><br> &#125;<br><br>withEnv([<span class="hljs-string">&quot;FOO=Educated&quot;</span>]) &#123; <br>       <span class="hljs-comment">// åº”è¯¥æ‰“å° &quot;FOO = Educated&quot;</span><br>     echo <span class="hljs-string">&quot;FOO = $&#123;env.FOO&#125;&quot;</span> <br> &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
      <tag>pipeline</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pipeline-æœ€ä½³å®è·µ-9-å˜é‡åˆ¤æ–­</title>
    <link href="/2023/03/23/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-9-%E5%8F%98%E9%87%8F%E5%88%A4%E6%96%AD/"/>
    <url>/2023/03/23/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-9-%E5%8F%98%E9%87%8F%E5%88%A4%E6%96%AD/</url>
    
    <content type="html"><![CDATA[<h2 id="å¦‚ä½•åˆ¤æ–­å˜é‡æ˜¯å¦å­˜åœ¨"><a href="#å¦‚ä½•åˆ¤æ–­å˜é‡æ˜¯å¦å­˜åœ¨" class="headerlink" title="å¦‚ä½•åˆ¤æ–­å˜é‡æ˜¯å¦å­˜åœ¨"></a>å¦‚ä½•åˆ¤æ–­å˜é‡æ˜¯å¦å­˜åœ¨</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">if</span> (env.CHANGE_ID) &#123;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="parametersä¸­çš„å‚æ•°æ¡ä»¶åˆ¤æ–­"><a href="#parametersä¸­çš„å‚æ•°æ¡ä»¶åˆ¤æ–­" class="headerlink" title="parametersä¸­çš„å‚æ•°æ¡ä»¶åˆ¤æ–­"></a>parametersä¸­çš„å‚æ•°æ¡ä»¶åˆ¤æ–­</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">if</span> ( params.plugin_name == <span class="hljs-string">&quot;all&quot;</span> ) &#123;<br>    echo <span class="hljs-string">&quot;äº§å‡ºå…¨éƒ¨Toolsæ’ä»¶åˆ¶å“&quot;</span><br>    plugin_list.each() &#123;<br>        echo it<br>        sh <span class="hljs-string">&quot;cd $it;export ARCH=$&#123;env.ARCH&#125; ;make all&quot;</span><br>    &#125;<br><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    sh <span class="hljs-string">&quot;cd $&#123;plugin_name&#125; ;export ARCH=$&#123;env.ARCH&#125; ; make all&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="åˆ¤æ–­parametersä¸­çš„å‚æ•°æ˜¯å¦å­˜åœ¨"><a href="#åˆ¤æ–­parametersä¸­çš„å‚æ•°æ˜¯å¦å­˜åœ¨" class="headerlink" title="åˆ¤æ–­parametersä¸­çš„å‚æ•°æ˜¯å¦å­˜åœ¨"></a>åˆ¤æ–­parametersä¸­çš„å‚æ•°æ˜¯å¦å­˜åœ¨</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">if</span> (params.ParentJobName) &#123;<br>    echo <span class="hljs-string">&quot;job trigger from upstream $&#123;params.ParentJobName&#125;&quot;</span><br>    env.parentdir = <span class="hljs-string">&quot;../$&#123;params.ParentJobName&#125;/&quot;</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    echo <span class="hljs-string">&quot;no upstream job &quot;</span><br>    env.parentdir = <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>pipeline-æœ€ä½³å®è·µ-8-parametersè¯¦è§£</title>
    <link href="/2023/03/23/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-8-parameters%E8%AF%A6%E8%A7%A3/"/>
    <url>/2023/03/23/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-8-parameters%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p>parameters æä¾›ç”¨æˆ·åœ¨è§¦å‘pipelineæ—¶åº”æä¾›çš„å‚æ•°åˆ—è¡¨ã€‚è¿™äº›ç”¨æˆ·æŒ‡å®šçš„å‚æ•°çš„å€¼å¯ä»¥é€šè¿‡ params å¯¹è±¡æä¾›ç»™pipelineæ­¥éª¤.</p><p>æ¯ä¸ªå‚æ•°éƒ½æœ‰ä¸€ä¸ª Name å’Œ Valueï¼Œå…·ä½“å–å†³äºå‚æ•°ç±»å‹ã€‚æ­¤ä¿¡æ¯åœ¨ç”Ÿæˆå¼€å§‹æ—¶ä½œä¸ºç¯å¢ƒå˜é‡å¯¼å‡ºï¼Œä»è€Œå…è®¸ç”Ÿæˆé…ç½®çš„åç»­éƒ¨åˆ†è®¿é—®è¿™äº›å€¼ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨{ PARAMETER <em>NAME }è¯­æ³•(æˆ– Windows ä¸Šçš„% PARAMETER</em> NAME%)æ‰§è¡Œæ­¤æ“ä½œã€‚</p><h2 id="å¯ç”¨ç±»å‹"><a href="#å¯ç”¨ç±»å‹" class="headerlink" title="å¯ç”¨ç±»å‹"></a>å¯ç”¨ç±»å‹</h2><p>string å­—ç¬¦ä¸²ç±»å‹<br>text å¤šè¡Œæ–‡æœ¬ç±»å‹ï¼Œæ¢è¡Œä½¿ç”¨\n<br>booleanParam å¸ƒå°”ç±»å‹<br>choiceï¼Œé€‰æ‹©å‚æ•°ç±»å‹ï¼Œä½¿ç”¨\næ¥åˆ†éš”å¤šä¸ªé€‰é¡¹<br>password å¯†ç ç±»å‹</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    parameters &#123;<br>        string(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;PERSON&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-string">&#x27;Mr Jenkins&#x27;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;Who should I say hello to?&#x27;</span>)<br><br>        text(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;BIOGRAPHY&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;Enter some information about the person&#x27;</span>)<br><br>        booleanParam(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;TOGGLE&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-literal">true</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;Toggle this value&#x27;</span>)<br><br>        choice(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;CHOICE&#x27;</span>, <span class="hljs-attr">choices:</span> [<span class="hljs-string">&#x27;One&#x27;</span>, <span class="hljs-string">&#x27;Two&#x27;</span>, <span class="hljs-string">&#x27;Three&#x27;</span>], <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;Pick something&#x27;</span>)<br><br>        password(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;PASSWORD&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-string">&#x27;SECRET&#x27;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;Enter a password&#x27;</span>)<br>    &#125;<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&quot;Hello $&#123;params.PERSON&#125;&quot;</span><br><br>                echo <span class="hljs-string">&quot;Biography: $&#123;params.BIOGRAPHY&#125;&quot;</span><br><br>                echo <span class="hljs-string">&quot;Toggle: $&#123;params.TOGGLE&#125;&quot;</span><br><br>                echo <span class="hljs-string">&quot;Choice: $&#123;params.CHOICE&#125;&quot;</span><br><br>                echo <span class="hljs-string">&quot;Password: $&#123;params.PASSWORD&#125;&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>pipeline-æœ€ä½³å®è·µ-6-å¦‚ä½•å¾ªç¯</title>
    <link href="/2023/03/21/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-6-%E5%A6%82%E4%BD%95%E5%BE%AA%E7%8E%AF/"/>
    <url>/2023/03/21/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-6-%E5%A6%82%E4%BD%95%E5%BE%AA%E7%8E%AF/</url>
    
    <content type="html"><![CDATA[<p>pipelineä¸­ ä½¿ç”¨ each æ–¹æ³•æ¥éå† åˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­å…ƒç´  ç”¨ it æ¥ä»£æ›¿ã€‚</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-comment">// åˆ—è¡¨</span><br>example_list = [ <span class="hljs-string">&#x27;golang&#x27;</span>, <span class="hljs-string">&#x27;shell&#x27;</span>, <span class="hljs-string">&#x27;python&#x27;</span>, <span class="hljs-string">&#x27;java&#x27;</span> ]<br><br>pipeline &#123;<br>    agent any<br>    <br>    options &#123;<br>        ansiColor(<span class="hljs-string">&#x27;xterm&#x27;</span>)<br>    &#125;<br>    <br>    <span class="hljs-comment">// ä¸­é—´ä»£ç çœç•¥ã€‚</span><br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;3.æ„å»º&#x27;</span>)&#123;<br>            environment &#123;<br>                MACHIME = <span class="hljs-string">&quot;$arch&quot;</span><br>            &#125;<br><br>            steps &#123;<br>                script &#123;<br>                    <span class="hljs-keyword">if</span> ( params.middle_name == <span class="hljs-string">&quot;all&quot;</span> ) &#123;<br>                        echo <span class="hljs-string">&quot;äº§å‡ºå…¨éƒ¨åˆ¶å“&quot;</span><br>                        example_list.each() &#123;  <span class="hljs-comment">// å¼€å§‹å¾ªç¯</span><br>                            echo it <span class="hljs-comment">// it ä»£è¡¨å¾ªç¯ä¸­çš„å…ƒç´ ã€‚</span><br>                            sh <span class="hljs-string">&quot;bash example.sh $&#123;it&#125;&quot;</span><br>                        &#125;<br><br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        sh <span class="hljs-string">&quot;å‘µå‘µå“’&quot;</span><br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
      <tag>pipeline</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pipeline-æœ€ä½³å®è·µ-4-parallel-pendingé—®é¢˜</title>
    <link href="/2023/03/21/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-4-parallel-pending%E9%97%AE%E9%A2%98/"/>
    <url>/2023/03/21/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-4-parallel-pending%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>åœ¨pipelineç±»å‹çš„job ä¸­å¯ç”¨ parallel åå‘ç°,ä¼šæœ‰å¹¶è¡Œçš„job å‡ºç° pending ç­‰å¾…é—®é¢˜. å®é™…ä¸Š å¹¶è¡Œ æ•ˆæœæ²¡æœ‰ä½“ç°å‡ºæ¥.<br>æŸ¥çœ‹ ç­‰å¾…çŠ¶æ€çš„job æœ‰æç¤º : Waiting for next available executor</p><p>è§£å†³æ–¹æ³•:</p><p>è°ƒæ•´ å¯æ‰§è¡Œå™¨çš„ å¯ç”¨æ•°é‡ , é»˜è®¤masterçš„ å¯æ‰§è¡Œå™¨ æ•°é‡ ä¸º 2 . ä¸€æ—¦å‘èµ·å¹¶è¡Œ, executor ä¸å¤Ÿç”¨.</p><p>Dashboard -&gt; ç³»ç»Ÿç®¡ç† -&gt; èŠ‚ç‚¹åˆ—è¡¨ -&gt; master<br>ConfigureNumber of executors -&gt; 4 ,æ”¹ä¸º 4 .</p><p>åŒæ—¶åœ¨ master å¤„ å‘ç° è­¦å‘Šæç¤º : å‰©ä½™äº¤æ¢ç©ºé—´ ä¸è¶³ 0 .</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /data/jenkins_2_375_3/swap<br><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/data/jenkins_2_375_3/swap/swapfile bs=1024M count=4<br>mkswap /data/jenkins_2_375_3/swap/swapfile<br>swapon /data/jenkins_2_375_3/swap/swapfile<br>free -g<br>              total        used        free      shared  buff/cache   available<br>Mem:             63           9          10           0          43          44<br>Swap:             3           0           3<br><br></code></pre></td></tr></table></figure><p>é‡å¯ jenkinså, å‰©ä½™äº¤æ¢ç©ºé—´ æç¤º æ¶ˆå¤±.</p><p>è¿™æ—¶ å†æ¬¡ æ‰§è¡Œ ä¹‹å‰çš„ parallel çš„ job ,å‘ç° å¯ä»¥ å¹¶è¡Œ æ‰§è¡Œ 4 ä¸ª äº† .</p><p>åœ¨ job å·¦ä¸‹è§’ æ„å»ºæ‰§è¡ŒçŠ¶æ€ æœ‰ 4 ä¸ª è¿›åº¦æ¡. åˆ°æ­¤ OK.</p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
      <tag>pipeline</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pipeline-æœ€ä½³å®è·µ-5 åªä¿ç•™æœ€è¿‘çš„job</title>
    <link href="/2023/03/16/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-5-%E5%8F%AA%E4%BF%9D%E7%95%99%E6%9C%80%E8%BF%91%E7%9A%84job/"/>
    <url>/2023/03/16/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-5-%E5%8F%AA%E4%BF%9D%E7%95%99%E6%9C%80%E8%BF%91%E7%9A%84job/</url>
    
    <content type="html"><![CDATA[<h2 id="åˆ é™¤job-åªä¿ç•™æœ€è¿‘10æ¬¡"><a href="#åˆ é™¤job-åªä¿ç•™æœ€è¿‘10æ¬¡" class="headerlink" title="åˆ é™¤job,åªä¿ç•™æœ€è¿‘10æ¬¡"></a>åˆ é™¤job,åªä¿ç•™æœ€è¿‘10æ¬¡</h2><p>Dashboard -&gt; ç³»ç»Ÿç®¡ç† -&gt; Script Console ,ç²˜è´´ä¸‹é¢ groovy è„šæœ¬,æ‰§è¡Œ.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-comment">// Inspired by https://wiki.jenkins.io/display/JENKINS/Manually+run+log+rotation+on+all+jobs</span><br><span class="hljs-comment">// Check out these files for more info on LogRotator and WorkflowJob</span><br><span class="hljs-comment">// https://github.com/jenkinsci/jenkins/blob/master/core/src/main/java/hudson/tasks/LogRotator.java</span><br><span class="hljs-comment">// https://github.com/jenkinsci/workflow-job-plugin/blob/master/src/main/java/org/jenkinsci/plugins/workflow/job/WorkflowJob.java</span><br><span class="hljs-keyword">import</span> hudson.tasks.*;<br><span class="hljs-keyword">import</span> org.jenkinsci.plugins.workflow.job.*;<br><br><span class="hljs-keyword">def</span> jobs = Jenkins.instance.getAllItems(WorkflowJob.<span class="hljs-keyword">class</span>);<br><span class="hljs-keyword">def</span> numJobsToKeep = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">def</span> rotator = <span class="hljs-keyword">new</span> LogRotator(<span class="hljs-number">-1</span>, numJobsToKeep);<br><br><span class="hljs-keyword">def</span> startTime = System.currentTimeMillis();<br><br><span class="hljs-keyword">for</span> (WorkflowJob <span class="hljs-attr">job :</span> jobs) &#123;<br>    <span class="hljs-keyword">if</span> (System.currentTimeMillis() - startTime &gt; <span class="hljs-number">20000</span>) &#123;<br>        <span class="hljs-comment">// Bail out if it takes too long, just run the script again until it feels &quot;instant&quot;</span><br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    rotator.perform(job);<br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
      <tag>pipeline</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pipeline æœ€ä½³å®è·µ-3 parallelä½¿ç”¨</title>
    <link href="/2023/03/16/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-3-parallel%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/03/16/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-3-parallel%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<p>parallel èŠ‚å†…çš„ å¤šä¸ª stage å¯ä»¥åŒæ—¶ å¹¶è¡Œæ‰§è¡Œã€‚<br>failFast true ï¼›æ­¤é€‰é¡¹å¼€å¯ï¼šæœ‰stageæŠ¥é”™ï¼Œå°±å¼ºåˆ¶åœæ­¢å½“å‰job</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any <br><br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Build&#x27;</span>) &#123;<br>            failFast <span class="hljs-literal">true</span> <span class="hljs-comment">// æœ‰stageæŠ¥é”™ï¼Œå°±å¼ºåˆ¶åœæ­¢å½“å‰job</span><br>            parallel&#123;<br>                stage(<span class="hljs-string">&#x27;Build:Module1&#x27;</span>) &#123; <br>                    steps &#123; <br>                        sh <span class="hljs-string">&#x27;echo Build Module1 stage ...&#x27;</span> <br>                    &#125;<br>                &#125;<br>                stage(<span class="hljs-string">&#x27;Build:Module2&#x27;</span>) &#123; <br>                    steps &#123; <br>                        sh <span class="hljs-string">&#x27;echo Build Module2 stage ...&#x27;</span> <br>                    &#125;<br>                &#125;<br>                stage(<span class="hljs-string">&#x27;Build:Module3&#x27;</span>) &#123; <br>                    steps &#123; <br>                        sh <span class="hljs-string">&#x27;echo Build Module3 stage ...&#x27;</span> <br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Test&#x27;</span>)&#123;<br>            steps &#123;<br>                sh <span class="hljs-string">&#x27;echo Test stage ...&#x27;</span> <br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Deploy&#x27;</span>) &#123;<br>            steps &#123;<br>                sh <span class="hljs-string">&#x27;echo Deploy stage ...&#x27;</span> <br>            &#125;<br>        &#125;<br>    &#125;<br>  &#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
      <tag>pipeline</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pipelineä¸­dockerä½¿ç”¨</title>
    <link href="/2023/03/16/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-2-docker%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/03/16/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-2-docker%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<p>pipelineä¸­çš„agentèŠ‚,å¯ä»¥ä½¿ç”¨docker,å¯ä»¥å€Ÿç”¨åˆ°dockerçš„ä¸€äº›å‰æ²¿ç‰¹æ€§.å®ç°ä¸€äº›åŠŸèƒ½çš„å³æ’å³ç”¨.<br>å‰æ: åœ¨jenkinsæ‰€åœ¨ä¸»æœºä¸Šè¦å®‰è£…å¥½dockeræœåŠ¡.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># hello_world2.go æ —å­</span><br><span class="hljs-built_in">cat</span> hello_world2.go<br>package main<br><br>import <span class="hljs-string">&quot;fmt&quot;</span><br><br>const (<br> a = iota // a = 0<br> b        // b = 1<br> c        // c = 2<br> d = 5    // d = 5<br> e        // e = 5<br>)<br><br>func <span class="hljs-function"><span class="hljs-title">main</span></span>() &#123;<br> fmt.Printf(<span class="hljs-string">&quot;ÎšÎ±Î»Î·Î¼Î­ÏÎ± ÎºÏŒÏƒÎ¼Îµ; or ã“ã‚“ã«ã¡ã¯ ä¸–ç•Œ\n&quot;</span>)<br> fmt.Println(<span class="hljs-string">&quot;a: &quot;</span>, a)<br> fmt.Println(<span class="hljs-string">&quot;b: &quot;</span>, b)<br> fmt.Println(<span class="hljs-string">&quot;c: &quot;</span>, c)<br> fmt.Println(<span class="hljs-string">&quot;d: &quot;</span>, d)<br> fmt.Println(<span class="hljs-string">&quot;e: &quot;</span>, e)<br><br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><br><span class="hljs-keyword">def</span> JOB_NAME = <span class="hljs-string">&quot;$&#123;env.JOB_NAME&#125;&quot;</span><br><span class="hljs-keyword">def</span> BUILD_NUMBER = <span class="hljs-string">&quot;$&#123;env.BUILD_NUMBER&#125;&quot;</span><br><br><br>pipeline &#123;<br>    <span class="hljs-comment">// agent any</span><br>    agent &#123;<br>        docker &#123;<br>            <span class="hljs-comment">// image &#x27;node:7-alpine&#x27; éº’éºŸarm64æœºå™¨,æŠ¥é”™,åŸå› è¿™ä¸ªè€é•œåƒ.æœ¨æœ‰arm64çš„é•œåƒ.</span><br>            <span class="hljs-comment">// image &#x27;golang:alpine3.16&#x27;</span><br>            image <span class="hljs-string">&#x27;golang:1.20.1-alpine3.17&#x27;</span><br>            <span class="hljs-comment">// args &#x27;--platform linux/arm64 -it --entrypoint=/bin/bash&#x27;</span><br>            args <span class="hljs-string">&quot;-v /data/example:/tmp --platform linux/$&#123;params.arch&#125;&quot;</span><br>        &#125;<br>    &#125;<br><br><br>    parameters &#123;<br><br>        choice (<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;arch&#x27;</span>, <span class="hljs-attr">choices:</span> [<span class="hljs-string">&#x27;arm64&#x27;</span>, <span class="hljs-string">&#x27;amd64&#x27;</span>], <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;é€‰æ‹©CPUæ¶æ„&#x27;</span>)<br>        choice (<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;ostype&#x27;</span>, <span class="hljs-attr">choices:</span> [<span class="hljs-string">&#x27;ky10&#x27;</span>, <span class="hljs-string">&#x27;nfs4&#x27;</span>], <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;æœåŠ¡å™¨æ“ä½œç³»ç»Ÿç±»å‹ï¼Œky10ã€nfs4&#x27;</span>)<br><br>    &#125;<br><br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;1ã€æ‹‰å–ä»£ç &#x27;</span>)&#123;<br>            <span class="hljs-comment">// agent &#123;</span><br>            <span class="hljs-comment">//     docker &#123;</span><br>            <span class="hljs-comment">//     // image &#x27;node:7-alpine&#x27; éº’éºŸarm64æœºå™¨,æŠ¥é”™,åŸå› è¿™ä¸ªè€é•œåƒ.æœ¨æœ‰arm64çš„é•œåƒ.</span><br>            <span class="hljs-comment">//     // image &#x27;golang:alpine3.16&#x27;</span><br>            <span class="hljs-comment">//     image &#x27;golang:1.20.1-alpine3.17&#x27;</span><br>            <span class="hljs-comment">//     // args &#x27;--platform linux/arm64 -it --entrypoint=/bin/bash&#x27;</span><br>            <span class="hljs-comment">//     args &#x27;-v /data/example:/tmp --platform linux/amd64&#x27;</span><br>            <span class="hljs-comment">//     &#125;</span><br>            <span class="hljs-comment">// &#125;</span><br>            steps &#123;<br>                    sh <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">                    echo arch:`uname -m`</span><br><span class="hljs-string">                    rm -f go.mod</span><br><span class="hljs-string">                    /usr/local/go/bin/go env -w GO111MODULE=on </span><br><span class="hljs-string">                    /usr/local/go/bin/go mod init heheda</span><br><span class="hljs-string">                    go version </span><br><span class="hljs-string">                    cp -rf /tmp/hello_world2.go ./ </span><br><span class="hljs-string">                    ls ./ -al </span><br><span class="hljs-string">                    pwd </span><br><span class="hljs-string">                    env GOARCH=&quot;$&#123;params.arch&#125;&quot; /usr/local/go/bin/go build -o hello</span><br><span class="hljs-string">                    ls -al ./</span><br><span class="hljs-string">                    ./hello</span><br><span class="hljs-string">                    &quot;&quot;&quot;</span><br>            &#125;<br>        &#125;<br><br><br>        stage(<span class="hljs-string">&#x27;2ã€æ„å»ºæ’ä»¶&#x27;</span>) &#123;<br>            <span class="hljs-comment">// agent none</span><br>            steps &#123;<br>                echo <span class="hljs-string">&quot;å¼€å§‹è¿›è¡Œæ„å»º&quot;</span><br>                script &#123;<br>                    sh <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">                    go version</span><br><span class="hljs-string">                    &#x27;&#x27;&#x27;</span><br>                &#125;<br>                <br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pipeline æœ€ä½³å®è·µ-1</title>
    <link href="/2023/03/15/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-1/"/>
    <url>/2023/03/15/pipeline-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-1/</url>
    
    <content type="html"><![CDATA[<h2 id="ä¿®æ”¹jenkins-å·¥ä½œä¸»ç›®å½•"><a href="#ä¿®æ”¹jenkins-å·¥ä½œä¸»ç›®å½•" class="headerlink" title="ä¿®æ”¹jenkins å·¥ä½œä¸»ç›®å½•"></a>ä¿®æ”¹jenkins å·¥ä½œä¸»ç›®å½•</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">å¯åŠ¨jenkins:<br><span class="hljs-built_in">nohup</span> java -jar /Applications/Jenkins/jenkins.war --httpPort=8888 &amp;<br>é»˜è®¤ä¼šåœ¨ç”¨æˆ·å®¶ç›®å½•ä¸‹.jenkins é‡Šæ”¾æ‰€éœ€çš„æ–‡ä»¶,å³ä¸ºJENKINS_HOME.<br>åœ¨jarå¯åŠ¨å‰ä¿®æ”¹JENKINS_HOMEå³å¯è¾¾åˆ°ä¿®æ”¹jenkinsä¸»ç›®å½•çš„ç›®çš„<br>vim /etc/profile<br><span class="hljs-built_in">export</span> JENKINS_HOME=<span class="hljs-string">&#x27;/Volumes/Mac-Tools/jenkins&#x27;</span><br><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨systemdçº³ç®¡,å¯åœ¨ EnvironmentFile ä¸­ å®šä¹‰ JENKINS_HOME</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">cat</span> jenkins.service <br><span class="hljs-comment"># /usr/lib/systemd/system/jenkins.service</span><br>[Unit]<br>Description=Jenkins<br>After=network.target<br><br>[Service]<br>Type=simple<br>EnvironmentFile=/etc/sysconfig/jenkins<br>ExecStart=/usr/local/jdk-17.0.2/bin/java <span class="hljs-variable">$JAVA_OPTS</span>  -jar <span class="hljs-variable">$JENKINS_WAR</span> <span class="hljs-variable">$JENKINS_ARGS</span><br>Restart=always<br>RestartSec=10<br><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment"># jenkinsç¯å¢ƒå˜é‡æ–‡ä»¶</span><br><span class="hljs-built_in">cat</span> /etc/sysconfig/jenkins<br>JENKINS_WAR=/data/jenkins_2_375_3/jenkins.war<br><br>JENKINS_HOME=/data/jenkins_2_375_3/home<br><br>JAVA_OPTS=-Djava.awt.headless=<span class="hljs-literal">true</span> -XX:+UseStringDeduplication<br>JENKINS_ARGS=<span class="hljs-string">&quot;--httpPort=18080 \</span><br><span class="hljs-string">  --logfile=/data/jenkins_2_375_3/logs/jenkins.log \</span><br><span class="hljs-string">  --javaHome=/usr/local/jdk-17.0.2&quot;</span><br><br></code></pre></td></tr></table></figure><p>å·²ç»æœ‰jobåœ¨æ—§çš„ ~&#x2F;.jenkins ä¸­å·¥ä½œçš„è¯,éœ€è¦å°†jenkins åœæ‰, ç„¶å mv åˆ° æ–°å®šä¹‰çš„ ç›®å½•ä¸­.å†å¯åŠ¨jenkinså³å¯.</p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
      <tag>pipeline</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jenkins job ä½¿ç”¨jenkinsfile</title>
    <link href="/2023/03/15/jenkins-job-%E4%BD%BF%E7%94%A8jenkinsfile/"/>
    <url>/2023/03/15/jenkins-job-%E4%BD%BF%E7%94%A8jenkinsfile/</url>
    
    <content type="html"><![CDATA[<p>åˆ›å»ºpipeline ç±»å‹çš„jobæ—¶å€™,æœ‰2ç§é€‰æ‹©æ–¹å¼:</p><p>æµæ°´çº¿ -&gt; å®šä¹‰ -&gt;</p><h2 id="pipeline-script"><a href="#pipeline-script" class="headerlink" title="pipeline script"></a>pipeline script</h2><p>å¯ä»¥å°†pipelineçš„groovy è„šæœ¬ ç›´æ¥ è´´åˆ° scripts æ¡†ä¸­.<br>å¤šç”¨åœ¨åˆæœŸjobè°ƒè¯•è¿‡ç¨‹ä¸­.</p><h2 id="pipeline-script-from-scm"><a href="#pipeline-script-from-scm" class="headerlink" title="pipeline script from scm"></a>pipeline script from scm</h2><p>åœ¨SCMä¸­é€‰æ‹© git ç±»å‹ -&gt; Repository URL -&gt; Credentials -&gt; åˆ†æ”¯ -&gt; è„šæœ¬è·¯å¾„: pipeline-jenkins&#x2F;middleware-build.groovy<br>å¯ä»¥ç”¨åœ¨ç”Ÿäº§å®è·µä¸­,é€šè¿‡jenkinsfileæ¥å®ç°pipeline,å¯ä»¥å°†jenkinsfile æ”¾åˆ°å·¥ç¨‹ä»“åº“å®ç°ç‰ˆæœ¬ç®¡ç†.å¾—ä»¥ç®¡ç†æ•´ä¸ªé¡¹ç›®çš„ç”Ÿå‘½å‘¨æœŸ.<br>å®è·µè¯æ˜,æ¯æ¬¡å¯¹ jenkinsfile æ”¹åŠ¨ éƒ½å¯ä»¥ é€šè¿‡ SCM è·å–åˆ°,ç›´æ¥åé¦ˆåˆ°å…·ä½“çš„jobæ„å»ºè¿‡ç¨‹ä¸­.</p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
      <tag>pipeline</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jenkins-æµæ°´çº¿è¯­æ³•</title>
    <link href="/2023/03/14/jenkins-%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%AD%E6%B3%95/"/>
    <url>/2023/03/14/jenkins-%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%AD%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="æµæ°´çº¿è¯­æ³•"><a href="#æµæ°´çº¿è¯­æ³•" class="headerlink" title="æµæ°´çº¿è¯­æ³•"></a>æµæ°´çº¿è¯­æ³•</h1><ul><li>æœ¬æ–‡èŠ‚é€‰è‡ª jenkins.io</li><li><a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#%E5%8F%82%E6%95%B0">https://www.jenkins.io/zh/doc/book/pipeline/syntax/#%E5%8F%82%E6%95%B0</a></li></ul><p>æœ¬èŠ‚æ˜¯å»ºç«‹åœ¨ æµæ°´çº¿å…¥é—¨å†…å®¹çš„åŸºç¡€ä¸Šï¼Œè€Œä¸”ï¼Œåº”å½“è¢«å½“ä½œä¸€ä¸ªå‚è€ƒã€‚ å¯¹äºåœ¨å®é™…ç¤ºä¾‹ä¸­å¦‚ä½•ä½¿ç”¨æµæ°´çº¿è¯­æ³•çš„æ›´å¤šä¿¡æ¯, è¯·å‚é˜…æœ¬ç« åœ¨æµæ°´çº¿æ’ä»¶çš„2.5ç‰ˆæœ¬ä¸­çš„ ä½¿ç”¨ Jenkinsfileéƒ¨åˆ†, æµæ°´çº¿æ”¯æŒä¸¤ç§ç¦»æ•£çš„è¯­æ³•ï¼Œå…·ä½“å¦‚ä¸‹å¯¹äºæ¯ç§çš„ä¼˜ç¼ºç‚¹, å‚è§è¯­æ³•æ¯”è¾ƒã€‚</p><p>æ­£å¦‚ æœ¬ç« å¼€å§‹è®¨è®ºçš„, æµæ°´çº¿æœ€åŸºç¡€çš„éƒ¨åˆ†æ˜¯ â€œæ­¥éª¤â€ã€‚åŸºæœ¬ä¸Š, æ­¥éª¤å‘Šè¯‰ Jenkins è¦åšä»€ä¹ˆï¼Œä»¥åŠä½œä¸ºå£°æ˜å¼å’Œè„šæœ¬åŒ–æµæ°´çº¿è¯­æ³•çš„åŸºæœ¬æ„å»ºå—ã€‚</p><p>å¯¹äºå¯ç”¨æ­¥éª¤çš„æ¦‚è¿°, è¯·å‚è€ƒ æµæ°´çº¿æ­¥éª¤å¼•ç”¨ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªæ„å»ºåˆ°æµæ°´çº¿çš„æ­¥éª¤å’Œ æ’ä»¶æä¾›çš„æ­¥éª¤çš„å…¨é¢çš„åˆ—è¡¨ã€‚</p><p>å£°æ˜å¼æµæ°´çº¿<br>å£°æ˜å¼æµæ°´çº¿æ˜¯æœ€è¿‘æ·»åŠ åˆ° Jenkins æµæ°´çº¿çš„ ï¼Œå®ƒåœ¨æµæ°´çº¿å­ç³»ç»Ÿä¹‹ä¸Šæä¾›äº†ä¸€ç§æ›´ç®€å•ï¼Œæ›´æœ‰ä¸»è§çš„è¯­æ³•ã€‚</p><p>æ‰€æœ‰æœ‰æ•ˆçš„å£°æ˜å¼æµæ°´çº¿å¿…é¡»åŒ…å«åœ¨ä¸€ä¸ª pipeline å—ä¸­, æ¯”å¦‚:</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    <span class="hljs-comment">/*insert Declarative Pipeline here*/</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨å£°æ˜å¼æµæ°´çº¿ä¸­æœ‰æ•ˆçš„åŸºæœ¬è¯­å¥å’Œè¡¨è¾¾å¼éµå¾ªä¸ Groovyçš„è¯­æ³•åŒæ ·çš„è§„åˆ™ï¼Œ æœ‰ä»¥ä¸‹ä¾‹å¤–:</p><p>æµæ°´çº¿é¡¶å±‚å¿…é¡»æ˜¯ä¸€ä¸ª block, ç‰¹åˆ«åœ°: pipeline { }</p><p>æ²¡æœ‰åˆ†å·ä½œä¸ºè¯­å¥åˆ†éš”ç¬¦ï¼Œï¼Œæ¯æ¡è¯­å¥éƒ½å¿…é¡»åœ¨è‡ªå·±çš„è¡Œä¸Šã€‚</p><p>å—åªèƒ½ç”± èŠ‚æ®µ, æŒ‡ä»¤, æ­¥éª¤, æˆ–èµ‹å€¼è¯­å¥ç»„æˆã€‚ *å±æ€§å¼•ç”¨è¯­å¥è¢«è§†ä¸ºæ— å‚æ–¹æ³•è°ƒç”¨ã€‚ ä¾‹å¦‚, inputè¢«è§†ä¸º input()</p><h2 id="èŠ‚æ®µ"><a href="#èŠ‚æ®µ" class="headerlink" title="èŠ‚æ®µ"></a>èŠ‚æ®µ</h2><p>å£°æ˜å¼æµæ°´çº¿ä¸­çš„èŠ‚æ®µé€šå¸¸åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª æŒ‡ä»¤ æˆ– æ­¥éª¤ã€‚</p><h3 id="agent"><a href="#agent" class="headerlink" title="agent"></a>agent</h3><p>agent éƒ¨åˆ†æŒ‡å®šäº†æ•´ä¸ªæµæ°´çº¿æˆ–ç‰¹å®šçš„éƒ¨åˆ†, å°†ä¼šåœ¨Jenkinsç¯å¢ƒä¸­æ‰§è¡Œçš„ä½ç½®ï¼Œè¿™å–å†³äº agent åŒºåŸŸçš„ä½ç½®ã€‚è¯¥éƒ¨åˆ†å¿…é¡»åœ¨ pipeline å—çš„é¡¶å±‚è¢«å®šä¹‰, ä½†æ˜¯ stage çº§åˆ«çš„ä½¿ç”¨æ˜¯å¯é€‰çš„ã€‚</p><p>Required Yes</p><p>å‚æ•°<br>ä¸ºäº†æ”¯æŒä½œè€…å¯èƒ½æœ‰çš„å„ç§å„æ ·çš„ç”¨ä¾‹æµæ°´çº¿, agent éƒ¨åˆ†æ”¯æŒä¸€äº›ä¸åŒç±»å‹çš„å‚æ•°ã€‚è¿™äº›å‚æ•°åº”ç”¨åœ¨<code>pipeline</code>å—çš„é¡¶å±‚, æˆ– stage æŒ‡ä»¤å†…éƒ¨ã€‚</p><p>any<br>åœ¨ä»»ä½•å¯ç”¨çš„ä»£ç†ä¸Šæ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µã€‚<br>ä¾‹å¦‚: agent any</p><p>none<br>å½“åœ¨ pipeline å—çš„é¡¶éƒ¨æ²¡æœ‰å…¨å±€ä»£ç†ï¼Œ è¯¥å‚æ•°å°†ä¼šè¢«åˆ†é…åˆ°æ•´ä¸ªæµæ°´çº¿çš„è¿è¡Œä¸­å¹¶ä¸”æ¯ä¸ª stage éƒ¨åˆ†éƒ½éœ€è¦åŒ…å«ä»–è‡ªå·±çš„ agent éƒ¨åˆ†ã€‚<br>æ¯”å¦‚: agent none</p><p>label<br>åœ¨æä¾›äº†æ ‡ç­¾çš„ Jenkins ç¯å¢ƒä¸­å¯ç”¨çš„ä»£ç†ä¸Šæ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µã€‚<br>ä¾‹å¦‚: agent { label â€˜my-defined-labelâ€™ }</p><p>node<br>agent { node { label â€˜labelNameâ€™ } } å’Œ agent { label â€˜labelNameâ€™ } ä¸€æ ·, ä½†æ˜¯ node å…è®¸é¢å¤–çš„é€‰é¡¹ (æ¯”å¦‚ customWorkspace )ã€‚</p><p>docker<br>ä½¿ç”¨ç»™å®šçš„å®¹å™¨æ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µã€‚è¯¥å®¹å™¨å°†åœ¨é¢„ç½®çš„ nodeä¸Šï¼Œæˆ–åœ¨åŒ¹é…å¯é€‰å®šä¹‰çš„<code>label</code> å‚æ•°ä¸Šï¼ŒåŠ¨æ€çš„ä¾›åº”æ¥æ¥å—åŸºäºDockerçš„æµæ°´çº¿ã€‚ docker ä¹Ÿå¯ä»¥é€‰æ‹©çš„æ¥å— args å‚æ•°ï¼Œè¯¥å‚æ•°å¯èƒ½åŒ…å«ç›´æ¥ä¼ é€’åˆ° docker run è°ƒç”¨çš„å‚æ•°, ä»¥åŠ alwaysPull é€‰é¡¹, è¯¥é€‰é¡¹å¼ºåˆ¶ docker pull ï¼Œå³ä½¿é•œåƒåç§°å·²ç»å­˜åœ¨ã€‚</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs groovy">æ¯”å¦‚: <br>agent &#123; docker <span class="hljs-string">&#x27;maven:3-alpine&#x27;</span> &#125; <br><br>æˆ–<br><br>agent &#123;<br>    docker &#123;<br>        image <span class="hljs-string">&#x27;maven:3-alpine&#x27;</span><br>        label <span class="hljs-string">&#x27;my-defined-label&#x27;</span><br>        args  <span class="hljs-string">&#x27;-v /tmp:/tmp&#x27;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>dockerfile<br>æ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µ, ä½¿ç”¨ä»æºä»£ç åº“åŒ…å«çš„ Dockerfile æ„å»ºçš„å®¹å™¨ã€‚ä¸ºäº†ä½¿ç”¨è¯¥é€‰é¡¹ï¼Œ Jenkinsfile å¿…é¡»ä»å¤šä¸ªåˆ†æ”¯æµæ°´çº¿ä¸­åŠ è½½, æˆ–è€…åŠ è½½ â€œPipeline from SCM.â€ é€šå¸¸ï¼Œè¿™æ˜¯æºä»£ç ä»“åº“çš„æ ¹ç›®å½•ä¸‹çš„ Dockerfile : agent { dockerfile true }. å¦‚æœåœ¨å¦ä¸€ä¸ªç›®å½•ä¸‹æ„å»º Dockerfile , ä½¿ç”¨ dir é€‰é¡¹: agent { dockerfile {dir â€˜someSubDirâ€™ } }ã€‚å¦‚æœ Dockerfile æœ‰å¦ä¸€ä¸ªåç§°, ä½ å¯ä»¥ä½¿ç”¨ filename é€‰é¡¹æŒ‡å®šè¯¥æ–‡ä»¶åã€‚ä½ å¯ä»¥ä¼ é€’é¢å¤–çš„å‚æ•°åˆ° docker build â€¦ ä½¿ç”¨ additionalBuildArgs é€‰é¡¹æäº¤, æ¯”å¦‚ agent { dockerfile {additionalBuildArgs â€˜â€“build-arg foo&#x3D;barâ€™ } }ã€‚ ä¾‹å¦‚, ä¸€ä¸ªå¸¦æœ‰ build&#x2F;Dockerfile.build çš„ä»“åº“,æœŸæœ›ä¸€ä¸ªæ„å»ºå‚æ•° version:</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs groovy">agent &#123;<br>    <span class="hljs-comment">// Equivalent to &quot;docker build -f Dockerfile.build --build-arg version=1.0.2 ./build/</span><br>    dockerfile &#123;<br>        filename <span class="hljs-string">&#x27;Dockerfile.build&#x27;</span><br>        dir <span class="hljs-string">&#x27;build&#x27;</span><br>        label <span class="hljs-string">&#x27;my-defined-label&#x27;</span><br>        additionalBuildArgs  <span class="hljs-string">&#x27;--build-arg version=1.0.2&#x27;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¸¸è§é€‰é¡¹<br>æœ‰ä¸€äº›åº”ç”¨äºä¸¤ä¸ªæˆ–æ›´å¤š agent çš„å®ç°çš„é€‰é¡¹ã€‚ä»–ä»¬ä¸è¢«è¦æ±‚ï¼Œé™¤éç‰¹åˆ«è§„å®šã€‚</p><p>label<br>ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚è¯¥æ ‡ç­¾ç”¨äºè¿è¡Œæµæ°´çº¿æˆ–ä¸ªåˆ«çš„ stageã€‚</p><p>è¯¥é€‰é¡¹å¯¹ node, docker å’Œ dockerfile å¯ç”¨, <code>node</code>è¦æ±‚å¿…é¡»é€‰æ‹©è¯¥é€‰é¡¹ã€‚</p><p>customWorkspace<br>ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨è‡ªå®šä¹‰å·¥ä½œåŒºè¿è¡Œåº”ç”¨äº† agent çš„æµæ°´çº¿æˆ–ä¸ªåˆ«çš„ stage, è€Œä¸æ˜¯é»˜è®¤å€¼ã€‚ å®ƒæ—¢å¯ä»¥æ˜¯ä¸€ä¸ªç›¸å¯¹è·¯å¾„, åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè‡ªå®šä¹‰å·¥ä½œåŒºä¼šå­˜åœ¨äºèŠ‚ç‚¹å·¥ä½œåŒºæ ¹ç›®å½•ä¸‹, æˆ–è€…ä¸€ä¸ªç»å¯¹è·¯å¾„ã€‚æ¯”å¦‚:</p><p>agent {<br>    node {<br>        label â€˜my-defined-labelâ€™<br>        customWorkspace â€˜&#x2F;some&#x2F;other&#x2F;pathâ€™<br>    }<br>}<br>è¯¥é€‰é¡¹å¯¹ node, docker å’Œ dockerfile æœ‰ç”¨ ã€‚</p><p>reuseNode<br>ä¸€ä¸ªå¸ƒå°”å€¼, é»˜è®¤ä¸ºfalseã€‚ å¦‚æœæ˜¯true, åˆ™åœ¨æµæ°´çº¿çš„é¡¶å±‚æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šè¿è¡Œè¯¥å®¹å™¨, åœ¨åŒæ ·çš„å·¥ä½œåŒº, è€Œä¸æ˜¯åœ¨ä¸€ä¸ªå…¨æ–°çš„èŠ‚ç‚¹ä¸Šã€‚</p><p>è¿™ä¸ªé€‰é¡¹å¯¹ docker å’Œ dockerfile æœ‰ç”¨, å¹¶ä¸”åªæœ‰å½“ ä½¿ç”¨åœ¨ä¸ªåˆ«çš„ stage çš„ agent ä¸Šæ‰ä¼šæœ‰æ•ˆã€‚</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent &#123; docker <span class="hljs-string">&#x27;maven:3-alpine&#x27;</span> &#125;<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example Build&#x27;</span>) &#123;<br>            steps &#123;<br>                sh <span class="hljs-string">&#x27;mvn -B clean verify&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸€ä¸ªç»™å®šåç§°å’Œæ ‡ç­¾(maven:3-alpine)çš„æ–°å»ºçš„å®¹å™¨ä¸Šæ‰§è¡Œå®šä¹‰åœ¨æµæ°´çº¿ä¸­çš„æ‰€æœ‰æ­¥éª¤ ã€‚<br>é˜¶æ®µçº§åˆ«çš„ agent éƒ¨åˆ†<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent none<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example Build&#x27;</span>) &#123;<br>            agent &#123; docker <span class="hljs-string">&#x27;maven:3-alpine&#x27;</span> &#125;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello, Maven&#x27;</span><br>                sh <span class="hljs-string">&#x27;mvn --version&#x27;</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Example Test&#x27;</span>) &#123;<br>            agent &#123; docker <span class="hljs-string">&#x27;openjdk:8-jre&#x27;</span> &#125;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello, JDK&#x27;</span><br>                sh <span class="hljs-string">&#x27;java -version&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æµæ°´çº¿é¡¶å±‚å®šä¹‰ agent none ç¡®ä¿ an Executor æ²¡æœ‰è¢«åˆ†é…ã€‚ ä½¿ç”¨ agent none ä¹Ÿä¼šå¼ºåˆ¶ stage éƒ¨åˆ†åŒ…å«ä»–è‡ªå·±çš„ agent éƒ¨åˆ†ã€‚<br>ä½¿ç”¨é•œåƒåœ¨ä¸€ä¸ªæ–°å»ºçš„å®¹å™¨ä¸­æ‰§è¡Œè¯¥é˜¶æ®µçš„è¯¥æ­¥éª¤ã€‚<br>ä½¿ç”¨ä¸€ä¸ªä¸ä¹‹å‰é˜¶æ®µä¸åŒçš„é•œåƒåœ¨ä¸€ä¸ªæ–°å»ºçš„å®¹å™¨ä¸­æ‰§è¡Œè¯¥é˜¶æ®µçš„è¯¥æ­¥éª¤ã€‚</p><h3 id="post"><a href="#post" class="headerlink" title="post"></a>post</h3><p>post éƒ¨åˆ†å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªsteps ï¼Œè¿™äº›é˜¶æ®µæ ¹æ®æµæ°´çº¿æˆ–é˜¶æ®µçš„å®Œæˆæƒ…å†µè€Œ è¿è¡Œ(å–å†³äºæµæ°´çº¿ä¸­ post éƒ¨åˆ†çš„ä½ç½®). post æ”¯æŒä»¥ä¸‹ post-condition å—ä¸­çš„å…¶ä¸­ä¹‹ä¸€: always, changed, failure, success, unstable, å’Œ abortedã€‚è¿™äº›æ¡ä»¶å—å…è®¸åœ¨ post éƒ¨åˆ†çš„æ­¥éª¤çš„æ‰§è¡Œå–å†³äºæµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ã€‚</p><p>Conditions<br>always<br>æ— è®ºæµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€å¦‚ä½•ï¼Œéƒ½å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤ã€‚</p><p>changed<br>åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸å®ƒä¹‹å‰çš„è¿è¡Œä¸åŒæ—¶ï¼Œæ‰å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤ã€‚</p><p>failure<br>åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸ºâ€failureâ€ï¼Œæ‰å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸web UIæ˜¯çº¢è‰²ã€‚</p><p>success<br>åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸ºâ€successâ€ï¼Œæ‰å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸web UIæ˜¯è“è‰²æˆ–ç»¿è‰²ã€‚</p><p>unstable<br>åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸ºâ€unstableâ€ï¼Œæ‰å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸ç”±äºæµ‹è¯•å¤±è´¥,ä»£ç è¿è§„ç­‰é€ æˆã€‚é€šå¸¸web UIæ˜¯é»„è‰²ã€‚</p><p>aborted<br>åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸ºâ€abortedâ€ï¼Œæ‰å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸ç”±äºæµæ°´çº¿è¢«æ‰‹åŠ¨çš„abortedã€‚é€šå¸¸web UIæ˜¯ç°è‰²ã€‚</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>    post &#123;<br>        always &#123;<br>            echo <span class="hljs-string">&#x27;I will always say Hello again!&#x27;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŒ‰ç…§æƒ¯ä¾‹, post éƒ¨åˆ†åº”è¯¥æ”¾åœ¨æµæ°´çº¿çš„åº•éƒ¨ã€‚<br>Post-condition å—åŒ…å«ä¸ steps éƒ¨åˆ†ç›¸åŒçš„stepsã€‚</p><h3 id="stages"><a href="#stages" class="headerlink" title="stages"></a>stages</h3><p>åŒ…å«ä¸€ç³»åˆ—ä¸€ä¸ªæˆ–å¤šä¸ª stage æŒ‡ä»¤, stages éƒ¨åˆ†æ˜¯æµæ°´çº¿æè¿°çš„å¤§éƒ¨åˆ†â€workâ€ çš„ä½ç½®ã€‚ å»ºè®® stages è‡³å°‘åŒ…å«ä¸€ä¸ª stage æŒ‡ä»¤ç”¨äºè¿ç»­äº¤ä»˜è¿‡ç¨‹çš„æ¯ä¸ªç¦»æ•£éƒ¨åˆ†,æ¯”å¦‚æ„å»º, æµ‹è¯•, å’Œéƒ¨ç½²ã€‚</p><p>Required Yes</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>stages éƒ¨åˆ†é€šå¸¸ä¼šéµå¾ªè¯¸å¦‚ agent, options ç­‰çš„æŒ‡ä»¤ã€‚</p><h3 id="steps"><a href="#steps" class="headerlink" title="steps"></a>steps</h3><p>steps éƒ¨åˆ†åœ¨ç»™å®šçš„ stage æŒ‡ä»¤ä¸­æ‰§è¡Œçš„å®šä¹‰äº†ä¸€ç³»åˆ—çš„ä¸€ä¸ªæˆ–å¤šä¸ªstepsã€‚</p><p>Required Yes</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><br>pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>steps éƒ¨åˆ†å¿…é¡»åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ­¥éª¤ã€‚</p><h2 id="æŒ‡ä»¤"><a href="#æŒ‡ä»¤" class="headerlink" title="æŒ‡ä»¤"></a>æŒ‡ä»¤</h2><h3 id="environment"><a href="#environment" class="headerlink" title="environment"></a>environment</h3><p>environment æŒ‡ä»¤åˆ¶å®šä¸€ä¸ª é”®-å€¼å¯¹åºåˆ—ï¼Œè¯¥åºåˆ—å°†è¢«å®šä¹‰ä¸ºæ‰€æœ‰æ­¥éª¤çš„ç¯å¢ƒå˜é‡ï¼Œæˆ–è€…æ˜¯ç‰¹å®šäºé˜¶æ®µçš„æ­¥éª¤ï¼Œ è¿™å–å†³äº environment æŒ‡ä»¤åœ¨æµæ°´çº¿å†…çš„ä½ç½®ã€‚</p><p>è¯¥æŒ‡ä»¤æ”¯æŒä¸€ä¸ªç‰¹æ®Šçš„åŠ©æ‰‹æ–¹æ³• credentials() ï¼Œè¯¥æ–¹æ³•å¯ç”¨äºåœ¨Jenkinsç¯å¢ƒä¸­é€šè¿‡æ ‡è¯†ç¬¦è®¿é—®é¢„å®šä¹‰çš„å‡­è¯ã€‚å¯¹äºç±»å‹ä¸º â€œSecret Textâ€çš„å‡­è¯, credentials() å°†ç¡®ä¿æŒ‡å®šçš„ç¯å¢ƒå˜é‡åŒ…å«ç§˜å¯†æ–‡æœ¬å†…å®¹ã€‚å¯¹äºç±»å‹ä¸º â€œSStandard username and passwordâ€çš„å‡­è¯, æŒ‡å®šçš„ç¯å¢ƒå˜é‡æŒ‡å®šä¸º username:password ï¼Œå¹¶ä¸”ä¸¤ä¸ªé¢å¤–çš„ç¯å¢ƒå˜é‡å°†è¢«è‡ªåŠ¨å®šä¹‰ :åˆ†åˆ«ä¸º MYVARNAME_USR å’Œ MYVARNAME_PSW ã€‚</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    environment &#123;<br>        CC = <span class="hljs-string">&#x27;clang&#x27;</span><br>    &#125;<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            environment &#123;<br>                AN_ACCESS_KEY = credentials(<span class="hljs-string">&#x27;my-prefined-secret-text&#x27;</span>)<br>            &#125;<br>            steps &#123;<br>                sh <span class="hljs-string">&#x27;printenv&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¡¶å±‚æµæ°´çº¿å—ä¸­ä½¿ç”¨çš„ environment æŒ‡ä»¤å°†é€‚ç”¨äºæµæ°´çº¿ä¸­çš„æ‰€æœ‰æ­¥éª¤ã€‚<br>åœ¨ä¸€ä¸ª stage ä¸­å®šä¹‰çš„ environment æŒ‡ä»¤åªä¼šå°†ç»™å®šçš„ç¯å¢ƒå˜é‡åº”ç”¨äº stage ä¸­çš„æ­¥éª¤ã€‚<br>environment å—æœ‰ä¸€ä¸ª åŠ©æ‰‹æ–¹æ³• credentials() å®šä¹‰ï¼Œè¯¥æ–¹æ³•å¯ä»¥åœ¨ Jenkins ç¯å¢ƒä¸­ç”¨äºé€šè¿‡æ ‡è¯†ç¬¦è®¿é—®é¢„å®šä¹‰çš„å‡­è¯ã€‚</p><h3 id="options"><a href="#options" class="headerlink" title="options"></a>options</h3><p>options æŒ‡ä»¤å…è®¸ä»æµæ°´çº¿å†…éƒ¨é…ç½®ç‰¹å®šäºæµæ°´çº¿çš„é€‰é¡¹ã€‚ æµæ°´çº¿æä¾›äº†è®¸å¤šè¿™æ ·çš„é€‰é¡¹, æ¯”å¦‚ buildDiscarder,ä½†ä¹Ÿå¯ä»¥ç”±æ’ä»¶æä¾›, æ¯”å¦‚ timestamps.</p><p>å¯ç”¨é€‰é¡¹<br>buildDiscarder<br>ä¸ºæœ€è¿‘çš„æµæ°´çº¿è¿è¡Œçš„ç‰¹å®šæ•°é‡ä¿å­˜ç»„ä»¶å’Œæ§åˆ¶å°è¾“å‡ºã€‚ä¾‹å¦‚: options { buildDiscarder(logRotator(numToKeepStr: â€˜1â€™)) }</p><p>disableConcurrentBuilds<br>ä¸å…è®¸åŒæ—¶æ‰§è¡Œæµæ°´çº¿ã€‚ å¯è¢«ç”¨æ¥é˜²æ­¢åŒæ—¶è®¿é—®å…±äº«èµ„æºç­‰ã€‚ ä¾‹å¦‚: options { disableConcurrentBuilds() }</p><p>overrideIndexTriggers<br>å…è®¸è¦†ç›–åˆ†æ”¯ç´¢å¼•è§¦å‘å™¨çš„é»˜è®¤å¤„ç†ã€‚ å¦‚æœåˆ†æ”¯ç´¢å¼•è§¦å‘å™¨åœ¨å¤šåˆ†æ”¯æˆ–ç»„ç»‡æ ‡ç­¾ä¸­ç¦ç”¨, options { overrideIndexTriggers(true) } å°†åªå…è®¸å®ƒä»¬ç”¨äºä¿ƒå·¥ä½œã€‚å¦åˆ™, options { overrideIndexTriggers(false) } åªä¼šç¦ç”¨æ”¹ä½œä¸šçš„åˆ†æ”¯ç´¢å¼•è§¦å‘å™¨ã€‚</p><p>skipDefaultCheckout<br>åœ¨<code>agent</code> æŒ‡ä»¤ä¸­ï¼Œè·³è¿‡ä»æºä»£ç æ§åˆ¶ä¸­æ£€å‡ºä»£ç çš„é»˜è®¤æƒ…å†µã€‚ä¾‹å¦‚: options { skipDefaultCheckout() }</p><p>skipStagesAfterUnstable<br>ä¸€æ—¦æ„å»ºçŠ¶æ€å˜å¾—UNSTABLEï¼Œè·³è¿‡è¯¥é˜¶æ®µã€‚ä¾‹å¦‚: options { skipStagesAfterUnstable() }</p><p>checkoutToSubdirectory<br>åœ¨å·¥ä½œç©ºé—´çš„å­ç›®å½•ä¸­è‡ªåŠ¨åœ°æ‰§è¡Œæºä»£ç æ§åˆ¶æ£€å‡ºã€‚ä¾‹å¦‚: options { checkoutToSubdirectory(â€˜fooâ€™) }</p><p>timeout<br>è®¾ç½®æµæ°´çº¿è¿è¡Œçš„è¶…æ—¶æ—¶é—´, åœ¨æ­¤ä¹‹åï¼ŒJenkinså°†ä¸­æ­¢æµæ°´çº¿ã€‚ä¾‹å¦‚: options { timeout(time: 1, unit: â€˜HOURSâ€™) }</p><p>retry<br>åœ¨å¤±è´¥æ—¶, é‡æ–°å°è¯•æ•´ä¸ªæµæ°´çº¿çš„æŒ‡å®šæ¬¡æ•°ã€‚ For example: options { retry(3) }</p><p>timestamps<br>é¢„è°‹æ‰€æœ‰ç”±æµæ°´çº¿ç”Ÿæˆçš„æ§åˆ¶å°è¾“å‡ºï¼Œä¸è¯¥æµæ°´çº¿å‘å‡ºçš„æ—¶é—´ä¸€è‡´ã€‚ ä¾‹å¦‚: options { timestamps() }</p><p>Example<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    options &#123;<br>        timeout(<span class="hljs-attr">time:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">unit:</span> <span class="hljs-string">&#x27;HOURS&#x27;</span>)<br>    &#125;<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŒ‡å®šä¸€ä¸ªå°æ—¶çš„å…¨å±€æ‰§è¡Œè¶…æ—¶, åœ¨æ­¤ä¹‹åï¼ŒJenkins å°†ä¸­æ­¢æµæ°´çº¿è¿è¡Œã€‚</p><h2 id="é˜¶æ®µé€‰é¡¹"><a href="#é˜¶æ®µé€‰é¡¹" class="headerlink" title="é˜¶æ®µé€‰é¡¹"></a>é˜¶æ®µé€‰é¡¹</h2><p>stage çš„ options æŒ‡ä»¤ç±»ä¼¼äºæµæ°´çº¿æ ¹ç›®å½•ä¸Šçš„ options æŒ‡ä»¤ã€‚ç„¶è€Œï¼Œ stage -çº§åˆ« options åªèƒ½åŒ…æ‹¬ retry, timeout, æˆ– timestamps ç­‰æ­¥éª¤, æˆ–ä¸ stage ç›¸å…³çš„å£°æ˜å¼é€‰é¡¹ï¼Œå¦‚ skipDefaultCheckoutã€‚</p><p>åœ¨<code>stage</code>, options æŒ‡ä»¤ä¸­çš„æ­¥éª¤åœ¨è¿›å…¥ agent ä¹‹å‰è¢«è°ƒç”¨æˆ–åœ¨ when æ¡ä»¶å‡ºç°æ—¶è¿›è¡Œæ£€æŸ¥ã€‚</p><p>å¯é€‰çš„é˜¶æ®µé€‰é¡¹<br>skipDefaultCheckout<br>åœ¨ agent æŒ‡ä»¤ä¸­è·³è¿‡é»˜è®¤çš„ä»æºä»£ç æ§åˆ¶ä¸­æ£€å‡ºä»£ç ã€‚ä¾‹å¦‚: options { skipDefaultCheckout() }</p><p>timeout<br>è®¾ç½®æ­¤é˜¶æ®µçš„è¶…æ—¶æ—¶é—´, åœ¨æ­¤ä¹‹åï¼Œ Jenkins ä¼šç»ˆæ­¢è¯¥é˜¶æ®µã€‚ ä¾‹å¦‚: options { timeout(time: 1, unit: â€˜HOURSâ€™) }</p><p>retry<br>åœ¨å¤±è´¥æ—¶, é‡è¯•æ­¤é˜¶æ®µæŒ‡å®šæ¬¡æ•°ã€‚ ä¾‹å¦‚: options { retry(3) }</p><p>timestamps<br>é¢„è°‹æ­¤é˜¶æ®µç”Ÿæˆçš„æ‰€æœ‰æ§åˆ¶å°è¾“å‡ºä»¥åŠè¯¥è¡Œå‘å‡ºçš„æ—¶é—´ä¸€è‡´ã€‚ä¾‹å¦‚: options { timestamps() }</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            options &#123;<br>                timeout(<span class="hljs-attr">time:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">unit:</span> <span class="hljs-string">&#x27;HOURS&#x27;</span>)<br>            &#125;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŒ‡å®š Example é˜¶æ®µçš„æ‰§è¡Œè¶…æ—¶æ—¶é—´, åœ¨æ­¤ä¹‹åï¼ŒJenkins å°†ä¸­æ­¢æµæ°´çº¿è¿è¡Œã€‚</p><h2 id="parameters"><a href="#parameters" class="headerlink" title="parameters"></a>parameters</h2><p>æŒ‡ä»¤æä¾›äº†ä¸€ä¸ªç”¨æˆ·åœ¨è§¦å‘æµæ°´çº¿æ—¶åº”è¯¥æä¾›çš„å‚æ•°åˆ—è¡¨ã€‚è¿™äº›ç”¨æˆ·æŒ‡å®šå‚æ•°çš„å€¼å¯é€šè¿‡ params å¯¹è±¡æä¾›ç»™æµæ°´çº¿æ­¥éª¤, äº†è§£æ›´å¤šè¯·å‚è€ƒç¤ºä¾‹ã€‚</p><p>å¯ç”¨å‚æ•°<br>string<br>å­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°, ä¾‹å¦‚: parameters { string(name: â€˜DEPLOY_ENVâ€™, defaultValue: â€˜stagingâ€™, description: â€˜â€™) }</p><p>booleanParam<br>å¸ƒå°”å‚æ•°, ä¾‹å¦‚: parameters { booleanParam(name: â€˜DEBUG_BUILDâ€™, defaultValue: true, description: â€˜â€™) }</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    parameters &#123;<br>        string(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;PERSON&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-string">&#x27;Mr Jenkins&#x27;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;Who should I say hello to?&#x27;</span>)<br>    &#125;<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&quot;Hello $&#123;params.PERSON&#125;&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="triggers"><a href="#triggers" class="headerlink" title="triggers"></a>triggers</h2><p>æŒ‡ä»¤å®šä¹‰äº†æµæ°´çº¿è¢«é‡æ–°è§¦å‘çš„è‡ªåŠ¨åŒ–æ–¹æ³•ã€‚å¯¹äºé›†æˆäº†æºï¼ˆ æ¯”å¦‚ GitHub æˆ– BitBucketï¼‰çš„æµæ°´çº¿, å¯èƒ½ä¸éœ€è¦ triggers ï¼Œå› ä¸ºåŸºäº web çš„é›†æˆå¾ˆè‚¯èƒ½å·²ç»å­˜åœ¨ã€‚ å½“å‰å¯ç”¨çš„è§¦å‘å™¨æ˜¯ cron, pollSCM å’Œ upstreamã€‚</p><p>cron<br>æ¥æ”¶ cron æ ·å¼çš„å­—ç¬¦ä¸²æ¥å®šä¹‰è¦é‡æ–°è§¦å‘æµæ°´çº¿çš„å¸¸è§„é—´éš” ,æ¯”å¦‚: triggers { cron(â€˜H <em>&#x2F;4</em> * 1-5â€™) }</p><p>pollSCM<br>æ¥æ”¶ cron æ ·å¼çš„å­—ç¬¦ä¸²æ¥å®šä¹‰ä¸€ä¸ªå›ºå®šçš„é—´éš”ï¼Œåœ¨è¿™ä¸ªé—´éš”ä¸­ï¼ŒJenkins ä¼šæ£€æŸ¥æ–°çš„æºä»£ç æ›´æ–°ã€‚å¦‚æœå­˜åœ¨æ›´æ”¹, æµæ°´çº¿å°±ä¼šè¢«é‡æ–°è§¦å‘ã€‚ä¾‹å¦‚: triggers { pollSCM(â€˜H <em>&#x2F;4</em> * 1-5â€™) }</p><p>upstream<br>æ¥å—é€—å·åˆ†éš”çš„å·¥ä½œå­—ç¬¦ä¸²å’Œé˜ˆå€¼ã€‚ å½“å­—ç¬¦ä¸²ä¸­çš„ä»»ä½•ä½œä¸šä»¥æœ€å°é˜ˆå€¼ç»“æŸæ—¶ï¼Œæµæ°´çº¿è¢«é‡æ–°è§¦å‘ã€‚ä¾‹å¦‚: triggers { upstream(upstreamProjects: â€˜job1,job2â€™, threshold: hudson.model.Result.SUCCESS) }</p><p>pollSCM åªåœ¨Jenkins 2.22 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­å¯ç”¨ã€‚</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    triggers &#123;<br>        cron(<span class="hljs-string">&#x27;H */4* * 1-5&#x27;</span>)<br>    &#125;<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="stage"><a href="#stage" class="headerlink" title="stage"></a>stage</h3><p>stage æŒ‡ä»¤åœ¨ stages éƒ¨åˆ†è¿›è¡Œï¼Œåº”è¯¥åŒ…å«ä¸€ä¸ª å®é™…ä¸Š, æµæ°´å··æ‰€åšçš„æ‰€æœ‰å®é™…å·¥ä½œéƒ½å°†å°è£…è¿›ä¸€ä¸ªæˆ–å¤šä¸ª stage æŒ‡ä»¤ä¸­ã€‚</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å·¥å…·<br>å®šä¹‰è‡ªåŠ¨å®‰è£…å’Œæ”¾ç½® PATH çš„å·¥å…·çš„ä¸€éƒ¨åˆ†ã€‚å¦‚æœ agent none æŒ‡å®šï¼Œåˆ™å¿½ç•¥è¯¥æ“ä½œã€‚</p><p>Inside the pipeline block or a stage block.</p><p>æ”¯æŒå·¥å…·<br>maven<br>jdk<br>gradle<br>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    tools &#123;<br>        maven <span class="hljs-string">&#x27;apache-maven-3.0.1&#x27;</span><br>    &#125;<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            steps &#123;<br>                sh <span class="hljs-string">&#x27;mvn --version&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>The tool name must be pre-configured in Jenkins under Manage Jenkins â†’ Global Tool Configuration.</p><h3 id="input"><a href="#input" class="headerlink" title="input"></a>input</h3><p>stage çš„ input æŒ‡ä»¤å…è®¸ä½ ä½¿ç”¨ input stepæç¤ºè¾“å…¥ã€‚ åœ¨åº”ç”¨äº† options åï¼Œè¿›å…¥ stage çš„ agent æˆ–è¯„ä¼° when æ¡ä»¶å‰ï¼Œ stage å°†æš‚åœã€‚ å¦‚æœ input è¢«æ‰¹å‡†, stage å°†ä¼šç»§ç»­ã€‚ ä½œä¸º input æäº¤çš„ä¸€éƒ¨åˆ†çš„ä»»ä½•å‚æ•°éƒ½å°†åœ¨ç¯å¢ƒä¸­ç”¨äºå…¶ä»– stageã€‚</p><p>é…ç½®é¡¹<br>message<br>å¿…éœ€çš„ã€‚ è¿™å°†åœ¨ç”¨æˆ·æäº¤ input æ—¶å‘ˆç°ç»™ç”¨æˆ·ã€‚</p><p>id<br>input çš„å¯é€‰æ ‡è¯†ç¬¦ï¼Œ é»˜è®¤ä¸º stage åç§°ã€‚</p><p>ok<br><code>input</code>è¡¨å•ä¸Šçš„â€okâ€ æŒ‰é’®çš„å¯é€‰æ–‡æœ¬ã€‚</p><p>submitter<br>å¯é€‰çš„ä»¥é€—å·åˆ†éš”çš„ç”¨æˆ·åˆ—è¡¨æˆ–å…è®¸æäº¤ input çš„å¤–éƒ¨ç»„åã€‚é»˜è®¤å…è®¸ä»»ä½•ç”¨æˆ·ã€‚</p><p>submitterParameter<br>ç¯å¢ƒå˜é‡çš„å¯é€‰åç§°ã€‚å¦‚æœå­˜åœ¨ï¼Œç”¨ submitter åç§°è®¾ç½®ã€‚</p><p>parameters<br>æç¤ºæäº¤è€…æä¾›çš„ä¸€ä¸ªå¯é€‰çš„å‚æ•°åˆ—è¡¨ã€‚ æ›´å¤šä¿¡æ¯å‚è§ [parameters]ã€‚</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            input &#123;<br>                message <span class="hljs-string">&quot;Should we continue?&quot;</span><br>                ok <span class="hljs-string">&quot;Yes, we should.&quot;</span><br>                submitter <span class="hljs-string">&quot;alice,bob&quot;</span><br>                parameters &#123;<br>                    string(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;PERSON&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-string">&#x27;Mr Jenkins&#x27;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;Who should I say hello to?&#x27;</span>)<br>                &#125;<br>            &#125;<br>            steps &#123;<br>                echo <span class="hljs-string">&quot;Hello, $&#123;PERSON&#125;, nice to meet you.&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="when"><a href="#when" class="headerlink" title="when"></a>when</h3><p>when æŒ‡ä»¤å…è®¸æµæ°´çº¿æ ¹æ®ç»™å®šçš„æ¡ä»¶å†³å®šæ˜¯å¦åº”è¯¥æ‰§è¡Œé˜¶æ®µã€‚ when æŒ‡ä»¤å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¡ä»¶ã€‚ å¦‚æœ when æŒ‡ä»¤åŒ…å«å¤šä¸ªæ¡ä»¶, æ‰€æœ‰çš„å­æ¡ä»¶å¿…é¡»è¿”å›Trueï¼Œé˜¶æ®µæ‰èƒ½æ‰§è¡Œã€‚ è¿™ä¸å­æ¡ä»¶åœ¨ allOf æ¡ä»¶ä¸‹åµŒå¥—çš„æƒ…å†µç›¸åŒ (å‚è§ä¸‹é¢çš„ç¤ºä¾‹)ã€‚</p><p>ä½¿ç”¨è¯¸å¦‚ not, allOf, æˆ– anyOf çš„åµŒå¥—æ¡ä»¶å¯ä»¥æ„å»ºæ›´å¤æ‚çš„æ¡ä»¶ç»“æ„ can be built åµŒå¥—æ¡ä»¶å¯ä»¥åµŒå¥—åˆ°ä»»æ„æ·±åº¦ã€‚</p><p>å†…ç½®æ¡ä»¶<br>branch<br>å½“æ­£åœ¨æ„å»ºçš„åˆ†æ”¯ä¸æ¨¡å¼ç»™å®šçš„åˆ†æ”¯åŒ¹é…æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ, ä¾‹å¦‚: when { branch â€˜masterâ€™ }ã€‚æ³¨æ„ï¼Œè¿™åªé€‚ç”¨äºå¤šåˆ†æ”¯æµæ°´çº¿ã€‚</p><p>environment<br>å½“æŒ‡å®šçš„ç¯å¢ƒå˜é‡æ˜¯ç»™å®šçš„å€¼æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªæ­¥éª¤, ä¾‹å¦‚: when { environment name: â€˜DEPLOY_TOâ€™, value: â€˜productionâ€™ }</p><p>expression<br>å½“æŒ‡å®šçš„Groovyè¡¨è¾¾å¼è¯„ä¼°ä¸ºtrueæ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ, ä¾‹å¦‚: when { expression { return params.DEBUG_BUILD } }</p><p>not<br>å½“åµŒå¥—æ¡ä»¶æ˜¯é”™è¯¯æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ,å¿…é¡»åŒ…å«ä¸€ä¸ªæ¡ä»¶ï¼Œä¾‹å¦‚: when { not { branch â€˜masterâ€™ } }</p><p>allOf<br>å½“æ‰€æœ‰çš„åµŒå¥—æ¡ä»¶éƒ½æ­£ç¡®æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ,å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¡ä»¶ï¼Œä¾‹å¦‚: when { allOf { branch â€˜masterâ€™; environment name: â€˜DEPLOY_TOâ€™, value: â€˜productionâ€™ } }</p><p>anyOf<br>å½“è‡³å°‘æœ‰ä¸€ä¸ªåµŒå¥—æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ,å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¡ä»¶ï¼Œä¾‹å¦‚: when { anyOf { branch â€˜masterâ€™; branch â€˜stagingâ€™ } }</p><p>åœ¨è¿›å…¥ stage çš„ agent å‰è¯„ä¼° when<br>é»˜è®¤æƒ…å†µä¸‹, å¦‚æœå®šä¹‰äº†æŸä¸ªé˜¶æ®µçš„ä»£ç†ï¼Œåœ¨è¿›å…¥è¯¥<code>stage</code> çš„ agent åè¯¥ stage çš„ when æ¡ä»¶å°†ä¼šè¢«è¯„ä¼°ã€‚ä½†æ˜¯, å¯ä»¥é€šè¿‡åœ¨ when å—ä¸­æŒ‡å®š beforeAgent é€‰é¡¹æ¥æ›´æ”¹æ­¤é€‰é¡¹ã€‚ å¦‚æœ beforeAgent è¢«è®¾ç½®ä¸º true, é‚£ä¹ˆå°±ä¼šé¦–å…ˆå¯¹ when æ¡ä»¶è¿›è¡Œè¯„ä¼° , å¹¶ä¸”åªæœ‰åœ¨ when æ¡ä»¶éªŒè¯ä¸ºçœŸæ—¶æ‰ä¼šè¿›å…¥ agent ã€‚</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example Build&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Example Deploy&#x27;</span>) &#123;<br>            when &#123;<br>                branch <span class="hljs-string">&#x27;production&#x27;</span><br>            &#125;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Deploying&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example Build&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Example Deploy&#x27;</span>) &#123;<br>            when &#123;<br>                branch <span class="hljs-string">&#x27;production&#x27;</span><br>                environment <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;DEPLOY_TO&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;production&#x27;</span><br>            &#125;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Deploying&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example Build&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Example Deploy&#x27;</span>) &#123;<br>            when &#123;<br>                allOf &#123;<br>                    branch <span class="hljs-string">&#x27;production&#x27;</span><br>                    environment <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;DEPLOY_TO&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;production&#x27;</span><br>                &#125;<br>            &#125;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Deploying&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example Build&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Example Deploy&#x27;</span>) &#123;<br>            when &#123;<br>                branch <span class="hljs-string">&#x27;production&#x27;</span><br>                anyOf &#123;<br>                    environment <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;DEPLOY_TO&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;production&#x27;</span><br>                    environment <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;DEPLOY_TO&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;staging&#x27;</span><br>                &#125;<br>            &#125;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Deploying&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example Build&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Example Deploy&#x27;</span>) &#123;<br>            when &#123;<br>                expression &#123; BRANCH_NAME ==~ <span class="hljs-regexp">/(production|staging)/</span> &#125;<br>                anyOf &#123;<br>                    environment <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;DEPLOY_TO&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;production&#x27;</span><br>                    environment <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;DEPLOY_TO&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;staging&#x27;</span><br>                &#125;<br>            &#125;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Deploying&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent none<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example Build&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Example Deploy&#x27;</span>) &#123;<br>            agent &#123;<br>                label <span class="hljs-string">&quot;some-label&quot;</span><br>            &#125;<br>            when &#123;<br>                beforeAgent <span class="hljs-literal">true</span><br>                branch <span class="hljs-string">&#x27;production&#x27;</span><br>            &#125;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Deploying&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="parallel"><a href="#parallel" class="headerlink" title="parallel"></a>parallel</h3><p>å£°æ˜å¼æµæ°´çº¿çš„é˜¶æ®µå¯ä»¥åœ¨ä»–ä»¬å†…éƒ¨å£°æ˜å¤šéš”åµŒå¥—é˜¶æ®µ, å®ƒä»¬å°†å¹¶è¡Œæ‰§è¡Œã€‚ æ³¨æ„ï¼Œä¸€ä¸ªé˜¶æ®µå¿…é¡»åªæœ‰ä¸€ä¸ª steps æˆ– parallel çš„é˜¶æ®µã€‚ åµŒå¥—é˜¶æ®µæœ¬èº«ä¸èƒ½åŒ…å«è¿›ä¸€æ­¥çš„ parallel é˜¶æ®µ, ä½†æ˜¯å…¶ä»–çš„é˜¶æ®µçš„è¡Œä¸ºä¸ä»»ä½•å…¶ä»– stage ç›¸åŒã€‚ä»»ä½•åŒ…å« parallel çš„é˜¶æ®µä¸èƒ½åŒ…å« agent æˆ– tools é˜¶æ®µ, å› ä¸ºä»–ä»¬æ²¡æœ‰ç›¸å…³ stepsã€‚</p><p>å¦å¤–, é€šè¿‡æ·»åŠ  failFast true åˆ°åŒ…å« parallel çš„ stage ä¸­ï¼Œ å½“å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹å¤±è´¥æ—¶ï¼Œä½ å¯ä»¥å¼ºåˆ¶æ‰€æœ‰çš„ parallel é˜¶æ®µéƒ½è¢«ç»ˆæ­¢ã€‚</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Non-Parallel Stage&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;This stage will be executed first.&#x27;</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Parallel Stage&#x27;</span>) &#123;<br>            when &#123;<br>                branch <span class="hljs-string">&#x27;master&#x27;</span><br>            &#125;<br>            failFast <span class="hljs-literal">true</span><br>            parallel &#123;<br>                stage(<span class="hljs-string">&#x27;Branch A&#x27;</span>) &#123;<br>                    agent &#123;<br>                        label <span class="hljs-string">&quot;for-branch-a&quot;</span><br>                    &#125;<br>                    steps &#123;<br>                        echo <span class="hljs-string">&quot;On Branch A&quot;</span><br>                    &#125;<br>                &#125;<br>                stage(<span class="hljs-string">&#x27;Branch B&#x27;</span>) &#123;<br>                    agent &#123;<br>                        label <span class="hljs-string">&quot;for-branch-b&quot;</span><br>                    &#125;<br>                    steps &#123;<br>                        echo <span class="hljs-string">&quot;On Branch B&quot;</span><br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><p>å£°æ˜å¼æµæ°´çº¿å¯èƒ½ä½¿ç”¨åœ¨ æµæ°´çº¿æ­¥éª¤å¼•ç”¨ä¸­è®°å½•çš„æ‰€æœ‰å¯ç”¨çš„æ­¥éª¤, å®ƒåŒ…å«ä¸€ä¸ªå®Œæ•´çš„æ­¥éª¤åˆ—è¡¨, å…¶ä¸­æ·»åŠ äº†ä¸‹é¢åˆ—å‡ºçš„æ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤åªåœ¨å£°æ˜å¼æµæ°´çº¿ä¸­ only supported ã€‚</p><h3 id="script"><a href="#script" class="headerlink" title="script"></a>script</h3><p>æ­¥éª¤éœ€è¦ [scripted-pipeline]å—å¹¶åœ¨å£°æ˜å¼æµæ°´çº¿ä¸­æ‰§è¡Œã€‚ å¯¹äºå¤§å¤šæ•°ç”¨ä¾‹æ¥è¯´,åº”è¯¥å£°æ˜å¼æµæ°´çº¿ä¸­çš„â€œè„šæœ¬â€æ­¥éª¤æ˜¯ä¸å¿…è¦çš„ï¼Œ ä½†æ˜¯å®ƒå¯ä»¥æä¾›ä¸€ä¸ªæœ‰ç”¨çš„â€é€ƒç”Ÿå‡ºå£â€ã€‚ éå¹³å‡¡çš„è§„æ¨¡å’Œ&#x2F;æˆ–å¤æ‚æ€§çš„ script å—åº”è¯¥è¢«è½¬ç§»åˆ° å…±äº«åº“ ã€‚</p><p>ç¤ºä¾‹<br>Jenkinsfile (Declarative Pipeline)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Example&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&#x27;Hello World&#x27;</span><br><br>                script &#123;<br>                    <span class="hljs-keyword">def</span> browsers = [<span class="hljs-string">&#x27;chrome&#x27;</span>, <span class="hljs-string">&#x27;firefox&#x27;</span>]<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; browsers.size(); ++i) &#123;<br>                        echo <span class="hljs-string">&quot;Testing the $&#123;browsers[i]&#125; browser&quot;</span><br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è„šæœ¬åŒ–æµæ°´çº¿ ä¸å†è¯¦ç»†ä»‹ç».</p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
      <category>pipeline</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
      <tag>pipeline</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jenkins-pipelineçš„ä½¿ç”¨</title>
    <link href="/2023/03/14/jenkins-pipeline%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/03/14/jenkins-pipeline%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<p>Jenkins pipeline æ˜¯Jenkins 2.0 çš„ç²¾é«“ï¼Œï¼Œæ˜¯å¸®åŠ©Jenkins å®ç°CI åˆ°CD è½¬å˜çš„é‡è¦è§’è‰²ã€‚ ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸€å¥—è¿è¡ŒäºJenkins ä¸Šçš„å·¥ä½œæµæ¡†æ¶ï¼Œå°†åŸæœ¬ç‹¬ç«‹è¿è¡Œäºå•ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ç‚¹çš„ä»»åŠ¡è¿æ¥èµ·æ¥ï¼Œå®ç°å•ä¸ªä»»åŠ¡éš¾ä»¥å®Œæˆçš„å¤æ‚å‘å¸ƒæµç¨‹ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">åœ¨ä½¿ç”¨jenkinsçš„pipelineæ—¶å€™,ä½ å¯èƒ½éœ€è¦æ³¨æ„ä¸‹,ä¸€äº›æ½œåœ¨çš„æ’ä»¶æ˜¯å¦å·²ç»å®‰è£….<br>git parameter<br>Active Choices<br>Git Pipeline<br>Active Choices parameter<br>ç­‰<br><br></code></pre></td></tr></table></figure><h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><p>åˆ†ä¸º2ç§: Declarative Pipeline (å£°æ˜å¼) , Scripted Pipeline (è„šæœ¬å¼)<br>å®é™…ç”Ÿäº§ç§ä½¿ç”¨ å£°æ˜å¼å³å¯.</p><p>Declarative Pipeline:</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-comment">// </span><br>pipeline &#123;<br>    agent any<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Build&#x27;</span>) &#123;<br>            steps &#123;<br>                <span class="hljs-comment">//</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Test&#x27;</span>) &#123;<br>            steps &#123;<br>                <span class="hljs-comment">//</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;Deploy&#x27;</span>) &#123;<br>            steps &#123;<br>                <span class="hljs-comment">//</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Scripted Pipeline:</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><br>node &#123;  <br>    stage(<span class="hljs-string">&#x27;Build&#x27;</span>) &#123;<br>        <span class="hljs-comment">//</span><br>    &#125;<br>    stage(<span class="hljs-string">&#x27;Test&#x27;</span>) &#123;<br>        <span class="hljs-comment">//</span><br>    &#125;<br>    stage(<span class="hljs-string">&#x27;Deploy&#x27;</span>) &#123;<br>        <span class="hljs-comment">//</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Declarative Pipeline æœ€å¤–å±‚æœ‰ä¸ª pipeline è¡¨æ˜å®ƒæ˜¯ä¸€ä¸ªå£°æ˜å¼æµæ°´çº¿ï¼Œä¸‹é¢ä¼šæœ‰ 4 ä¸ªä¸»è¦çš„éƒ¨åˆ†ï¼š agentï¼Œpostï¼Œstagesï¼Œstepsï¼Œæˆ‘ä¼šé€ä¸€ä»‹ç»ä¸€ä¸‹ã€‚</p><h3 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h3><p>agent ä¸»è¦ç”¨äºæè¿°æ•´ä¸ª Pipeline æˆ–è€…æŒ‡å®šçš„ Stage ç”±ä»€ä¹ˆè§„åˆ™æ¥é€‰æ‹©èŠ‚ç‚¹æ‰§è¡Œã€‚Pipeline çº§åˆ«çš„ agent å¯ä»¥è§†ä¸º Stage çº§åˆ«çš„é»˜è®¤å€¼ï¼Œå¦‚æœ stage ä¸­æ²¡æœ‰æŒ‡å®šï¼Œå°†ä¼šä½¿ç”¨ä¸ Pipeline ä¸€è‡´çš„è§„åˆ™ã€‚åœ¨æœ€æ–°çš„ Jenkins ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥æ”¯æŒæŒ‡å®šä»»æ„èŠ‚ç‚¹(any)ï¼Œä¸æŒ‡å®š(none)ï¼Œæ ‡ç­¾(label)ï¼ŒèŠ‚ç‚¹(node)ï¼Œdockerï¼Œdockerfile å’Œ kubernetes ç­‰ï¼Œå…·ä½“çš„é…ç½®ç»†èŠ‚å¯ä»¥æŸ¥çœ‹æ–‡æ¡£ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ docker çš„æ ·ä¾‹ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs groovy">agent &#123;<br>    docker &#123;<br>        image <span class="hljs-string">&#x27;myregistry.com/node&#x27;</span><br>        label <span class="hljs-string">&#x27;my-defined-label&#x27;</span><br>        registryUrl <span class="hljs-string">&#x27;https://myregistry.com/&#x27;</span><br>        registryCredentialsId <span class="hljs-string">&#x27;myPredefinedCredentialsInJenkins&#x27;</span><br>        args <span class="hljs-string">&#x27;-v /tmp:/tmp&#x27;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Tips:</p><p>å¦‚æœ Pipeline é€‰æ‹©äº† noneï¼Œé‚£ä¹ˆ stage å¿…é¡»è¦æŒ‡å®šä¸€ä¸ªæœ‰æ•ˆçš„ agentï¼Œå¦åˆ™æ— æ³•æ‰§è¡Œ<br>agent æŒ‡å®šçš„æ˜¯è§„åˆ™è€Œä¸æ˜¯å…·ä½“çš„èŠ‚ç‚¹ï¼Œå¦‚æœ stage å„è‡ªé…ç½®äº†è‡ªå·±çš„ agentï¼Œéœ€è¦æ³¨æ„æ˜¯ä¸æ˜¯åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œçš„</p><h3 id="Stages-amp-amp-Stage"><a href="#Stages-amp-amp-Stage" class="headerlink" title="Stages &amp;&amp; Stage"></a>Stages &amp;&amp; Stage</h3><p>Stages æ˜¯ Pipeline ä¸­æœ€ä¸»è¦çš„ç»„æˆéƒ¨åˆ†ï¼ŒJenkins å°†ä¼šæŒ‰ç…§ Stages ä¸­æè¿°çš„é¡ºåºä»ä¸Šå¾€ä¸‹çš„æ‰§è¡Œã€‚Stages ä¸­å¯ä»¥åŒ…æ‹¬ä»»æ„å¤šä¸ª Stageï¼Œè€Œ Stage ä¸ Stages åˆèƒ½äº’ç›¸åµŒå¥—ï¼Œé™¤æ­¤ä»¥å¤–è¿˜æœ‰ parallel æŒ‡ä»¤å¯ä»¥è®©å†…éƒ¨çš„ Stage å¹¶è¡Œè¿è¡Œã€‚å®é™…ä¸Šå¯ä»¥æŠŠ Stage å½“ä½œæœ€å°å•å…ƒ.<br>Stages æŒ‡å®šçš„æ˜¯é¡ºåºè¿è¡Œï¼Œè€Œ parallel æŒ‡å®šçš„æ˜¯å¹¶è¡Œè¿è¡Œã€‚</p><p>æ¥ä¸‹æ¥çš„è¿™ä¸ª case å¾ˆå¥½çš„è¯´æ˜äº†è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent none<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;Sequential&#x27;</span>) &#123;<br>            stages &#123;<br>                stage(<span class="hljs-string">&#x27;In Sequential 1&#x27;</span>) &#123;<br>                    steps &#123;<br>                        echo <span class="hljs-string">&quot;In Sequential 1&quot;</span><br>                    &#125;<br>                &#125;<br>                stage(<span class="hljs-string">&#x27;In Sequential 2&#x27;</span>) &#123;<br>                    steps &#123;<br>                        echo <span class="hljs-string">&quot;In Sequential 2&quot;</span><br>                    &#125;<br>                &#125;<br>                stage(<span class="hljs-string">&#x27;Parallel In Sequential&#x27;</span>) &#123;<br>                    parallel &#123;<br>                        stage(<span class="hljs-string">&#x27;In Parallel 1&#x27;</span>) &#123;<br>                            steps &#123;<br>                                echo <span class="hljs-string">&quot;In Parallel 1&quot;</span><br>                            &#125;<br>                        &#125;<br>                        stage(<span class="hljs-string">&#x27;In Parallel 2&#x27;</span>) &#123;<br>                            steps &#123;<br>                                echo <span class="hljs-string">&quot;In Parallel 2&quot;</span><br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>é™¤äº†æŒ‡å®š Stage ä¹‹é—´çš„é¡ºåºå…³ç³»ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ when æ¥æŒ‡å®šæŸä¸ª Stage æŒ‡å®šä¸å¦ï¼šæ¯”å¦‚è¦é…ç½®åªæœ‰åœ¨ Master åˆ†æ”¯ä¸Šæ‰æ‰§è¡Œ pushï¼Œå…¶ä»–åˆ†æ”¯ä¸Šéƒ½åªè¿è¡Œ build</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs groovy">stages &#123;<br>  stage(<span class="hljs-string">&#x27;Build&#x27;</span>) &#123;<br>    when &#123;<br>      not &#123; branch <span class="hljs-string">&#x27;master&#x27;</span> &#125;<br>    &#125;<br>    steps &#123;<br>      sh <span class="hljs-string">&#x27;./scripts/run.py build&#x27;</span><br>    &#125;<br>  &#125;<br>  stage(<span class="hljs-string">&#x27;Run&#x27;</span>) &#123;<br>    when &#123;<br>      branch <span class="hljs-string">&#x27;master&#x27;</span><br>    &#125;<br>    steps &#123;<br>      sh <span class="hljs-string">&#x27;./scripts/run.py push&#x27;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿˜èƒ½åœ¨ Stage çš„çº§åˆ«è®¾ç½® environmentï¼Œè¿™äº›å°±ä¸å±•å¼€äº†ï¼Œæ–‡æ¡£é‡Œæœ‰æ›´è¯¦ç»†çš„æè¿°ã€‚</p><h3 id="Steps"><a href="#Steps" class="headerlink" title="Steps"></a>Steps</h3><p>steps æ˜¯ Pipeline ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œæ¯ä¸ª Stage éƒ½éœ€è¦æŒ‡å®š Stepsã€‚Steps å†…éƒ¨å¯ä»¥æ‰§è¡Œä¸€ç³»åˆ—çš„æ“ä½œï¼Œä»»æ„æ“ä½œæ‰§è¡Œå‡ºé”™éƒ½ä¼šè¿”å›é”™è¯¯ã€‚å®Œæ•´çš„ Steps æ“ä½œåˆ—è¡¨å¯ä»¥å‚è€ƒ Pipeline Steps Referenceï¼Œè¿™é‡Œåªè¯´ä¸€äº›ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„çš„ç‚¹ã€‚</p><p>groovy è¯­æ³•ä¸­æœ‰ä¸åŒçš„å­—ç¬¦ä¸²ç±»å‹ï¼Œå…¶ä¸­ â€˜abcâ€™ æ˜¯ Plain å­—ç¬¦ä¸²ï¼Œä¸ä¼šè½¬ä¹‰ ${WROKSPACE} è¿™æ ·çš„å˜é‡ï¼Œè€Œ â€œabcâ€ ä¼šåšè¿™æ ·çš„è½¬æ¢ã€‚æ­¤å¤–è¿˜æœ‰ â€˜â€™â€™ xxx â€˜â€™â€™ æ”¯æŒè·¨è¡Œå­—ç¬¦ä¸²ï¼Œâ€â€â€ åŒç†ã€‚<br>è°ƒç”¨å‡½æ•°çš„ () å¯ä»¥çœç•¥ï¼Œä½¿å¾—å‡½æ•°è°ƒç”¨å½¢å¦‚ updateGitlabCommitStatus name: â€˜buildâ€™, state: â€˜successâ€™ï¼Œé€šè¿‡ , æ¥åˆ†å‰²ä¸åŒçš„å‚æ•°ï¼Œæ”¯æŒæ¢è¡Œã€‚<br>å¯ä»¥åœ¨å£°æ˜å¼æµæ°´çº¿ä¸­é€šè¿‡ script æ¥æ’å…¥ä¸€æ®µ groovy è„šæœ¬</p><h3 id="Post"><a href="#Post" class="headerlink" title="Post"></a>Post</h3><p>post éƒ¨åˆ†å°†ä¼šåœ¨ pipeline çš„æœ€åæ‰§è¡Œï¼Œç»å¸¸ç”¨äºä¸€äº›æµ‹è¯•å®Œæ¯•åçš„æ¸…ç†å’Œé€šçŸ¥æ“ä½œã€‚æ–‡æ¡£ä¸­ç»™å‡ºäº†ä¸€ç³»åˆ—çš„æƒ…å†µï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ alwaysï¼Œsuccess å’Œ failureã€‚</p><p>æ¯”å¦‚è¯´ä¸‹é¢çš„è„šæœ¬å°†ä¼šåœ¨æˆåŠŸå’Œå¤±è´¥çš„æ—¶å€™æ›´æ–° gitlab çš„çŠ¶æ€ï¼Œåœ¨å¤±è´¥çš„æ—¶å€™å‘é€é€šçŸ¥é‚®ä»¶ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs groovy">post &#123;<br>  failure &#123;<br>    updateGitlabCommitStatus <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;build&#x27;</span>, <span class="hljs-attr">state:</span> <span class="hljs-string">&#x27;failed&#x27;</span><br>    emailext <span class="hljs-attr">body:</span> <span class="hljs-string">&#x27;$DEFAULT_CONTENT&#x27;</span>, <span class="hljs-attr">recipientProviders:</span> [culprits()], <span class="hljs-attr">subject:</span> <span class="hljs-string">&#x27;$DEFAULT_SUBJECT&#x27;</span><br>  &#125;<br>  success &#123;<br>    updateGitlabCommitStatus <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;build&#x27;</span>, <span class="hljs-attr">state:</span> <span class="hljs-string">&#x27;success&#x27;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¯ä¸ªçŠ¶æ€å…¶å®éƒ½ç›¸å½“äºäºä¸€ä¸ª stepsï¼Œéƒ½èƒ½å¤Ÿæ‰§è¡Œä¸€ç³»åˆ—çš„æ“ä½œï¼Œä¸åŒçŠ¶æ€çš„æ‰§è¡Œé¡ºåºæ˜¯äº‹å…ˆè§„å®šå¥½çš„ï¼Œå°±æ˜¯æ–‡æ¡£ä¸­åˆ—å‡ºçš„é¡ºåºã€‚</p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
      <category>pipeline</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
      <tag>pipeline</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jenkinsä½¿ç”¨systemdçº³ç®¡</title>
    <link href="/2023/03/14/jenkins%E4%BD%BF%E7%94%A8systemd%E7%BA%B3%E7%AE%A1/"/>
    <url>/2023/03/14/jenkins%E4%BD%BF%E7%94%A8systemd%E7%BA%B3%E7%AE%A1/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åˆæŠŠjenkinsæ¡èµ·æ¥ç”¨äº†,è¿˜æ˜¯jenkinså¥½ç”¨,æƒ³æ€ä¹ˆè‡ªå®šä¹‰æµç¨‹éƒ½å¯ä»¥è‡ªå·±éšå¿ƒå®šåˆ¶,ä¸æ±‚äºº.</p><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">pwd</span><br>/data/jenkins_2_375_3<br>ll -al<br>total 92036<br>drwxr-xr-x 14 root root     4096 Feb 16 16:16 home<br>-rw-r--r--  1 root root 94238599 Feb 16 14:07 jenkins.war<br>drwxr-xr-x  2 root root       25 Feb 16 14:28 logs<br>drwxr-xr-x  2 root root       25 Feb 16 13:49 soft<br>ll /usr/local/jdk-17.0.2/<br>total 20<br>drwxr-xr-x  2 root  root  4096 Feb 16 13:36 bin<br>drwxr-xr-x  5 root  root   123 Feb 16 13:36 conf<br>drwxr-xr-x  3 root  root   132 Feb 16 13:36 include<br>drwxr-xr-x  2 root  root  4096 Feb 16 13:36 jmods<br>drwxr-xr-x 72 root  root  4096 Feb 16 13:36 legal<br>drwxr-xr-x  5 root  root  4096 Feb 16 13:36 lib<br>-rw-r--r--  1 10668 10668 1210 Dec  8  2021 release<br><br></code></pre></td></tr></table></figure><p>æœ¬ç¯å¢ƒjenkinsä½¿ç”¨çš„ç‰ˆæœ¬: 2.375.3<br>openjdk ç‰ˆæœ¬: 17.0.2<br>ç°åœ¨è¾ƒæ–°çš„jenkinsç‰ˆæœ¬ä¾èµ–çš„openjdkç‰ˆæœ¬ä¸å†æ˜¯jdk 1.8äº†,ä½¿ç”¨1.8ç‰ˆæœ¬åœ¨jenkinsé‡Œä¼šæç¤ºä¸€å¨è­¦å‘Š.<br>æœ¬openjdkä¸‹è½½åœ°å€: <a href="https://jdk.java.net/archive/">https://jdk.java.net/archive/</a></p><h2 id="systemd-ç®¡ç†"><a href="#systemd-ç®¡ç†" class="headerlink" title="systemd ç®¡ç†"></a>systemd ç®¡ç†</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># jenkinsç¯å¢ƒå˜é‡æ–‡ä»¶</span><br><span class="hljs-built_in">cat</span> /etc/sysconfig/jenkins<br>JENKINS_WAR=/data/jenkins_2_375_3/jenkins.war<br><br>JENKINS_HOME=/data/jenkins_2_375_3/home<br><br>JAVA_OPTS=-Djava.awt.headless=<span class="hljs-literal">true</span> -XX:+UseStringDeduplication<br>JENKINS_ARGS=<span class="hljs-string">&quot;--httpPort=18080 \</span><br><span class="hljs-string">  --logfile=/data/jenkins_2_375_3/logs/jenkins.log \</span><br><span class="hljs-string">  --javaHome=/usr/local/jdk-17.0.2&quot;</span><br><br><span class="hljs-comment"># serviceæ–‡ä»¶</span><br>systemctl <span class="hljs-built_in">cat</span> jenkins.service <br><span class="hljs-comment"># /usr/lib/systemd/system/jenkins.service</span><br>[Unit]<br>Description=Jenkins<br>After=network.target<br><br>[Service]<br>Type=simple<br>EnvironmentFile=/etc/sysconfig/jenkins<br>ExecStart=/usr/local/jdk-17.0.2/bin/java <span class="hljs-variable">$JAVA_OPTS</span>  -jar <span class="hljs-variable">$JENKINS_WAR</span> <span class="hljs-variable">$JENKINS_ARGS</span><br>Restart=always<br>RestartSec=10<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>buildx é™æ€æ„å»º static link build</title>
    <link href="/2023/03/14/buildx-%E9%9D%99%E6%80%81%E6%9E%84%E5%BB%BAkeepalived-static-link-build/"/>
    <url>/2023/03/14/buildx-%E9%9D%99%E6%80%81%E6%9E%84%E5%BB%BAkeepalived-static-link-build/</url>
    
    <content type="html"><![CDATA[<p>è§‚æ‘©ä¸€ä½å¤§ä½¬çš„åšå®¢,å‘ç°è¿™keepalivedæ„å»ºå¾ˆæœ‰æ„æ€.åç»­å·¥ä½œå¯èƒ½ä¼šé‡åˆ°,æ‹¿æ¥ç§€ä¸€æŠŠ.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å®Œæ•´dockerfile</span><br>FROM alpine as build<br>RUN <span class="hljs-keyword">if</span> [ -f /etc/apk/repositories ];<span class="hljs-keyword">then</span> sed -i <span class="hljs-string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27;</span> /etc/apk/repositories; <span class="hljs-keyword">fi</span> &amp;&amp; \<br>    <span class="hljs-keyword">if</span> [ -f /etc/apt/sources.list ];<span class="hljs-keyword">then</span> sed -ri <span class="hljs-string">&#x27;s/(deb|security).debian.org/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list; <span class="hljs-keyword">fi</span> &amp;&amp; \<br>    <span class="hljs-keyword">if</span> [ ! -e /etc/nsswitch.conf ];<span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;hosts: files dns myhostname&#x27;</span> &gt; /etc/nsswitch.conf; <span class="hljs-keyword">fi</span>  &amp;&amp; \<br>    apk --no-cache add \<br>        binutils \<br>        file \<br>        file-dev \<br>        gcc \<br>        glib \<br>        glib-dev \<br>        ipset \<br>        ipset-dev \<br>        iptables \<br>        iptables-dev \<br>        libmnl-dev \<br>        libnftnl-dev \<br>        libnl3 \<br>        libnl3-dev \<br>        make \<br>        musl-dev \<br>        net-snmp-dev \<br>        openssl \<br>        openssl-dev \<br>        openssl-libs-static \<br>        pcre2 \<br>        pcre2-dev \<br>        autoconf \<br>        automake zlib-static  alpine-sdk linux-headers  libmnl-static git<br>WORKDIR /opt<br>RUN git <span class="hljs-built_in">clone</span> https://github.com/acassen/keepalived.git<br><br>RUN <span class="hljs-built_in">set</span> -ex &amp;&amp; \<br>    <span class="hljs-built_in">cd</span> /opt/keepalived &amp;&amp; \<br>    ./autogen.sh &amp;&amp; \<br>    CFLAGS=<span class="hljs-string">&#x27;-static -s&#x27;</span> LDFLAGS=-static ./configure  --disable-dynamic-linking \<br>    --prefix=/usr \<br>    --exec-prefix=/usr \<br>    --bindir=/usr/bin \<br>    --sbindir=/usr/sbin \<br>    --sysconfdir=/etc \<br>    --datadir=/usr/share \<br>    --localstatedir=/var \<br>    --mandir=/usr/share/man \<br>    --enable-bfd \<br>    --enable-snmp \<br>    --enable-snmp-rfc \<br>    --enable-nftables \<br>    --enable-regex \<br>    --enable-json  --with-init=systemd --enable-vrrp --enable-libnl-dynamic<br>RUN <span class="hljs-built_in">set</span> -ex &amp;&amp; \<br>    <span class="hljs-built_in">cd</span> /opt/keepalived &amp;&amp; \<br>    make &amp;&amp; \<br>    make DESTDIR=/install_root install &amp;&amp; \<br>    find /install_root &amp;&amp; \<br><span class="hljs-comment"># delete the docs</span><br>    <span class="hljs-built_in">rm</span> -rf /install_root/usr/share<br><br>FROM scratch AS bin<br>COPY --from=build /install_root /<br><br></code></pre></td></tr></table></figure><p>æ„å»º:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker buildx build  . --platform linux/amd64,linux/arm64 \<br>    --target bin --output . <br><br><span class="hljs-comment"># æ„å»ºå®Œæˆä¹‹åç›®å½•å¦‚ä¸‹:</span><br> ll<br>total 55848<br>-rw-r--r--  1 root root     1778 Mar 11 13:44 dockerfile<br>-rw-r--r--  1 root root     1772 Mar 11 13:37 dockerfile.0311bak<br>-rw-r--r--  1 root root       52 Mar 10 15:18 dockerfile.bak<br>-rw-r--r--  1 root root       63 Mar 10 15:55 Dockerfile.bak<br>drwxrwxrwx 16 root root     4096 Mar 11 13:36 keepalived<br>-rw-rw-rw-  1 root root 21871546 Mar 11 13:37 keepalived.tar.gz<br>drwxr-xr-x  4 root root     4096 Jan  1  1970 linux_amd64<br>drwxr-xr-x  4 root root     4096 Jan  1  1970 linux_arm64<br>-rw-------  1 root root 35286016 Mar 10 15:25 tonistiigi.tar<br><br><span class="hljs-comment"># å…¶ä¸­ linux_amd64 ,linux_arm64å°±æ˜¯æ„å»ºç›®æ ‡çš„ç›®å½•.</span><br><br>$ ./usr/sbin/keepalived -v<br>Keepalived v2.2.7 (02/23,2022), git commit v2.2.7-22-geb533a93<br><br>Copyright(C) 2001-2022 Alexandre Cassen, &lt;acassen@gmail.com&gt;<br><br>Built with kernel headers <span class="hljs-keyword">for</span> Linux 5.10.41<br>Running on Linux 5.4.0-99-generic <span class="hljs-comment">#112-Ubuntu SMP Thu Feb 3 13:50:55 UTC 2022</span><br>Distro: Ubuntu 20.04.3 LTS<br><br>configure options: --disable-dynamic-linking --prefix=/usr --exec-prefix=/usr --bindir=/usr/bin --sbindir=/usr/sbin --sysconfdir=/etc --datadir=/usr/share --localstatedir=/var --mandir=/usr/share/man --enable-bfd --enable-snmp --enable-snmp-rfc --enable-nftables --enable-regex --enable-json --with-init=systemd --enable-vrrp --enable-libnl-dynamic CFLAGS=-static -s LDFLAGS=-static<br><br>Config options:  NFTABLES LVS REGEX VRRP VRRP_AUTH VRRP_VMAC JSON BFD OLD_CHKSUM_COMPAT SNMP_V3_FOR_V2 SNMP_VRRP SNMP_CHECKER SNMP_RFCV2 SNMP_RFCV3 INIT=systemd<br><br>System options:  VSYSLOG MEMFD_CREATE IPV6_MULTICAST_ALL IPV4_DEVCONF RTA_ENCAP RTA_EXPIRES RTA_NEWDST RTA_PREF FRA_SUPPRESS_PREFIXLEN FRA_SUPPRESS_IFGROUP FRA_TUN_ID RTAX_CC_ALGO RTAX_QUICKACK RTEXT_FILTER_SKIP_STATS FRA_L3MDEV FRA_UID_RANGE RTAX_FASTOPEN_NO_COOKIE RTA_VIA FRA_PROTOCOL FRA_IP_PROTO FRA_SPORT_RANGE FRA_DPORT_RANGE RTA_TTL_PROPAGATE IFA_FLAGS LWTUNNEL_ENCAP_MPLS LWTUNNEL_ENCAP_ILA NET_LINUX_IF_H_COLLISION NETINET_LINUX_IF_ETHER_H_COLLISION IPVS_DEST_ATTR_ADDR_FAMILY IPVS_SYNCD_ATTRIBUTES IPVS_64BIT_STATS IPVS_TUN_TYPE IPVS_TUN_CSUM IPVS_TUN_GRE VRRP_IPVLAN IFLA_LINK_NETNSID INET6_ADDR_GEN_MODE VRF SO_MARK<br><br>$ ldd usr/sbin/keepalived <br>        not a dynamic executable<br>$ file usr/sbin/keepalived<br>usr/sbin/keepalived: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, stripped<br><br>$ <span class="hljs-built_in">ls</span> -lh ./usr/sbin/keepalived<br>-rwxr-xr-x 1 root root 5.2M Mar 11 13:46 ./usr/sbin/keepalived<br></code></pre></td></tr></table></figure><p>è¯•äº†ä¸‹ arm64çš„CPUæ¶æ„æœºå™¨çš„ä¹Ÿå¯ä»¥æ„å»º â€“platform linux&#x2F;amd64,linux&#x2F;arm64 å³å¯ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker åŸºäº buildx æ„å»ºè·¨å¹³å°é•œåƒ</title>
    <link href="/2023/03/14/docker-%E5%9F%BA%E4%BA%8E-buildx-%E6%9E%84%E5%BB%BA%E8%B7%A8%E5%B9%B3%E5%8F%B0%E9%95%9C%E5%83%8F/"/>
    <url>/2023/03/14/docker-%E5%9F%BA%E4%BA%8E-buildx-%E6%9E%84%E5%BB%BA%E8%B7%A8%E5%B9%B3%E5%8F%B0%E9%95%9C%E5%83%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="docker-åŸºäº-buildx-æ„å»ºè·¨å¹³å°é•œåƒ"><a href="#docker-åŸºäº-buildx-æ„å»ºè·¨å¹³å°é•œåƒ" class="headerlink" title="docker åŸºäº buildx æ„å»ºè·¨å¹³å°é•œåƒ"></a>docker åŸºäº buildx æ„å»ºè·¨å¹³å°é•œåƒ</h2><p>buildx ç°åœ¨ä½œä¸ºä¸€ä¸ªè·¨å¹³å°æ„å»ºå·¥å…·å·²ç»ååˆ†çš„æˆç†Ÿäº†.åœ¨ x86_64 å¹³å°ä¸Šä½¿ç”¨ docker buildx æ„å»ºå¤šå¹³å°çš„ docker image.<br>åœ¨ Docker 19.03+ ç‰ˆæœ¬ä¸­å¯ä»¥ä½¿ç”¨ docker buildx build å‘½ä»¤ä½¿ç”¨ BuildKit æ„å»ºé•œåƒã€‚è¯¥å‘½ä»¤æ”¯æŒ â€“platform å‚æ•°å¯ä»¥åŒæ—¶æ„å»ºæ”¯æŒå¤šç§ç³»ç»Ÿæ¶æ„çš„ Docker é•œåƒï¼Œå¤§å¤§ç®€åŒ–äº†æ„å»ºæ­¥éª¤ã€‚<br>å®˜æ–¹å»ºè®® kernel å†…æ ¸ é«˜äº 4.8ä»¥ä¸Š,æœ¬æœº ç‰ˆæœ¬ä¸º :</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uname</span> -a<br>Linux mid1 4.19.113-14.nfs4.x86_64 <span class="hljs-comment">#1 SMP Wed Jul 28 19:53:18 CST 2021 x86_64 x86_64 x86_64 GNU/Linux</span><br></code></pre></td></tr></table></figure><ol><li>å®‰è£…docker</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y yum-utils device-mapper-persistent-data lvm2<br>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br>yum makecache fast<br>yum -y install docker-ce<br>systemdctl start docker<br><br></code></pre></td></tr></table></figure><ol start="2"><li>åˆ¤æ–­å½“å‰ docker ç¯å¢ƒä¸­æ˜¯å¦å·²æœ‰ buildx</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker --<span class="hljs-built_in">help</span> | grep buildx || <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Buildx not installed&quot;</span><br>docker buildx version<br>github.com/docker/buildx v0.10.2 00ed17d<br><br></code></pre></td></tr></table></figure><ol start="3"><li>å¼€å¯å¤šå¹³å°æ„å»º</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run --privileged --<span class="hljs-built_in">rm</span> tonistiigi/binfmt --install all <span class="hljs-comment"># all é€‰é¡¹ æ˜¯å…¨å¹³å°.</span><br>&#123;<br>  <span class="hljs-string">&quot;supported&quot;</span>: [<br>    <span class="hljs-string">&quot;linux/amd64&quot;</span>,<br>    <span class="hljs-string">&quot;linux/arm64&quot;</span>,<br>    <span class="hljs-string">&quot;linux/riscv64&quot;</span>,<br>    <span class="hljs-string">&quot;linux/ppc64le&quot;</span>,<br>    <span class="hljs-string">&quot;linux/s390x&quot;</span>,<br>    <span class="hljs-string">&quot;linux/386&quot;</span>,<br>    <span class="hljs-string">&quot;linux/mips64le&quot;</span>,<br>    <span class="hljs-string">&quot;linux/mips64&quot;</span>,<br>    <span class="hljs-string">&quot;linux/arm/v7&quot;</span>,<br>    <span class="hljs-string">&quot;linux/arm/v6&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;emulators&quot;</span>: [<br>    <span class="hljs-string">&quot;qemu-aarch64&quot;</span>,<br>    <span class="hljs-string">&quot;qemu-arm&quot;</span>,<br>    <span class="hljs-string">&quot;qemu-mips64&quot;</span>,<br>    <span class="hljs-string">&quot;qemu-mips64el&quot;</span>,<br>    <span class="hljs-string">&quot;qemu-ppc64le&quot;</span>,<br>    <span class="hljs-string">&quot;qemu-riscv64&quot;</span>,<br>    <span class="hljs-string">&quot;qemu-s390x&quot;</span><br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>åˆæ¬¡æ„å»ºæŠ¥é”™</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æŠ¥é”™ä¿¡æ¯: multiple platforms feature is currently not supported for docker driver</span><br><br>docker buildx create --name mybuilder <br><br>docker buildx use mybuilder<br></code></pre></td></tr></table></figure><ol start="5"><li>buildxæµ‹è¯•</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºdockerfile</span><br><span class="hljs-built_in">cat</span> &gt; Dockerfile &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">FROM --platform=$TARGETPLATFORM alpine</span><br><span class="hljs-string">RUN uname -a &gt; /os.txt</span><br><span class="hljs-string">CMD cat /os.txt</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-comment"># docker login ç™»å½• dockerhub</span><br><br><span class="hljs-comment"># å¼€å§‹æ„å»º, --push å°†æ„å»ºå¥½çš„é•œåƒæ¨é€åˆ°dockerhub.</span><br>docker buildx build --platform linux/amd64,linux/arm64/v8 -t caoye126/alpine-multi-platform . --push<br><br>docker images<br>REPOSITORY          TAG               IMAGE ID       CREATED         SIZE<br>tonistiigi/binfmt   latest            fac5f9edad96   15 months ago   35.3MB<br>moby/buildkit       buildx-stable-1   19340e24de14   15 months ago   144MB<br><br>docker images<br>REPOSITORY          TAG               IMAGE ID       CREATED         SIZE<br>tonistiigi/binfmt   latest            fac5f9edad96   15 months ago   35.3MB<br>moby/buildkit       buildx-stable-1   19340e24de14   15 months ago   144MB<br><br><span class="hljs-comment"># è¿™æ—¶æŸ¥çœ‹æœ¬åœ°images æ˜¯çœ‹ä¸åˆ° åˆšåˆšæ„å»ºçš„ é•œåƒçš„ã€‚åªæœ‰moby/buildkit è¿™ä¸ªã€‚</span><br><br><span class="hljs-comment"># æŸ¥çœ‹é•œåƒä¿¡æ¯</span><br>docker buildx imagetools inspect caoye126/alpine-multi-platform<br>Name:      docker.io/caoye126/alpine-multi-platform:latest<br>MediaType: application/vnd.docker.distribution.manifest.list.v2+json<br>Digest:    sha256:4ea7e4bb49b950673d74d4a82d3fb8330568b6f02e3469e03af3f715a6143174<br>           <br>Manifests: <br>  Name:      docker.io/caoye126/alpine-multi-platform:latest@sha256:74ebe4a08c7b33c4fcf9fb95a5e61ee69fd843fad0af290b6db56f92744d48ea<br>  MediaType: application/vnd.docker.distribution.manifest.v2+json<br>  Platform:  linux/amd64<br>             <br>  Name:      docker.io/caoye126/alpine-multi-platform:latest@sha256:9d3409a852cc36258c1e4716c7adb32b00faab5810b49701518a51e9cab7b3a0<br>  MediaType: application/vnd.docker.distribution.manifest.v2+json<br>  Platform:  linux/arm64<br><br><span class="hljs-comment"># åˆ°dockerhub æŸ¥çœ‹ å·²ç»æœ‰é•œåƒäº†</span><br><span class="hljs-comment"># åˆ†åˆ«åˆ°x86 å’Œarm64 æœºå™¨ä¸Š pull åˆšåˆšåˆ°é•œåƒã€‚</span><br><br><span class="hljs-comment"># x86_64</span><br>docker run --<span class="hljs-built_in">rm</span> caoye126/alpine-multi-platform<br>Unable to find image <span class="hljs-string">&#x27;caoye126/alpine-multi-platform:latest&#x27;</span> locally<br>latest: Pulling from caoye126/alpine-multi-platform<br>63b65145d645: Pull complete <br>0e30a703e096: Pull complete <br>Digest: sha256:4ea7e4bb49b950673d74d4a82d3fb8330568b6f02e3469e03af3f715a6143174<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> caoye126/alpine-multi-platform:latest<br>Linux buildkitsandbox 4.19.113-14.nfs4.x86_64 <span class="hljs-comment">#1 SMP Wed Jul 28 19:53:18 CST 2021 x86_64 Linux</span><br><br><span class="hljs-comment"># arm64</span><br><br>docker run --<span class="hljs-built_in">rm</span> caoye126/alpine-multi-platform<br>Unable to find image <span class="hljs-string">&#x27;caoye126/alpine-multi-platform:latest&#x27;</span> locally<br>latest: Pulling from caoye126/alpine-multi-platform<br>af6eaf76a39c: Already exists <br>20365c33e862: Pull complete <br>Digest: sha256:4ea7e4bb49b950673d74d4a82d3fb8330568b6f02e3469e03af3f715a6143174<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> caoye126/alpine-multi-platform:latest<br>Linux buildkitsandbox 4.19.113-14.nfs4.x86_64 <span class="hljs-comment">#1 SMP Wed Jul 28 19:53:18 CST 2021 aarch64 Linux</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>buildx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo-æ­å»º-github.io-ä¸ªäººåšå®¢</title>
    <link href="/2023/03/13/hexo-%E6%90%AD%E5%BB%BA-github-io-%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
    <url>/2023/03/13/hexo-%E6%90%AD%E5%BB%BA-github-io-%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<p>github.io å¯ä»¥æ­å»ºä¸ªäººå…è´¹åšå®¢ï¼Œæ—¢èƒ½å±•ç¤ºä¸ªäººçš„å°ç«™ï¼Œåˆèƒ½åšè®°å½•ï¼Œå…»æˆå¥½ä¹ æƒ¯ã€‚<br>æœ¬äººæ‰€ç¤ºç¯å¢ƒä¸ºwin10+vscode+wsl</p><p>ä¸€.ç¯å¢ƒå‡†å¤‡<br>1ã€wsl<br>win10ä¸‹çš„wslä½œä¸ºæ—¥å¸¸å¼€å‘ç¯å¢ƒéå¸¸å¥½ç”¨ï¼Œå…·ä½“è¯·è‡ªè¡Œgogleã€‚<br>2ã€git<br>åœ¨wslçš„è™šæ‹Ÿcentos7ä¸‹å®‰è£…gitã€‚<br>3ã€node.js<br>centos7ä¸‹å®‰è£…<br>è¯¥è„šæœ¬ä¼šå°†NodeSourceç­¾åå¯†é’¥æ·»åŠ åˆ°æ‚¨çš„ç³»ç»Ÿï¼Œåˆ›å»ºyumå‚¨å­˜åº“æ–‡ä»¶ï¼Œå®‰è£…æ‰€æœ‰å¿…éœ€çš„è½¯ä»¶åŒ…ï¼Œå¹¶åˆ·æ–°yumç¼“å­˜ã€‚<br>å¦‚æœæ‚¨éœ€è¦å¦ä¸€ä¸ªNode.jsç‰ˆæœ¬ï¼Œ æ¯”å¦‚14.xï¼Œå°†setup_16.xæ›´æ”¹ä¸ºsetup_14.x</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -fsSL https://rpm.nodesource.com/setup_16.x | sudo bash -<br><br>yum install -y nodejs<br><br>node --version<br>npm --version<br></code></pre></td></tr></table></figure><p>äºŒ.hexoå®‰è£…éƒ¨ç½²</p><ol><li>å®‰è£…hexo</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install -g hexo-cli<br>hexo init hexo-blog <span class="hljs-comment">#åˆ›å»ºç›®å½•&lt;hexo-blog&gt;å¹¶åˆå§‹åŒ–</span><br><span class="hljs-built_in">cd</span> hexo-blog<br>npm install<br><br></code></pre></td></tr></table></figure><ol start="2"><li>æµ‹è¯•hexo</li></ol><p>å¦‚æœå¯åŠ¨è¿‡ç¨‹ä¸­æ²¡æœ‰æŠ¥é”™ï¼Œæ­¤æ—¶å¯ä»¥ç”¨æµè§ˆå™¨è®¿é—® <a href="http://localhost:4000/">http://localhost:4000/</a> ï¼Œä¼šå‡ºç°ä¸€ä¸ªHello Worldçš„åšå®¢é¡µé¢ï¼Œhexoä½¿ç”¨çš„é»˜è®¤ä¸»é¢˜æ˜¯landscapeï¼Œè€Œä¸”æ­¤æ—¶çš„æœåŠ¡æ˜¯æœ¬åœ°å¯åŠ¨çš„ï¼Œåˆ«äººå¹¶ä¸èƒ½çœ‹åˆ°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo generate <span class="hljs-comment">#ç”Ÿæˆé™æ€æ–‡ä»¶</span><br>hexo server <span class="hljs-comment">#å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨,ç”¨äºæœ¬åœ°è°ƒè¯•.</span><br><br></code></pre></td></tr></table></figure><ol start="3"><li>github è®¾å®š</li></ol><p>è¿›å…¥GitHubå®˜ç½‘ï¼Œå®˜ç½‘åœ°å€ï¼šÂ <a href="https://github.com/">https://github.com</a> ï¼Œç™»å…¥è‡ªå·±çš„è´¦å·ï¼Œæ–°å»ºä¸€ä¸ªä»“åº“ï¼Œ<br>è¿™é‡Œ caoye126 å¯ä»¥è‡ªå®šä¹‰ï¼Œç»“å°¾ä¸€å®šè¦æ˜¯.github.ioÂ , caoye126.github.io<br><a href="https://caoye126.github.io/">https://caoye126.github.io</a> ,è¿™ä¸ªå°†ä¼šæ˜¯éƒ¨ç½²å¥½ä¹‹åè®¿é—®çš„åŸŸå,é…ç½®å¥½ä¹‹åç‚¹å‡»Create repositoryå³å¯ä»¥åˆ›å»ºå¥½ä»“åº“ï¼Œå»ºå¥½ä»“åº“ä¹‹åï¼ŒæŠŠä»“åº“å…‹éš†åˆ°æœ¬åœ°ï¼Œç„¶åæŠŠæ­å»ºå¥½çš„åšå®¢é¡¹ç›®å¤åˆ¶åˆ°å½“å‰çš„ä»“åº“ä¸‹é¢ã€‚</p><ol start="4"><li>æ›´æ¢æ–°ä¸»é¢˜</li></ol><p>æœ¬äººç”¨çš„ ä¸»é¢˜ æ˜¯ fluid.<br>å…·ä½“åœ°å€: <a href="https://github.com/fluid-dev/hexo-theme-fluid/releases">https://github.com/fluid-dev/hexo-theme-fluid/releases</a><br>å°†æœ€æ–°ç‰ˆæœ¬ä¸‹è½½åˆ° themes ç›®å½•ä¸‹,å¹¶å°† release ç›®å½•æ”¹ä¸º fluid</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">pwd</span>                                                                                                                                                         caoye126.github.io<br>/mnt/d/hexo-blog<br><br> 2023-03-13 15:31:56 âŒš  DESKTOP-RCTTT1C <span class="hljs-keyword">in</span> /mnt/d/hexo-blog<br>â—‹ â†’ ll themes/<br>total 0<br>drwxrwxrwx 1 root root 512 Mar 11 15:20 .<br>drwxrwxrwx 1 root root 512 Mar 11 17:48 ..<br>drwxrwxrwx 1 root root 512 Dec 13 21:12 fluid<br>-rwxrwxrwx 1 root root   0 Mar 11 15:04 .gitkeep<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¿®æ”¹ _config.yml å¯¹åº”é…ç½®é¡¹ç›®</span><br><span class="hljs-built_in">cd</span> hexo-blog<br>vim _config.yml<br>theme: fluid  <span class="hljs-comment"># æŒ‡å®šä¸»é¢˜</span><br>language: zh-CN  <span class="hljs-comment"># æŒ‡å®šè¯­è¨€</span><br><br></code></pre></td></tr></table></figure><ol start="5"><li>åˆ›å»ºå…³äºé¡µ</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo new page about<br>åˆ›å»ºæˆåŠŸåï¼Œç¼–è¾‘åšå®¢ç›®å½•ä¸‹ /source/about/index.mdï¼Œæ·»åŠ  layout å±æ€§ã€‚<br>---<br>title: about<br><span class="hljs-built_in">date</span>: 2020-02-23 19:20:33<br>layout: about<br>---<br><br>è¿™é‡Œå†™å…³äºé¡µçš„æ­£æ–‡ï¼Œæ”¯æŒ Markdown, HTML<br><br></code></pre></td></tr></table></figure><ol start="6"><li>å¼€å§‹å†™ç¬¬ä¸€ç¯‡æ–‡ç« </li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo new hexo-æ­å»º-github.io-ä¸ªäººåšå®¢<br><br></code></pre></td></tr></table></figure><p>åœ¨vscode ç¼–è¾‘ source&#x2F;_posts&#x2F;hexo-æ­å»º-github-io-ä¸ªäººåšå®¢.md</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è¿™é‡Œæ˜¯ åšå®¢çš„å±æ€§,å¯ä»¥å®šäº å½’ç±» å’Œ æ ‡ç­¾.</span><br>---<br>title: hexo-æ­å»º-github.io-ä¸ªäººåšå®¢<br><span class="hljs-built_in">date</span>: 2023-03-13 10:09:32<br>tags: [hexo,github]<br>category: hexo<br>---<br><span class="hljs-comment"># ä¸‹é¢å¼€å§‹å†™æ–‡ç« æ­£æ–‡.</span><br><br></code></pre></td></tr></table></figure><ol start="7"><li>è®¾ç½®github ä»“åº“ å¯¹åº”è®¾ç½®</li></ol><p>_config.yml ä¸­</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">deploy:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">git</span><br>  <span class="hljs-attr">repo:</span> <span class="hljs-string">git@github.com:caoye126/caoye126.github.io.git</span><br>  <span class="hljs-attr">brach:</span> <span class="hljs-string">master</span><br><br></code></pre></td></tr></table></figure><ol start="8"><li>github ç»‘å®šwslä¸‹çš„ ssh å…¬é’¥</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/root/.ssh/id_rsa.pub <span class="hljs-comment">#å†…å®¹ å¡«åˆ°githubä¸ªäººè´¦æˆ· settingé‡Œ ssh key å¤„. </span><br></code></pre></td></tr></table></figure><ol start="9"><li>hexo å®‰è£…gitæ’ä»¶</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install hexo-deployer-git<br><br></code></pre></td></tr></table></figure><ol start="9"><li>æ¨é€æ–‡ç« </li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo g<br>hexo d<br></code></pre></td></tr></table></figure><ol start="9"><li>è®¿é—®è‡ªå·±çš„ä¸ªäººåšå®¢</li></ol><p>ä¸ªäººä¸»é¡µ: <a href="https://caoye126.github.io/">https://caoye126.github.io/</a></p>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
      <tag>github</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ansible-errorså¤„ç†æœºåˆ¶</title>
    <link href="/2023/03/11/ansible-errors%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/03/11/ansible-errors%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<p>ansibleæ¡ä»¶errorså¤„ç†æœºåˆ¶</p><p>ä¸€ã€æ¦‚è¿°<br>å½“Ansibleä»ä¸€ä¸ªå‘½ä»¤æ¥æ”¶åˆ°ä¸€ä¸ªéé›¶çš„è¿”å›ç æˆ–ä»ä¸€ä¸ªæ¨¡å—æ¥æ”¶åˆ°ä¸€ä¸ªæ•…éšœæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒä¼šåœæ­¢åœ¨è¯¥ä¸»æœºä¸Šæ‰§è¡Œï¼Œå¹¶åœ¨å…¶ä»–ä¸»æœºä¸Šç»§ç»­æ‰§è¡Œã€‚</p><p>ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¸åŒçš„è¡Œä¸ºã€‚æœ‰æ—¶ï¼Œéé›¶è¿”å›ç è¡¨ç¤ºæˆåŠŸã€‚æœ‰æ—¶ï¼Œæ‚¨å¸Œæœ›ä¸€å°ä¸»æœºä¸Šçš„æ•…éšœåœæ­¢æ‰€æœ‰ä¸»æœºä¸Šçš„æ‰§è¡Œã€‚Ansibleæä¾›äº†<br>å¤„ç†è¿™äº›æƒ…å†µçš„å·¥å…·å’Œè®¾ç½®ï¼Œå¹¶å¸®åŠ©æ‚¨è·å¾—æ‰€éœ€çš„è¡Œä¸ºã€è¾“å‡ºå’ŒæŠ¥å‘Šã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">Ignoring failed commands å¿½ç•¥å‘½ä»¤å¤±è´¥<br>Ignoring unreachable host errors å¿½ç•¥ä¸å¯è¾¾çš„ä¸»æœºé”™è¯¯<br>Resetting unreachable hosts é‡æ–°è®¾ç½®ä¸å¯åˆ°è¾¾çš„ä¸»æœº<br>Handlers and failure å¤„ç†ç¨‹åºå’Œå¤±è´¥<br>Defining failure å®šä¹‰å¤±è´¥<br>Defining â€œchangedâ€å®šä¹‰â€œæ”¹å˜â€<br>Ensuring success for command and shell ç¡®ä¿æˆåŠŸçš„å‘½ä»¤å’Œshell<br>Aborting a play on all hosts åœ¨æ‰€æœ‰ä¸»æœºä¸Šç»ˆæ­¢ä¸€ä¸ªplay<br>Aborting on the first error: any_errors_fatal åœ¨ç¬¬ä¸€ä¸ªé”™è¯¯æ—¶ä¸­æ­¢:any_errors_fatal<br>Setting a maximum failure percentage è®¾ç½®æœ€å¤§å¤±è´¥ç™¾åˆ†æ¯”<br>Controlling errors in blocks åœ¨blocksåŒºå—ä¸Šæ§åˆ¶errors<br></code></pre></td></tr></table></figure><p>äºŒã€é…ç½®</p><p>1ã€å¿½ç•¥å‘½ä»¤å¤±è´¥<br>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸»æœºä¸Šçš„ä»»åŠ¡å¤±è´¥æ—¶ï¼ŒAnsibleä¼šåœæ­¢æ‰§è¡Œè¯¥ä¸»æœºä¸Šçš„ä»»åŠ¡ã€‚ä½¿ç”¨ignore_errorsï¼Œå³ä½¿ç¢°åˆ°ä»»åŠ¡å¤±è´¥ï¼Œä»ä¼šç»§ç»­ä¸‹é¢çš„ä»»åŠ¡:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Do</span> <span class="hljs-string">not</span> <span class="hljs-string">count</span> <span class="hljs-string">this</span> <span class="hljs-string">as</span> <span class="hljs-string">a</span> <span class="hljs-string">failure</span><br>  <span class="hljs-attr">shell:</span> <span class="hljs-string">/bin/false</span><br>  <span class="hljs-attr">ignore_errors:</span> <span class="hljs-literal">yes</span><br><span class="hljs-string">ignore_errorsæŒ‡ä»¤ä»…åœ¨ä»»åŠ¡èƒ½å¤Ÿè¿è¡Œå¹¶è¿”å›å€¼ä¸ºfailedæ—¶æœ‰æ•ˆã€‚å®ƒä¸ä¼šä½¿Ansibleå¿½ç•¥æœªå®šä¹‰çš„å˜é‡é”™è¯¯ã€è¿æ¥å¤±è´¥ã€æ‰§è¡Œé—®é¢˜(ä¾‹å¦‚ï¼Œä¸¢å¤±åŒ…)æˆ–è¯­æ³•é”™è¯¯ã€‚</span><br></code></pre></td></tr></table></figure><p>2ã€å¿½ç•¥ä¸å¯è¾¾çš„ä¸»æœºé”™è¯¯</p><p>æ‚¨å¯ä»¥ä½¿ç”¨ignore_unreachableå…³é”®å­—å¿½ç•¥ç”±äºä¸»æœºå®ä¾‹ä¸ºUNREACHABLE è€Œå¯¼è‡´çš„ä»»åŠ¡å¤±è´¥ã€‚Ansibleå¿½ç•¥ä»»åŠ¡é”™è¯¯ï¼Œä½†ç»§ç»­å¯¹ä¸å¯è¾¾çš„ä¸»æœºæ‰§è¡Œåç»­çš„ä»»åŠ¡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><br><span class="hljs-number">1</span><span class="hljs-string">ï¼‰åœ¨taskä¸­ä½¿ç”¨ï¼š</span><br><br><span class="hljs-comment"># task1ä¸­å¿½ç•¥ä¸å¯è¾¾çš„ä¸»æœºç»§ç»­æ‰§è¡Œï¼›task2ä¸å¿½ç•¥ä¸å¯è¾¾ä¸»æœºï¼Œä¸”è¯¥ä¸å¯è¾¾ä¸»æœºç»ˆæ­¢æ‰§è¡Œ</span><br><br><span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task1</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/true</span><br>      <span class="hljs-attr">ignore_unreachable:</span> <span class="hljs-literal">yes</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task2</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/true</span><br><br><span class="hljs-number">2</span><span class="hljs-string">ï¼‰åœ¨playä¸­ä½¿ç”¨ï¼š</span><br><br><span class="hljs-comment"># æ‰€æœ‰taskså¿½ç•¥ä¸å¯è¾¾çš„ä¸»æœºï¼Œtask1ï¼šå¿½ç•¥ä¸å¯è¾¾ä¸»æœºç»§ç»­æ‰§è¡Œplayï¼Œtasks2ï¼šä¸å¿½ç•¥ä¸å¯è¾¾ä¸»æœºä¸”è¯¥ä¸å¯è¾¾ä¸»æœºç»ˆæ­¢æ‰§è¡Œ</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">ignore_unreachable:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task1</span><br>       <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/true</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task2</span><br>       <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/true</span><br>       <span class="hljs-attr">ignore_unreachable:</span> <span class="hljs-literal">no</span><br></code></pre></td></tr></table></figure><p>3ã€é‡æ–°è®¾ç½®ä¸å¯åˆ°è¾¾çš„ä¸»æœº</p><p>å¦‚æœAnsibleæ— æ³•è¿æ¥åˆ°æŸä¸ªä¸»æœºï¼Œå®ƒä¼šå°†è¯¥ä¸»æœºæ ‡è®°ä¸ºunreachableï¼Œå¹¶å°†å…¶ä»è¿è¡Œçš„æ´»åŠ¨ä¸»æœºåˆ—è¡¨ä¸­åˆ é™¤ã€‚<br>æ‚¨å¯ä»¥ä½¿ç”¨meta: clear_host_errorsé‡æ–°æ¿€æ´»æ‰€æœ‰ä¸»æœºï¼Œä»¥ä¾¿åç»­ä»»åŠ¡å¯ä»¥å°è¯•å†æ¬¡è®¿é—®å®ƒä»¬ã€‚</p><p>4ã€å¤„ç†ç¨‹åºå’Œå¤±è´¥</p><p>å¦‚æœä¸€ä¸ªä»»åŠ¡é€šçŸ¥äº†ä¸€ä¸ªhandler ï¼Œä½†å¦ä¸€ä¸ªä»»åŠ¡åœ¨ç¨åçš„è¿è¡Œä¸­å¤±è´¥ï¼Œé»˜è®¤æƒ…å†µä¸‹handler ä¸ä¼šåœ¨è¯¥ä¸»æœºä¸Šè¿è¡Œï¼Œè¿™å¯èƒ½ä¼šä½¿ä¸»æœºå¤„äºæ„å¤–çŠ¶æ€ã€‚<br>ä¾‹å¦‚ï¼Œä¸€ä¸ªä»»åŠ¡å¯ä»¥æ›´æ–°é…ç½®æ–‡ä»¶å¹¶é€šçŸ¥handler é‡æ–°å¯åŠ¨æŸäº›æœåŠ¡ã€‚å¦‚æœåŒä¸€taskä¸­ç¨åçš„ä»»åŠ¡å¤±è´¥ï¼Œåˆ™å¯èƒ½åªä¼šæ›´æ”¹é…ç½®æ–‡ä»¶ï¼Œè€Œä¸ä¼šé‡æ–°å¯åŠ¨æœåŠ¡ã€‚</p><p>ä½ å¯ä»¥é€šè¿‡â€“force-handlerså‘½ä»¤è¡Œé€‰é¡¹æ¥æ”¹å˜è¿™ç§è¡Œä¸ºï¼Œæ–¹æ³•æ˜¯åœ¨playä¸­åŒ…å«force_handlers: Trueï¼Œæˆ–è€…åœ¨ansible.cfgä¸­æ·»åŠ force_handlers &#x3D; Trueã€‚<br>å½“handler è¢«å¼ºåˆ¶æ‰§è¡Œæ—¶ï¼ŒAnsibleå°†åœ¨æ‰€æœ‰ä¸»æœºä¸Šè¿è¡Œæ‰€æœ‰é€šçŸ¥çš„handler ï¼Œç”šè‡³æ˜¯ä»»åŠ¡å¤±è´¥çš„ä¸»æœºã€‚<br>(æ³¨æ„ï¼ŒæŸäº›é”™è¯¯ä»ç„¶ä¼šé˜»æ­¢å¤„ç†ç¨‹åºè¿è¡Œï¼Œæ¯”å¦‚ä¸»æœºå˜å¾—ä¸å¯è®¿é—®ã€‚ï¼‰</p><p>5ã€å®šä¹‰å¤±è´¥</p><p>Ansibleå…è®¸ä½ åœ¨æ¯ä¸ªä»»åŠ¡ä¸­ä½¿ç”¨failed_whenæ¡ä»¶å®šä¹‰â€œfailureâ€çš„å«ä¹‰ã€‚<br>å¤šä¸ªfailed_whenæ¡ä»¶çš„åˆ—è¡¨ä½¿ç”¨éšå¼çš„andè¿æ¥ï¼Œè¿™æ„å‘³ç€ä»»åŠ¡åªæœ‰åœ¨æ»¡è¶³æ‰€æœ‰æ¡ä»¶æ—¶æ‰ä¼šå¤±è´¥ã€‚å¦‚æœå¸Œæœ›åœ¨æ»¡è¶³ä»»ä½•æ¡ä»¶æ—¶è§¦å‘å¤±è´¥ï¼Œåˆ™å¿…é¡»ä½¿ç”¨<br>æ˜¾å¼æˆ–æ“ä½œç¬¦åœ¨å­—ç¬¦ä¸²ä¸­å®šä¹‰æ¡ä»¶ã€‚</p><p>æ‚¨å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤çš„è¾“å‡ºä¸­æœç´¢ä¸€ä¸ªå•è¯æˆ–çŸ­è¯­æ¥æ£€æŸ¥æ˜¯å¦å¤±è´¥:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Fail</span> <span class="hljs-string">task</span> <span class="hljs-string">when</span> <span class="hljs-string">the</span> <span class="hljs-string">command</span> <span class="hljs-string">error</span> <span class="hljs-string">output</span> <span class="hljs-string">prints</span> <span class="hljs-string">FAILED</span><br>  <span class="hljs-attr">command:</span> <span class="hljs-string">/usr/bin/example-command</span> <span class="hljs-string">-x</span> <span class="hljs-string">-y</span> <span class="hljs-string">-z</span><br>  <span class="hljs-attr">register:</span> <span class="hljs-string">command_result</span><br>  <span class="hljs-attr">failed_when:</span> <span class="hljs-string">&quot;&#x27;FAILED&#x27; in command_result.stderr&quot;</span><br><br><span class="hljs-string">åŸºäºè¿”å›ç ï¼š</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Fail</span> <span class="hljs-string">task</span> <span class="hljs-string">when</span> <span class="hljs-string">both</span> <span class="hljs-string">files</span> <span class="hljs-string">are</span> <span class="hljs-string">identical</span><br>  <span class="hljs-attr">raw:</span> <span class="hljs-string">diff</span> <span class="hljs-string">foo/file1</span> <span class="hljs-string">bar/file2</span><br>  <span class="hljs-attr">register:</span> <span class="hljs-string">diff_cmd</span><br>  <span class="hljs-attr">failed_when:</span> <span class="hljs-string">diff_cmd.rc</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span> <span class="hljs-string">or</span> <span class="hljs-string">diff_cmd.rc</span> <span class="hljs-string">&gt;=</span> <span class="hljs-number">2</span><br><br><br><span class="hljs-string">è¿˜å¯ä»¥ç»„åˆå¤šä¸ªå¤±è´¥æ¡ä»¶ã€‚å¦‚æœä¸¤ä¸ªæ¡ä»¶éƒ½ä¸ºçœŸï¼Œè¯¥ä»»åŠ¡å°†å¤±è´¥:</span><br><br><span class="hljs-comment"># æ£€æŸ¥æŸä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">if</span> <span class="hljs-string">a</span> <span class="hljs-string">file</span> <span class="hljs-string">exists</span> <span class="hljs-string">in</span> <span class="hljs-string">temp</span> <span class="hljs-string">and</span> <span class="hljs-string">fail</span> <span class="hljs-string">task</span> <span class="hljs-string">if</span> <span class="hljs-string">it</span> <span class="hljs-string">does</span><br>  <span class="hljs-attr">command:</span> <span class="hljs-string">ls</span> <span class="hljs-string">/tmp/file1</span><br>  <span class="hljs-attr">register:</span> <span class="hljs-string">result</span><br>  <span class="hljs-attr">failed_when:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">result.rc</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&quot;No such&quot; not in result.stdout&#x27;</span><br>  <br><span class="hljs-comment"># å¦‚æœä½ æƒ³è®©ä»»åŠ¡åœ¨åªæ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶æ—¶å¤±è´¥ï¼Œå°†failed_whençš„å®šä¹‰ä¿®æ”¹ä¸º</span><br><br>  <span class="hljs-attr">failed_when:</span> <span class="hljs-string">result.rc</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span> <span class="hljs-string">or</span> <span class="hljs-string">&quot;No such&quot;</span> <span class="hljs-string">not</span> <span class="hljs-string">in</span> <span class="hljs-string">result.stdout</span><br><span class="hljs-string">å¦‚æœæœ‰å¤ªå¤šçš„æ¡ä»¶ä¸èƒ½æ•´é½åœ°æ”¾åœ¨ä¸€è¡Œä¸­ï¼Œå¯ä»¥ä½¿ç”¨&quot;&gt;&quot;å°†å…¶åˆ†å‰²ä¸ºå¤šè¡Œyamlå€¼:</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">example</span> <span class="hljs-string">of</span> <span class="hljs-string">many</span> <span class="hljs-string">failed_when</span> <span class="hljs-string">conditions</span> <span class="hljs-string">with</span> <span class="hljs-string">OR</span><br>  <span class="hljs-attr">shell:</span> <span class="hljs-string">&quot;./myBinary&quot;</span><br>  <span class="hljs-attr">register:</span> <span class="hljs-string">ret</span><br>  <span class="hljs-attr">failed_when:</span> <span class="hljs-string">&gt;</span><br><span class="hljs-string">    (&quot;No such file or directory&quot; in ret.stdout) or</span><br><span class="hljs-string">    (ret.stderr != &#x27;&#x27;) or</span><br><span class="hljs-string">    (ret.rc == 10)</span><br></code></pre></td></tr></table></figure><p>6ã€å®šä¹‰â€æ”¹å˜â€</p><p>Ansibleå…è®¸ä½ ä½¿ç”¨æ¡ä»¶changed_whenæ¥å®šä¹‰ä¸€ä¸ªç‰¹å®šçš„ä»»åŠ¡ä½•æ—¶â€œchangedâ€äº†ä¸€ä¸ªè¿œç¨‹èŠ‚ç‚¹ã€‚è¿™è®©æ‚¨å¯ä»¥æ ¹æ®è¿”å›ä»£ç æˆ–è¾“å‡ºæ¥å†³å®šæ˜¯å¦åº”è¯¥åœ¨Ansibleç»Ÿè®¡ä¸­æŠ¥å‘Šæ›´æ”¹ï¼Œä»¥åŠæ˜¯å¦åº”è¯¥è§¦å‘å¤„ç†ç¨‹åºã€‚<br>ä¸Ansibleä¸­çš„æ‰€æœ‰æ¡ä»¶ä¸€æ ·ï¼Œå¤šä¸ªchanged_whenæ¡ä»¶çš„åˆ—è¡¨ä½¿ç”¨éšå¼çš„â€œandâ€è¿æ¥ï¼Œè¿™æ„å‘³ç€ä»»åŠ¡åªåœ¨æ»¡è¶³æ‰€æœ‰æ¡ä»¶æ—¶æŠ¥å‘Šæ›´æ”¹ã€‚</p><p>å¦‚æœå¸Œæœ›åœ¨æ»¡è¶³ä»»ä½•æ¡ä»¶æ—¶æŠ¥å‘Šæ›´æ”¹ï¼Œåˆ™å¿…é¡»ä½¿ç”¨æ˜¾å¼â€œorâ€œåœ¨å­—ç¬¦ä¸²ä¸­å®šä¹‰æ¡ä»¶ã€‚ä¾‹å¦‚:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Report</span> <span class="hljs-string">&#x27;changed&#x27;</span> <span class="hljs-string">when</span> <span class="hljs-string">the</span> <span class="hljs-string">return</span> <span class="hljs-string">code</span> <span class="hljs-string">is</span> <span class="hljs-string">not</span> <span class="hljs-string">equal</span> <span class="hljs-string">to</span> <span class="hljs-number">2</span><br>    <span class="hljs-attr">shell:</span> <span class="hljs-string">/usr/bin/billybass</span> <span class="hljs-string">--mode=&quot;take</span> <span class="hljs-string">me</span> <span class="hljs-string">to</span> <span class="hljs-string">the</span> <span class="hljs-string">river&quot;</span><br>    <span class="hljs-attr">register:</span> <span class="hljs-string">bass_result</span><br>    <span class="hljs-attr">changed_when:</span> <span class="hljs-string">&quot;bass_result.rc != 2&quot;</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">This</span> <span class="hljs-string">will</span> <span class="hljs-string">never</span> <span class="hljs-string">report</span> <span class="hljs-string">&#x27;changed&#x27;</span> <span class="hljs-string">status</span><br>   <span class="hljs-attr">shell:</span> <span class="hljs-string">wall</span> <span class="hljs-string">&#x27;beep&#x27;</span><br>   <span class="hljs-attr">changed_when:</span> <span class="hljs-literal">False</span><br><br><span class="hljs-string">ä½ ä¹Ÿå¯ä»¥ç»„åˆå¤šä¸ªæ¡ä»¶æ¥è¦†ç›–&quot;</span> <span class="hljs-string">changed</span> <span class="hljs-string">&quot;ç»“æœ:</span><br><span class="hljs-string"></span><br><span class="hljs-string">- name: Combine multiple conditions to override &#x27;changed&#x27; result</span><br><span class="hljs-string">  command: /bin/fake_command</span><br><span class="hljs-string">  register: result</span><br><span class="hljs-string">  ignore_errors: True</span><br><span class="hljs-string">  changed_when:</span><br><span class="hljs-string">    -&#x27;&quot;</span><span class="hljs-string">ERROR&quot;</span> <span class="hljs-string">in</span> <span class="hljs-string">result.stderr&#x27;</span><br>    <span class="hljs-string">-result.rc</span> <span class="hljs-string">==</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>7ã€ç¡®ä¿å‘½ä»¤å’ŒshellæˆåŠŸ</p><p>command å’Œshellæ¨¡å—å…³å¿ƒè¿”å›ç ï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰ä¸€ä¸ªæˆåŠŸé€€å‡ºç ä¸ä¸ºé›¶çš„å‘½ä»¤ï¼Œä½ å¯ä»¥è¿™æ ·åš:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><br><span class="hljs-attr">tasks:</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">this</span> <span class="hljs-string">command</span> <span class="hljs-string">and</span> <span class="hljs-string">ignore</span> <span class="hljs-string">the</span> <span class="hljs-string">result</span><br>    <span class="hljs-attr">shell:</span> <span class="hljs-string">/usr/bin/somecommand</span> <span class="hljs-string">||</span> <span class="hljs-string">/bin/true</span><br></code></pre></td></tr></table></figure><p>8ã€åœ¨æ‰€æœ‰ä¸»æœºä¸Šç»ˆæ­¢ä¸€ä¸ªplay</p><p>æœ‰æ—¶ï¼Œæ‚¨å¸Œæœ›å•ä¸ªä¸»æœºæˆ–ä¸€å®šç™¾åˆ†æ¯”çš„ä¸»æœºå‡ºç°failureï¼Œä»è€Œä¸­æ­¢æ‰€æœ‰ä¸»æœºä¸Šçš„æ•´ä¸ªplayã€‚ä½¿ç”¨any_errors_fatalå¯ä»¥åœ¨ç¬¬ä¸€æ¬¡å¤±è´¥å‘ç”Ÿååœæ­¢<br>playæ‰§è¡Œã€‚å¯¹äºæ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨max_fail_percentageåœ¨ç»™å®šç™¾åˆ†æ¯”çš„ä¸»æœºå¤±è´¥åä¸­æ­¢è¿è¡Œã€‚</p><p>åœ¨ç¬¬ä¸€ä¸ªé”™è¯¯æ—¶ä¸­æ­¢ï¼šany_errors_fatal<br>å¦‚æœä½ è®¾ç½®äº†any_errors_fatalå¹¶ä¸”ä¸€ä¸ªä»»åŠ¡è¿”å›äº†ä¸€ä¸ªé”™è¯¯ï¼ŒAnsibleä¼šåœ¨å½“å‰æ‰¹å¤„ç†çš„æ‰€æœ‰ä¸»æœºä¸Šå®Œæˆè‡´å‘½ä»»åŠ¡ï¼Œç„¶ååœæ­¢åœ¨æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œå‰§</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">æœ¬ã€‚åç»­çš„ä»»åŠ¡å’Œå‰§æœ¬ä¸ä¼šè¢«æ‰§è¡Œã€‚ä½ å¯ä»¥åœ¨playæˆ–blockçº§åˆ«è®¾ç½®</span> <span class="hljs-attr">any_errors_fatal:</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">somehosts</span><br>  <span class="hljs-attr">any_errors_fatal:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-string">-myrole</span><br><br><span class="hljs-string">é€šè¿‡å‘å—ä¸­æ·»åŠ ä¸€ä¸ªæ‹¯æ•‘éƒ¨åˆ†ï¼Œå¯ä»¥ä»è‡´å‘½é”™è¯¯ä¸­æ¢å¤è¿è¡Œã€‚</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">somehosts</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">block:</span><br>    <span class="hljs-string">-include_tasks:</span> <span class="hljs-string">mytasks.yml</span><br>  <span class="hljs-attr">any_errors_fatal:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-string">å½“æ‰€æœ‰ä»»åŠ¡å¿…é¡»100%æˆåŠŸæ‰èƒ½ç»§ç»­æ‰§è¡Œå‰§æœ¬æ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åœ¨å¤šä¸ªæ•°æ®ä¸­å¿ƒçš„æœºå™¨ä¸Šè¿è¡Œä¸€ä¸ªæœåŠ¡ï¼Œä½¿ç”¨è´Ÿè½½å¹³è¡¡å™¨å°†æµé‡ä»ç”¨æˆ·ä¼ é€’åˆ°æœåŠ¡ï¼Œé‚£ä¹ˆæ‚¨å¸Œæœ›åœ¨åœæ­¢æœåŠ¡è¿›è¡Œç»´æŠ¤ä¹‹å‰ç¦ç”¨æ‰€æœ‰è´Ÿè½½å¹³è¡¡å™¨ã€‚ä¸ºäº†ç¡®ä¿ä»»åŠ¡ä¸­ä»»ä½•ç¦ç”¨è´Ÿè½½å‡è¡¡å™¨çš„å¤±è´¥éƒ½ä¼šåœæ­¢æ‰€æœ‰å…¶ä»–ä»»åŠ¡:</span><br><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">load_balancers_dc_a</span><br>  <span class="hljs-attr">any_errors_fatal:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Shut</span> <span class="hljs-string">down</span> <span class="hljs-string">datacenter</span> <span class="hljs-string">&#x27;A&#x27;</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/usr/bin/disable-dc</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">frontends_dc_a</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Stop</span> <span class="hljs-string">service</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/usr/bin/stop-software</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Update</span> <span class="hljs-string">software</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/usr/bin/upgrade-software</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">load_balancers_dc_a</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Start</span> <span class="hljs-string">datacenter</span> <span class="hljs-string">&#x27;A&#x27;</span><br>     <span class="hljs-attr">command:</span> <span class="hljs-string">/usr/bin/enable-dc</span><br><br><span class="hljs-string">åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªæœ‰å½“æ‰€æœ‰çš„è´Ÿè½½å‡è¡¡å™¨éƒ½è¢«æˆåŠŸç¦ç”¨æ—¶ï¼ŒAnsibleæ‰ä¼šåœ¨å‰ç«¯å¯åŠ¨è½¯ä»¶å‡çº§ã€‚</span><br><br><span class="hljs-string">è®¾ç½®æœ€å¤§å¤±è´¥ç™¾åˆ†æ¯”ï¼šmax_fail_percentage</span><br><span class="hljs-string">é»˜è®¤æƒ…å†µä¸‹ï¼Œåªè¦æœ‰ä¸»æœºæ²¡æœ‰å‘ç”Ÿæ•…éšœï¼ŒAnsibleå°±ä¼šç»§ç»­æ‰§è¡Œä»»åŠ¡ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¾‹å¦‚åœ¨æ‰§è¡Œæ»šåŠ¨æ›´æ–°æ—¶ï¼Œå½“è¾¾åˆ°ä¸€å®šçš„å¤±è´¥é˜ˆå€¼æ—¶ï¼Œæ‚¨å¯èƒ½æƒ³è¦</span><br><span class="hljs-string">ä¸­æ­¢playã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œä½ å¯ä»¥è®¾ç½®playçš„æœ€å¤§å¤±è´¥ç™¾åˆ†æ¯”:</span><br><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">max_fail_percentage:</span> <span class="hljs-number">30</span><br>  <span class="hljs-attr">serial:</span> <span class="hljs-number">10</span><br><br><span class="hljs-string">max_fail_percentageè®¾ç½®åœ¨ä¸serialä¸€èµ·ä½¿ç”¨æ—¶é€‚ç”¨äºæ¯ä¸ªæ‰¹å¤„ç†ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœç¬¬ä¸€æ‰¹(æˆ–ä»»ä½•ä¸€æ‰¹)æœåŠ¡å™¨ä¸­çš„10ä¸ªæœåŠ¡å™¨ä¸­æœ‰3ä¸ªä»¥</span><br><span class="hljs-string">ä¸Šå¤±è´¥ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„playå°†è¢«ä¸­æ­¢ã€‚</span><br></code></pre></td></tr></table></figure><p>9ã€block</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs less">åœ¨è¯´<span class="hljs-selector-tag">block</span>ç”¨æ³•ä¹‹å‰ï¼Œå…ˆè¯´ä¸€ä¸‹<span class="hljs-selector-tag">ansible</span>çš„<span class="hljs-selector-tag">yaml</span>æ–‡ä»¶ä¸­åˆ¤æ–­çš„ä½¿ç”¨ï¼Œç¬¦åˆ<span class="hljs-keyword">when</span>çš„æ¡ä»¶çš„æ—¶å€™ï¼Œæ‰§è¡Œï¼Œä¸æ»¡è¶³æ¡ä»¶å°±ä¸æ‰§è¡Œï¼Œä¾‹å¦‚ï¼š<br><br>- <span class="hljs-attribute">name</span>: <span class="hljs-keyword">when</span>ç”¨æ³•ä¸¾ä¾‹<br>  <span class="hljs-attribute">hosts</span>: all<br>  <span class="hljs-attribute">tasks</span>:<br>  - <span class="hljs-attribute">name</span>: ä¿®æ”¹æ–‡ä»¶æƒé™<br>      <span class="hljs-attribute">file</span>: src=/root/test.txt.j2 dest=/opt/test.txt mode=<span class="hljs-number">0644</span><br>      <span class="hljs-attribute">when</span>: <span class="hljs-string">&#x27;$USER=root&#x27;</span><br><br>å†æ¥çœ‹blockçš„ä¾‹å­ï¼š<br><br>- <span class="hljs-attribute">name</span>: blockçš„ç”¨æ³•<br>  <span class="hljs-attribute">hosts</span>: node<br>  <span class="hljs-attribute">tasks</span>:<br>  - <span class="hljs-attribute">debug</span>:<br>      <span class="hljs-attribute">msg</span>: <span class="hljs-string">&quot;task1 not in block&quot;</span><br>  - <span class="hljs-attribute">block</span>:<br>    - <span class="hljs-attribute">debug</span>:<br>            <span class="hljs-attribute">msg</span>: <span class="hljs-string">&quot;task2 in block1&quot;</span><br>    - <span class="hljs-attribute">debug</span>:<br>            <span class="hljs-attribute">msg</span>: <span class="hljs-string">&quot;task3 in block1&quot;</span><br>      <span class="hljs-attribute">when</span>: <span class="hljs-number">2</span> &gt; <span class="hljs-number">1</span><br>æ˜¯çš„ï¼Œå½“<span class="hljs-keyword">when</span>çš„åˆ¤æ–­è¯­å¥ä¸€æ ·æ—¶ï¼Œå¯ä»¥å°†ä»»åŠ¡åˆå¹¶ï¼Œå†™èµ·æ¥çœåŠ›ä¸€ç‚¹ã€‚<br>æ­¤å¤–ï¼Œblocké™¤äº†èƒ½å’Œ<span class="hljs-keyword">when</span>ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½ï¼Œå°±æ˜¯<span class="hljs-string">&quot;é”™è¯¯å¤„ç†&quot;</span>åŠŸèƒ½ã€‚<br>ä¸ç”¨blockï¼š<br>- <span class="hljs-attribute">hosts</span>: test<br>  <span class="hljs-attribute">remote_user</span>: root<br>  <span class="hljs-attribute">tasks</span>:<br>  - <span class="hljs-attribute">shell</span>: <span class="hljs-string">&#x27;cat /etc/redhat-release&#x27;</span><br>      <span class="hljs-attribute">register</span>: stdout_info<br>      <span class="hljs-attribute">ignore_errors</span>: true<br>      <span class="hljs-attribute">rescue</span>:<br>  - <span class="hljs-attribute">debug</span>:<br>        <span class="hljs-attribute">msg</span>: <span class="hljs-string">&#x27;I caught an error&#x27;</span><br>      <span class="hljs-attribute">when</span>: <span class="hljs-string">&#x27;stdout_info is failed&#x27;</span><br><br>ä½¿ç”¨blockï¼š<br><br>- <span class="hljs-attribute">hosts</span>: test<br>  <span class="hljs-attribute">remote_user</span>: root<br>  <span class="hljs-attribute">tasks</span>:<br>  - <span class="hljs-attribute">block</span>:<br>    - <span class="hljs-attribute">shell</span>: <span class="hljs-string">&#x27;cat /etc/redhat-release&#x27;</span><br>    <span class="hljs-attribute">rescue</span>:<br>    - <span class="hljs-attribute">debug</span>:<br>          <span class="hljs-attribute">msg</span>: <span class="hljs-string">&#x27;I caught an error&#x27;</span><br></code></pre></td></tr></table></figure><p>å¦‚ä¸Šä¾‹æ‰€ç¤ºï¼Œå®šä¹‰äº†ä¸€ä¸ªblockï¼Œè¿™ä¸ªblockä¸­æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡åœ¨ç›®æ ‡ä¸»æœºä¸­æ‰§è¡Œäº†â€™â€˜cat &#x2F;etc&#x2F;redhat-releaseâ€™â€™â€™å‘½ä»¤ï¼Œé™¤äº†blockå…³é”®å­—<br>ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªå…³é”®å­—rescueï¼Œrescueå…³é”®å­—ä¸blockå…³é”®å­—å¯¹é½ï¼Œrescueçš„å­—é¢æ„æ€ä¸ºâ€æ•‘æ´â€ï¼Œè¡¨ç¤ºå½“blockä¸­çš„ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ—¶ï¼Œä¼šæ‰§è¡Œ<br>rescueä¸­çš„ä»»åŠ¡è¿›è¡Œè¡¥æ•‘ï¼Œå½“ç„¶ï¼Œåœ¨rescueä¸­å®šä¹‰ä»€ä¹ˆä»»åŠ¡ï¼Œæ˜¯ç”±ä½ å†³å®šçš„ã€‚<br>ä¹Ÿå°±æ˜¯è¯´å½“blockä¸­çš„ä»»åŠ¡å‡ºé”™æ—¶ï¼Œä¼šæ‰§è¡Œrescueä¸­çš„ä»»åŠ¡ï¼Œå½“blockä¸­çš„ä»»åŠ¡é¡ºåˆ©æ‰§è¡Œæ—¶ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œrescueä¸­çš„ä»»åŠ¡ã€‚</p><p>ä½ å¯èƒ½ä¼šé—®ï¼Œä½¿ç”¨blockçš„æ–¹æ³•å®Œæˆâ€é”™è¯¯å¤„ç†â€çš„åŠŸèƒ½ï¼Œä¼¼ä¹ä¸ä½¿ç”¨failedçš„æ–¹æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œé™¤äº†ä»£ç ä¼¼ä¹â€ç²¾ç®€â€äº†ä¸€ç‚¹ï¼Œblockè¿˜æœ‰å…¶ä»–ä¼˜åŠ¿<br>ä¹ˆï¼Ÿå…¶å®ï¼Œä½¿ç”¨blockçš„æ–¹å¼è¿˜æ˜¯æœ‰ä¸€å®šä¼˜åŠ¿çš„ï¼Œå½“blockä¸­æœ‰å¤šä¸ªä»»åŠ¡æ—¶ï¼Œè¿™ç§ä¼˜åŠ¿å°±æ¯”è¾ƒæ˜æ˜¾äº†ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">testuser</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">block:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span><br>          <span class="hljs-attr">msg:</span> <span class="hljs-string">&#x27;I execute normally&#x27;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/false</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span><br>          <span class="hljs-attr">msg:</span> <span class="hljs-string">&#x27;I never execute, due to the above task failing&#x27;</span><br>    <span class="hljs-attr">rescue:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span><br>          <span class="hljs-attr">msg:</span> <span class="hljs-string">&#x27;I caught an error&#x27;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/false</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span><br>          <span class="hljs-attr">msg:</span> <span class="hljs-string">&#x27;I also never execute&#x27;</span><br>    <span class="hljs-attr">always:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span><br>          <span class="hljs-attr">msg:</span> <span class="hljs-string">&quot;This always executes&quot;</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-number">2</span><span class="hljs-string">&gt;1</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ansible</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ansible</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ansible-ç®€å•ä½¿ç”¨</title>
    <link href="/2023/03/11/ansible-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/03/11/ansible-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<ol><li><p>å…³é—­ host_key_check<br>host_key_checking &#x3D; False å¯ä»¥é¿å…åˆæ¬¡è¿æ¥ä¸»æœº,æç¤º yes&#x2F;no ?</p></li><li><p>å¼€å¯æ—¥å¿—è®°å½•<br>log_path &#x3D; &#x2F;var&#x2F;log&#x2F;ansible.log</p></li><li><p>æ¨¡å—</p></li></ol><p>creates å­˜åœ¨å°±ä¸æ‰§è¡Œ<br>removes ä¸å­˜åœ¨æ‰æ‰§è¡Œ</p><p>ansible websrv -a â€˜creates&#x3D;&#x2F;etc&#x2F;fstab cat &#x2F;etc&#x2F;fstabâ€™<br>ansible websrv -a â€˜removes&#x3D;&#x2F;etc&#x2F;fstsab cat &#x2F;etc&#x2F;fstabâ€™</p><p>é»˜è®¤çš„command æ¨¡å— ä¸æ”¯æŒä¸€äº›ç‰¹æ®Šçš„å­—ç¬¦ &lt;&gt; | ; &amp; éœ€è¦æ”¹ç”¨shellæ¨¡å—.</p><p>æ¨é€æ‰§è¡Œè„šæœ¬æ¨¡å— script ,å°†ansible ä¸­å¿ƒæœåŠ¡å™¨çš„è„šæœ¬æ¨é€åˆ°ç›®æ ‡æœåŠ¡å™¨,å¹¶æ‰§è¡Œ,è¿”å›ç»“æœ.<br>ansible all -m script -a â€˜&#x2F;root&#x2F;ansible&#x2F;host.shâ€™<br>&#x2F;root&#x2F;ansible&#x2F;host.sh ä¸ºansibleè¦æ‰§è¡Œçš„è„šæœ¬ æ‰€åœ¨ä½ç½®.</p><p>copy æ–‡ä»¶æ¨é€æ¨¡å—<br>ansible 192.168.0.104 -m copy  -a â€˜src&#x3D;&#x2F;etc&#x2F;shadow dest&#x3D;&#x2F;tmp&#x2F; mode&#x3D;644 owner&#x3D;test1 backup&#x3D;yesâ€™</p><p>fetch æ–‡ä»¶ä»å®¢æˆ·ç«¯å›ä¼ åˆ°ç®¡æ§æœåŠ¡å™¨</p><h2 id="æŒ‡å®šhostsæ–‡ä»¶"><a href="#æŒ‡å®šhostsæ–‡ä»¶" class="headerlink" title="æŒ‡å®šhostsæ–‡ä»¶"></a>æŒ‡å®šhostsæ–‡ä»¶</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> ./host<br>172.20.0.21<br>172.20.0.22<br>172.20.0.23<br>172.20.0.24<br><br>ansible -i ./host all -m ping<br></code></pre></td></tr></table></figure><h2 id="æ¨é€sudoè§„åˆ™"><a href="#æ¨é€sudoè§„åˆ™" class="headerlink" title="æ¨é€sudoè§„åˆ™"></a>æ¨é€sudoè§„åˆ™</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible -i ./host_reday_modify_mjq all -m shell -a <span class="hljs-string">&quot;echo &#x27;deploy ALL=(ALL) NOPASSWD: ALL&#x27;  &gt;&gt; /etc/sudoers&quot;</span><br></code></pre></td></tr></table></figure><h2 id="å¤åˆ¶è¿œç¨‹æ–‡ä»¶åˆ°æœ¬åœ°"><a href="#å¤åˆ¶è¿œç¨‹æ–‡ä»¶åˆ°æœ¬åœ°" class="headerlink" title="å¤åˆ¶è¿œç¨‹æ–‡ä»¶åˆ°æœ¬åœ°"></a>å¤åˆ¶è¿œç¨‹æ–‡ä»¶åˆ°æœ¬åœ°</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible -i ./tmp_host all -m fetch -a <span class="hljs-string">&quot;src=/root/kubernetes-server-linux-amd64.tar.gz dest=/opt/ljb/kubernetes-server-linux-amd64.tar.gz&quot;</span><br>ansible -i ./tmp_host all -m fetch -a <span class="hljs-string">&quot;src=/data/ocr-log/fenqi-ocr.2019-06* dest=/opt/ljb/api_log/&quot;</span><br></code></pre></td></tr></table></figure><h2 id="å¤åˆ¶æœ¬åœ°æ–‡ä»¶åˆ°å®¢æˆ·ç«¯"><a href="#å¤åˆ¶æœ¬åœ°æ–‡ä»¶åˆ°å®¢æˆ·ç«¯" class="headerlink" title="å¤åˆ¶æœ¬åœ°æ–‡ä»¶åˆ°å®¢æˆ·ç«¯"></a>å¤åˆ¶æœ¬åœ°æ–‡ä»¶åˆ°å®¢æˆ·ç«¯</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible -i ./tmp_host all -m copy -a <span class="hljs-string">&quot;src=/opt/ljb/kubernetes-server-linux-amd64.tar.gz/172.20.4.40/root/kubernetes-server-linux-amd64.tar.gz dest=/root/soft/kubernetes-server-linux-amd64.tar.gz&quot;</span><br><br>ansible -i ./tmp_host all -m copy -a <span class="hljs-string">&quot;src=/opt/ljb/soft/AliSQL-master.zip dest=/usr/local/src/AliSQL-master.zip&quot;</span><br><br>ansible -i ./tmp_host all -m copy -a <span class="hljs-string">&quot;src=/opt/ljb/soft/jemalloc-4.0.4.tar.bz2 dest=/usr/local/src/jemalloc-4.0.4.tar.bz2&quot;</span><br><br>ansible -i ./tmp_host all -m copy -a <span class="hljs-string">&quot;src=/opt/ljb/soft/zlib-1.2.11.tar.gz dest=/usr/local/src/zlib-1.2.11.tar.gz&quot;</span><br><br>ansible -i ./tmp_host all -m copy -a <span class="hljs-string">&quot;src=/opt/ljb/elastic-job-lite-console.tar.gz dest=/opt/elastic-job-lite-console.tar.gz&quot;</span><br></code></pre></td></tr></table></figure><h2 id="include-å’Œ-import"><a href="#include-å’Œ-import" class="headerlink" title="include å’Œ import"></a>include å’Œ import</h2><p>include è¯­å¥å’Œ import è¯­å¥éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯ Ansible executor å¼•æ“å¯¹å¾…å®ƒä»¬çš„æ–¹å¼éå¸¸ä¸åŒã€‚</p><p>All import* statements are pre-processed at the time playbooks are parsed.</p><p>æ‰€æœ‰ import * è¯­å¥éƒ½æ˜¯åœ¨è§£æ playbook æ—¶é¢„å¤„ç†çš„ã€‚</p><p>All include* statements are processed as they are encountered during the execution of the playbook.</p><p>æ‰€æœ‰ include * è¯­å¥éƒ½åœ¨å‰§æœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°æ—¶è¿›è¡Œ</p><h2 id="role-è§’è‰²ä½¿ç”¨"><a href="#role-è§’è‰²ä½¿ç”¨" class="headerlink" title="role è§’è‰²ä½¿ç”¨"></a>role è§’è‰²ä½¿ç”¨</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">roles:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">common</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">webservers</span><br></code></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹ä¸»æœºçš„-ansible-facts-ä¿¡æ¯"><a href="#æŸ¥çœ‹ä¸»æœºçš„-ansible-facts-ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹ä¸»æœºçš„ ansible_facts ä¿¡æ¯"></a>æŸ¥çœ‹ä¸»æœºçš„ ansible_facts ä¿¡æ¯</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible -i host.ini 190.15.0.74 -m setup<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ansible</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ansible</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ansible-å˜é‡ä¼˜å…ˆçº§</title>
    <link href="/2023/03/11/ansible-%E5%8F%98%E9%87%8F%E4%BC%98%E5%85%88%E7%BA%A7/"/>
    <url>/2023/03/11/ansible-%E5%8F%98%E9%87%8F%E4%BC%98%E5%85%88%E7%BA%A7/</url>
    
    <content type="html"><![CDATA[<p>ansibleä¸­å˜é‡çš„ä¼˜å…ˆçº§</p><p>extra vars ï¼ˆ-e é€‰é¡¹æŒ‡å®šçš„å˜é‡ï¼‰æœ€é«˜<br>inventory ä¸»æœºæ¸…å•ä¸­å®šä¹‰çš„å˜é‡ï¼ˆansible_ssh_userç­‰)<br>playå‰§æœ¬ä¸­vars&#x2F;vars_fileså®šä¹‰çš„å˜é‡<br>ç³»ç»Ÿçš„factså˜é‡<br>è§’è‰²å®šä¹‰çš„é»˜è®¤å˜é‡ æœ€ä½<br>ä»ä¸Šåˆ°ä¸‹ä¼˜å…ˆçº§é€æ¸é™ä½ï¼Œé«˜ä¼˜å…ˆçº§ä¼šè¦†ç›–æ‰ä½ä¼˜å…ˆçº§çš„å˜é‡</p><p>å˜é‡çš„ä¼˜å…ˆçº§<br>å˜é‡çš„ä¼˜å…ˆçº§æŒ‡çš„æ˜¯ä¼˜å…ˆçº§è¶Šé«˜çš„ä¼šè¦†ç›–ä¼˜å…ˆçº§ä½çš„ï¼Œä¸‹è¾¹çš„ä¼˜å…ˆçº§ç”±ä½åˆ°é«˜è¿›è¡Œæ’åˆ—ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs text">role defaults<br>inventory vars<br>inventory group_vars<br>inventory host_vars<br>playbook group_vars<br>playbook host_vars<br>host facts<br>play vars<br>play vars_prompt<br>play vars_files<br>registered vars<br>set_facts<br>role and include vars<br>block vars (only for tasks in block)<br>task vars (only for the task)<br>extra vars (always win precedence)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ansible</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ansible</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
